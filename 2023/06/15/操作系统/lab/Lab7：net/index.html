<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Mit6.S081:lab net | Ember🍐</title><meta name="author" content="Ember🍐"><meta name="copyright" content="Ember🍐"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="MIT：lab4">
<meta property="og:type" content="article">
<meta property="og:title" content="Mit6.S081:lab net">
<meta property="og:url" content="http://www.ember-l.top/2023/06/15/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab7%EF%BC%9Anet/index.html">
<meta property="og:site_name" content="Ember🍐">
<meta property="og:description" content="MIT：lab4">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ember-img.oss-cn-chengdu.aliyuncs.com/img41.jpg">
<meta property="article:published_time" content="2023-06-14T16:00:00.000Z">
<meta property="article:modified_time" content="2023-08-03T13:40:58.858Z">
<meta property="article:author" content="Ember🍐">
<meta property="article:tag" content="操作系统">
<meta property="article:tag" content="xv6">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ember-img.oss-cn-chengdu.aliyuncs.com/img41.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.ember-l.top/2023/06/15/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab7%EF%BC%9Anet/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"FED6KV0748","apiKey":"eb9fdca95c3704e273ab6345266194b2","indexName":"dev_blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Ember🍐","link":"链接: ","source":"来源: Ember🍐","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Mit6.S081:lab net',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-08-03 21:40:58'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/font.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/wave.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/css/progress_bar.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/readPercent.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3864328_90xjkz8cfrn.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><span id="fps"></span><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/twikoo_beautify.css"  media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/tag.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/Swiper/8.0.6/swiper-bundle.min.css"><script data-pjax src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/Swiper/8.0.6/swiper-bundle.min.js"></script><link rel="stylesheet" href="/css/barrage.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css"><script type="text/javascript" src ="/js/reward.js" ></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="/css/precess_bar.css"/><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/assets/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-SmartHome"></use></svg><span> 首页</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shuji"></use></svg><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zongheshuju">                   </use></svg><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fabu-">                   </use></svg><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenlei">                   </use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:randomPost();"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenxiang">                   </use></svg><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-meishikafei"></use></svg><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-yinle">                   </use></svg><span> 音乐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Gallery/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fabu-">                   </use></svg><span> 照片</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/movies/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-dianying">                   </use></svg><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shijie"></use></svg><span> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-pengyouquan">                   </use></svg><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Gallery/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-liuyan">                   </use></svg><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie">                   </use></svg><span> 友人链</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-wangye"></use></svg><span> 小站</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon--tongjibiao">                   </use></svg><span> 网站统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/article/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon--tongjibiao">                   </use></svg><span> 文章统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span> 生涯</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-food-doughnut"></use></svg><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://ember-img.oss-cn-chengdu.aliyuncs.com/img41.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Ember🍐</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-SmartHome"></use></svg><span> 首页</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shuji"></use></svg><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zongheshuju">                   </use></svg><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fabu-">                   </use></svg><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenlei">                   </use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:randomPost();"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenxiang">                   </use></svg><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-meishikafei"></use></svg><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-yinle">                   </use></svg><span> 音乐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Gallery/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fabu-">                   </use></svg><span> 照片</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/movies/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-dianying">                   </use></svg><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shijie"></use></svg><span> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-pengyouquan">                   </use></svg><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Gallery/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-liuyan">                   </use></svg><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie">                   </use></svg><span> 友人链</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-wangye"></use></svg><span> 小站</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon--tongjibiao">                   </use></svg><span> 网站统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/article/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon--tongjibiao">                   </use></svg><span> 文章统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span> 生涯</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-food-doughnut"></use></svg><span> 关于</span></a></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="检索站内任何你想要的信息"><svg class="faa-tada icon" style="height:25px;width:25px;fill:currentColor;position:relative;top:2px;right:8px;" aria-hidden="true"><use xlink:href="#icon-sousuo"></use></svg><span> 搜索</span></a></div><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="浅色和深色模式转换" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:5px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">   </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">Mit6.S081:lab net</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-06-14T16:00:00.000Z" title="发表于 2023-06-15 00:00:00">2023-06-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-08-03T13:40:58.858Z" title="更新于 2023-08-03 21:40:58">2023-08-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7041</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>27分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title="Mit6.S081:lab net"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2023/06/15/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab7%EF%BC%9Anet/#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>实验：<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2022/labs/net.html">Lab: networking</a></p>
</blockquote>
<p>实验开始之前需要将git分支切换到net分支不然有些文件你是没有的</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git fetch</span><br><span class="line">$ git checkout net</span><br><span class="line">$ make clean</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>写在前面</strong>：本节内容分为实验部分与源码部分，内容可能会有多。如果想要多了解一下源码的读者可以观察源码分析部分。</p>
</blockquote>
<h1 id="networking-hard"><a href="#networking-hard" class="headerlink" title="networking(hard)"></a>networking(hard)</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote>
<p>qemu模拟设备硬件</p>
</blockquote>
<p>本次实验是通过使用qemu在risc-v主板上模拟一个网卡设备称为<strong>E1000</strong>。这个网卡设备可以连接到真实的局域网中(LAN)。但是在实验中，局域网与网卡设备都是通过qemu模拟出来的。xv6(客户端)的IP地址是<code>10.0.2.15</code>，连接到IP地址为<code>10.0.2.2</code>的局域网上。当xv6使用E1000向<code>10.0.2.2</code>发送数据包时，qemu会将包发送给局域网中目的主机(服务端)中。</p>
<p>要了解e1000网卡的相关内容，可以根据实验中给出的<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2022/readings/8254x_GBe_SDM.pdf">硬件手册</a>的相应章节进行阅读。</p>
<blockquote>
<p>网络协议栈</p>
</blockquote>
<p>在该实验中提供了较为简单的网络协议栈的代码实现，在后续的源码分析中会又所介绍。陈列一下相关的文件：</p>
<ul>
<li><code>sysnet.c</code>：定义了套接字结构，实现了操作套接字链表的方法</li>
<li><code>net.c/net.h</code>：定义了mbuf(packet buffer management)结构体与网络协议栈，并实现了网络包的发送与接受的相应操作方法。</li>
<li><code>e1000.c/e1000.h</code>：定义了e1000网卡的寄存器与e1000的DMA缓冲，实现了网卡驱动对网络包的发送与接受的方法。</li>
</ul>
<blockquote>
<p><strong>DMA</strong>：Direct Memory Access</p>
</blockquote>
<p>DMA是一种计算机数据传输技术，能够在不干扰CPU的情况下，将数据从存储器（通常是RAM）传输到另一个设备的内存（例如硬盘驱动器或网络适配器）。那么在该实验中时如何实现DMA的呢？</p>
<ol>
<li>E1000接受<strong>链路层</strong>传输过来的数据，硬件内部有building blocks，解析后放入内部缓冲队列，然后以DMA的方式与CPU通信。</li>
</ol>
<ul>
<li><p>网卡内部的缓冲队列，发送和接受都有，分别是TX和RX。DMA机制作用如下：在接收时，DMA引擎将队列中的数据拷贝到内存(RAM)，然后中断通知CPU，而不是显式让CPU负责这一块的工作。</p>
</li>
<li><p>在DMA机制前主流是<strong>PIO</strong>的方式，分为port-mapped IO &amp;&amp; memory-mapped IO,都是通过CPU指令对设备寄存器进行读写。在CPU和外部设备<strong>速度差异变得非常大</strong>时，这样效率就变得很低。</p>
</li>
</ul>
<p>DMA机制是靠网卡设备的DMA Engine实现的，操作系统只起到配合的作用，例如在内存中划分一块DMA缓冲区用于读写。</p>
<p><img src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img2.4.png" alt="img2.4"></p>
<p>上文引用自<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/368851473">《MIT6.S081》 Lab net - 知乎 (zhihu.com)</a></p>
<p>在实验中就是将RX与TX这两个缓冲队列的地址字段链接到内存：</p>
<ul>
<li><strong>发送</strong>：将要发送的包(mbuf)的内存地址值，填写到TX的addr字段，DMA会将该包的运输到e1000网卡进行发送。</li>
<li><strong>接收</strong>：当e1000接收到包的时候，DMA会将包运输到内存，RX的addr字段会记录包的内存地址值。注意：在<code>e1000_init</code>时，xv6已经分配了缓冲包的内存区域并与RX链接起来了。</li>
</ul>
<p>以上便是DMA的机制内容。</p>
<blockquote>
<p>实验要求</p>
</blockquote>
<p>完成两个函数<code>e1000_transmit()</code>和<code>e1000_recv()</code>，之后e1000便可以接受和发送网络包了，使用<code>make grade</code>命令进行测试。</p>
<blockquote>
<p><strong>HINS</strong>：</p>
</blockquote>
<p>跟着实验文档中的HINS部分完成对应的流程，一步步的编写代码差不多就可以完成实验，而且本次实验不需要使用gdb来调试。</p>
<p>在运行测试点时，需要先在另一个终端中运行<code>make server</code>。</p>
<p>特别的是，在e1000_trasmit()中要使用mbuf的指针，发送完包后就需要清空包的数据了。在e1000_recv()中需要使用<strong>循环结构</strong>，一次性读取所有的包。这样可以提高速率，不然会产生多个中断，驱动程序也会出现相应的问题，也就是又遗留的包未被处理。</p>
<h2 id="实现："><a href="#实现：" class="headerlink" title="实现："></a>实现：</h2><blockquote>
<p>发送网络包：e1000_trasmit</p>
</blockquote>
<p>发送包的环节主要使用了E1000_TDT(记录TX ring的尾索引)、E1000_TDBAL(记录TX ring的基址)这两个寄存器。</p>
<p>首先，在TX ring初始化时，将TDH(head) = TDT(tail) = 0。xv6要发送一个包就要使<code>TDT+1</code>，e1000就需要将<code>TDH+1</code>就可以发送包了。那么对于DMA引擎的创建的缓冲区来说，xv6是生产者(producer)进行<code>TDT++</code>，e1000是消费者(consumer)进行<code>TDH++</code>。</p>
<p>通过HINS内容一步步实现代码即可：</p>
<ol>
<li>加锁，防止多个CPU竞争资源；</li>
<li>读取TDT寄存器获得下一个TX ring的索引，判断status字段的<code>E1000_TXD_STAT_DD</code>位是否可以发送下一个包，不可以则退出函数；</li>
<li>可以发送下一个包的话，需要清除该缓冲区的数据清空；</li>
<li>将要发送的包的数据填入TX ring；</li>
<li>使用指针记录当前包的缓冲包的内存地址值，方便步骤3删除包数据；</li>
<li>更新TDT寄存器，更新之后便能e1000便会自动发送网络包。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">e1000_transmit</span><span class="params">(<span class="keyword">struct</span> mbuf *m)</span></span><br><span class="line">&#123;</span><br><span class="line">  acquire(&amp;e1000_lock);</span><br><span class="line">  uint32 idx = regs[E1000_TDT];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (!(tx_ring[idx].status &amp; E1000_TXD_STAT_DD))&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;buffer overflow&quot;</span>);</span><br><span class="line">    release(&amp;e1000_lock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(tx_mbufs[idx] != <span class="number">0</span>)&#123;</span><br><span class="line">    mbuffree(tx_mbufs[idx]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tx_ring[idx].addr = (uint64)m-&gt;head;</span><br><span class="line">  tx_ring[idx].length = (uint16)m-&gt;len;</span><br><span class="line">  tx_ring[idx].cmd = E1000_TXD_CMD_EOP | E1000_TXD_CMD_RS;</span><br><span class="line"></span><br><span class="line">  tx_mbufs[idx] = m;</span><br><span class="line">  <span class="comment">//增加缓冲队列字段，网卡发送包</span></span><br><span class="line">  regs[E1000_TDT] = (idx+<span class="number">1</span>)%TX_RING_SIZE;</span><br><span class="line"></span><br><span class="line">  release(&amp;e1000_lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写完代码后，在一个终端T1中运行<code>make server</code>，就会开启python所写的一个简单的服务器。然后在另一个终端T2运行make qemu，开启xv6后运行<code>nettests</code>命令，这时候在T1就会显示<code>a message from xv6</code>的消息，说明xv6发送包成功。</p>
<blockquote>
<p>接收网络包：e1000_recv</p>
</blockquote>
<p>接收包的环节主要使用了E1000_RDT(记录RX ring的尾索引)、E1000_RDBAL(记录RX ring的基址)这两个寄存器。</p>
<p>首先，在RX ring初始化时，将RDH(head) = 0，RDT(tail) =  <code>RX_RING_SIZE</code>-1。接收一个包后，e1000将当前RDH作为这个包的索引并且使<code>RDH+1</code>，那么xv6要取出这个包就需要将<code>RDT+1</code>，当RDH = RDT时说明队列已满，而且这个节点是无法使用的，所以这个队列实际上只能接收15个包。</p>
<ol>
<li>加锁，防止并发操作DMA的缓冲区；</li>
<li>得到RT ring的尾索引，并将其+1后模<code>RX_RING_SIZE</code>的值保存为<strong>idx</strong>；</li>
<li>通过循环判断，指定索引的RX ring队列的节点的status字段的<code>E1000_RXD_STAT_DD</code>位是否标记。如果标记说明该节点是可读的，则可以进入循环读取数据；</li>
<li>新分配一个mbuf，拷贝DMA缓冲区的内容，也就是拷贝RX ring的addr地址字段指向的内存，实际上不使用深拷贝也没啥问题，但是在<code>net_rx</code>函数内会释放缓冲区的内存，可能会造成问题；</li>
<li>在调用<code>net_rx</code>前释放锁，避免死锁。<code>net_rx</code>会解析接收网络的包并将数据填入套接字节点的mbufq队列中；</li>
<li>更新RDT寄存器，说明xv6已经读取完毕。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">e1000_recv</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  uint32 idx = (regs[E1000_RDT]+<span class="number">1</span>)%RX_RING_SIZE;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span>(rx_ring[idx].status&amp;E1000_RXD_STAT_DD)&#123;</span><br><span class="line">  </span><br><span class="line">    acquire(&amp;e1000_lock);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mbuf</span> *<span class="title">m</span>;</span></span><br><span class="line">    m = mbufalloc(<span class="number">0</span>);</span><br><span class="line">    m-&gt;len = rx_ring[idx].length;</span><br><span class="line">    memmove(m-&gt;head,(<span class="type">char</span>*)rx_ring[idx].addr,m-&gt;len);</span><br><span class="line"></span><br><span class="line">    rx_ring[idx].status = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    release(&amp;e1000_lock);</span><br><span class="line">    net_rx(m);</span><br><span class="line"></span><br><span class="line">    regs[E1000_RDT] = idx;</span><br><span class="line">    idx = (regs[E1000_RDT]+<span class="number">1</span>)%RX_RING_SIZE;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="中断执行流程：接受网络包"><a href="#中断执行流程：接受网络包" class="headerlink" title="中断执行流程：接受网络包"></a>中断执行流程：接受网络包</h2><p>在chapter5中，以top与bottom两个部分分析了驱动的组成，由于发送网络包没有中断的产生(因为DMA存在)，所有我们以接收包的流程讲解一下驱动组成。如下图所示</p>
<blockquote>
<p>TOP部分</p>
</blockquote>
<ul>
<li>在nettest.c代码中使用<code>connet</code>系统调用获取套接字描述符后，调用了read系统调用，等待从套接字链表中读取数据。</li>
<li>进入内核，通过判断文件描述符类型，调用<code>sockread</code>，因为该sock节点的mbufq队列为空，所以调用<code>sleep</code>函数休眠该进程(shell)。</li>
<li>该进程被唤醒后，执行mbufq_pophead()函数从sock节点中读取包的数据。并通过copyout函数将数据内容写回到用户空间。</li>
</ul>
<p><img src="https://ember-img.oss-cn-chengdu.aliyuncs.com/dervier_recv.png" alt="dervier_recv"></p>
<blockquote>
<p>BOTTOM部分</p>
</blockquote>
<ul>
<li>当E1000网卡接收到网络包后，产生中断调用interrupt handler(<code>e1000_intr</code>)，其调用了<code>e1000_recv</code>函数.</li>
<li>在<code>e1000_recv</code>函数中，从DMA引擎的mbuf(<code>e1000_init</code>中初始化该部分内存)中读取到对应网络包。</li>
<li>通过<code>net_rx、sockrecvudp</code>函数，解析网络包，并将网络包的数据添加到sock节点的mbufq队列的尾部。</li>
<li>唤醒TOP部分的休眠进程。</li>
</ul>
<p>通过TOP与BOTTOM两个部分便可以将驱动代码解耦开来了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本次实验原则上想通过实验是比较简单的(HINS部分都说明白了)，但是这次实验的量级十分的大，包含了网络协议栈、网络硬件驱动设计、DMA等等内容，要想理清整个实验的设计源码，对于自己来说挑战还是十分大的。</p>
<p>主要的难点就是DMA的缓冲设计、intel硬件手册的阅读(全英文，内容晦涩难懂)、网络协议设计。</p>
<p>写完本次实验，实际上对网络硬件的代码也没啥深入的了解，还是需要对其余源码有一些了解。要有更好的提升，还是得对实验中网络文件有一个大致的了解，如果学有余力可以看看下述的源码分析。</p>
<p><img src="https://ember-img.oss-cn-chengdu.aliyuncs.com/net_result.png" alt="net_result"></p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><h2 id="中断设置"><a href="#中断设置" class="headerlink" title="中断设置"></a>中断设置</h2><p>以kernel/main.c文件中的函数调用顺序介绍pci与e1000的初始化设置。</p>
<blockquote>
<p>memory map I/O</p>
</blockquote>
<p>e1000在RISC-V主板上的位置，和左上角的Rj45的Ethernet一样。CPU对其进行读写数据与读取内存(RAM)是一样的使用的是<code>memory map I/O</code>，对指定的地址段对设备的寄存器进行读写，便能实现对硬件设备的控制。<img src="https://ember-img.oss-cn-chengdu.aliyuncs.com/Sifive.png" alt="Sifive"></p>
<p>下述虚拟内存代码中，内核映射建立时可以发现新增了两个地址映射PCI-E ECAM总线与e1000的网卡设备，分别映射在0x30000000L与0x40000000L地址上。可以回顾页表章节就会就可以知晓这些地址段是xv6内核地址中预留的地址段。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">----vm.c</span><br><span class="line"><span class="comment">// Make a direct-map page table for the kernel.</span></span><br><span class="line"><span class="type">pagetable_t</span></span><br><span class="line"><span class="title function_">kvmmake</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">....</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LAB_NET</span></span><br><span class="line">  <span class="comment">// PCI-E ECAM (configuration space), for pci.c</span></span><br><span class="line">  kvmmap(kpgtbl, <span class="number">0x30000000</span>L, <span class="number">0x30000000</span>L, <span class="number">0x10000000</span>, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// pci.c maps the e1000&#x27;s registers here.</span></span><br><span class="line">  kvmmap(kpgtbl, <span class="number">0x40000000</span>L, <span class="number">0x40000000</span>L, <span class="number">0x20000</span>, PTE_R | PTE_W);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>PLIC传递e1000网卡中断</p>
</blockquote>
<p><strong>NOTE</strong>：plicinit代码中的设置是有误的，<code>for(int irq = 1; irq &lt; 0x35; irq++)</code>在注释中说明了PCIE设备的IRQs的范围在<code>32-35</code>之间，但是源码中是<code>1-0x35</code>显然是有问题的，在修改位32-35后仍然是正确的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">----plic.c</span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">plicinit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">....</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LAB_NET</span></span><br><span class="line">  <span class="comment">// PCIE IRQs are 32 to 35</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> irq = <span class="number">32</span>; irq &lt; <span class="number">35</span>; irq++)&#123;</span><br><span class="line">    *(uint32*)(PLIC + irq*<span class="number">4</span>) = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每个CPU核调用该函数，让中断能够被S-mode感知并处理。Q：为什么要先加4以及后面赋值<code>0xffffffff</code>，A：加4代表在上述地址的基础上后移4字节也是32位，<code>0xffffffff</code>刚好对于pci总线上的32个设备，一个设备对应一个位。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">----plic.c</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PLIC_SENABLE(hart) (PLIC + 0x2080 + (hart)*0x100)</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">plicinithart</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> hart = cpuid();</span><br><span class="line"></span><br><span class="line">  *(uint32*)PLIC_SENABLE(hart) = (<span class="number">1</span> &lt;&lt; UART0_IRQ) | (<span class="number">1</span> &lt;&lt; VIRTIO0_IRQ);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LAB_NET</span></span><br><span class="line">   <span class="comment">// hack to get at next 32 IRQs for e1000</span></span><br><span class="line">  *(uint32*)(PLIC_SENABLE(hart)+<span class="number">4</span>) = <span class="number">0xffffffff</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>设置pci总线上的e1000设备</p>
</blockquote>
<p>pci设置实际上不是很复杂，主要就是识别e1000网卡的设备id，并配置pci中e1000的地址，让pci总线能够传输e1000的数据。之后便调用e1000_init初始化e1000网卡。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">----pci.c</span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">pci_init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//e1000的物理地址</span></span><br><span class="line">  uint64 e1000_regs = <span class="number">0x40000000</span>L;</span><br><span class="line">  <span class="comment">//pci总线的物理地址</span></span><br><span class="line">  uint32  *ecam = (uint32 *) <span class="number">0x30000000</span>L;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//PCI有32个设备接口，找到e1000设备接口，并进行配置</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> dev = <span class="number">0</span>; dev &lt; <span class="number">32</span>; dev++)&#123;</span><br><span class="line">	<span class="type">int</span> bus = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> func = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> offset = <span class="number">0</span>;</span><br><span class="line">    uint32 off = (bus &lt;&lt; <span class="number">16</span>) | (dev &lt;&lt; <span class="number">11</span>) | (func &lt;&lt; <span class="number">8</span>) | (offset);</span><br><span class="line">    <span class="keyword">volatile</span> uint32 *base = ecam + off;</span><br><span class="line">    uint32 id = base[<span class="number">0</span>];<span class="comment">//设备id</span></span><br><span class="line">    <span class="comment">// 100e:8086 is an e1000</span></span><br><span class="line">    <span class="keyword">if</span>(id == <span class="number">0x100e8086</span>)&#123;</span><br><span class="line">      <span class="comment">// base[1]=7代表允许IO访问、内存访问、开启控制</span></span><br><span class="line">      base[<span class="number">1</span>] = <span class="number">7</span>;</span><br><span class="line">      __sync_synchronize();</span><br><span class="line"></span><br><span class="line">	  ....</span><br><span class="line">      <span class="comment">// tell the e1000 to reveal its registers at</span></span><br><span class="line">      <span class="comment">// physical address 0x40000000.</span></span><br><span class="line">      base[<span class="number">4</span>+<span class="number">0</span>] = e1000_regs;</span><br><span class="line"></span><br><span class="line">      e1000_init((uint32*)e1000_regs);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>__sync_synchronize()</code> 是一种同步原语，用于确保在多线程环境中对共享变量的访问是原子的和有序的。它可以用来防止编译器和处理器对指令进行<strong>重排</strong>，从而保证代码的正确性。这个函数没有参数，它只是一个内存屏障，用于强制处理器刷新所有存储器和缓存，以确保所有先前的存储操作已经完成(在《锁》章节会继续讲解)。</p>
<blockquote>
<p>初始化e1000设备</p>
</blockquote>
<p>对e1000网卡进行初始化主要是一下步骤，对于一些控制寄存器，要想深入了解可以继续观看intel硬件手册。</p>
<ol>
<li><strong>重置控制寄存器</strong></li>
<li><strong>配置传输寄存器</strong>：将TX ring队列的每一个节点都设置<code>E1000_TXD_STAT_DD</code>位，让其可以传输包；将TX ring的地址写入TDBAL寄存器，这一步就是将e1000寄存器编写使用C语言代替，可以方便的使用C语言编写传输包的控制；配置TDLEN、TDH、TDT寄存器，分别代表了e1000设备中TX ring队列长度、头索引、尾索引。</li>
<li><strong>配置接收寄存器</strong>：创建DMA引擎的内存缓冲区mbuf，将RX ring节点的<code>addr</code>字段指向内存区域，这样当包到达e1000后便能够传输到内存区域；将RX ring的地址写入RDBAL寄存器，作用与传输部分一样；配置RDLEN、RDH、RDT寄存器，分别代表了e1000设备中RX ring队列长度、头索引、尾索引。</li>
<li><strong>配置MAC地址</strong>：将e1000的MAC地址写入RA寄存器。</li>
<li>设置多播表，在本实验中并未设置。</li>
<li>设置传输、接收控制寄存器的相应的位。</li>
<li><strong>中断设置</strong>，当e1000接收到网络包后，便能够产生中断。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">----e1000.c</span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">e1000_init</span><span class="params">(uint32 *xregs)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">  initlock(&amp;e1000_lock, <span class="string">&quot;e1000&quot;</span>);</span><br><span class="line"></span><br><span class="line">  regs = xregs;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reset the device</span></span><br><span class="line">  regs[E1000_IMS] = <span class="number">0</span>; <span class="comment">// disable interrupts</span></span><br><span class="line">  regs[E1000_CTL] |= E1000_CTL_RST;</span><br><span class="line">  regs[E1000_IMS] = <span class="number">0</span>; <span class="comment">// redisable interrupts</span></span><br><span class="line">  __sync_synchronize();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(tx_ring, <span class="number">0</span>, <span class="keyword">sizeof</span>(tx_ring));</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; TX_RING_SIZE; i++) &#123;</span><br><span class="line">    tx_ring[i].status = E1000_TXD_STAT_DD;</span><br><span class="line">    tx_mbufs[i] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  regs[E1000_TDBAL] = (uint64) tx_ring;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">sizeof</span>(tx_ring) % <span class="number">128</span> != <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;e1000&quot;</span>);</span><br><span class="line">  regs[E1000_TDLEN] = <span class="keyword">sizeof</span>(tx_ring);</span><br><span class="line">  regs[E1000_TDH] = regs[E1000_TDT] = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">memset</span>(rx_ring, <span class="number">0</span>, <span class="keyword">sizeof</span>(rx_ring));</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; RX_RING_SIZE; i++) &#123;</span><br><span class="line">    rx_mbufs[i] = mbufalloc(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!rx_mbufs[i])</span><br><span class="line">      panic(<span class="string">&quot;e1000&quot;</span>);</span><br><span class="line">    rx_ring[i].addr = (uint64) rx_mbufs[i]-&gt;head;</span><br><span class="line">  &#125;</span><br><span class="line">  regs[E1000_RDBAL] = (uint64) rx_ring;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">sizeof</span>(rx_ring) % <span class="number">128</span> != <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;e1000&quot;</span>);</span><br><span class="line">  regs[E1000_RDH] = <span class="number">0</span>;</span><br><span class="line">  regs[E1000_RDT] = RX_RING_SIZE - <span class="number">1</span>;</span><br><span class="line">  regs[E1000_RDLEN] = <span class="keyword">sizeof</span>(rx_ring);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// filter by qemu&#x27;s MAC address, 52:54:00:12:34:56</span></span><br><span class="line">  regs[E1000_RA] = <span class="number">0x12005452</span>;</span><br><span class="line">  regs[E1000_RA+<span class="number">1</span>] = <span class="number">0x5634</span> | (<span class="number">1</span>&lt;&lt;<span class="number">31</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// multicast table</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4096</span>/<span class="number">32</span>; i++)</span><br><span class="line">    regs[E1000_MTA + i] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// transmitter control bits.</span></span><br><span class="line">  regs[E1000_TCTL] = E1000_TCTL_EN |  <span class="comment">// enable</span></span><br><span class="line">    E1000_TCTL_PSP |                  <span class="comment">// pad short packets</span></span><br><span class="line">    (<span class="number">0x10</span> &lt;&lt; E1000_TCTL_CT_SHIFT) |   <span class="comment">// collision stuff</span></span><br><span class="line">    (<span class="number">0x40</span> &lt;&lt; E1000_TCTL_COLD_SHIFT);</span><br><span class="line">  regs[E1000_TIPG] = <span class="number">10</span> | (<span class="number">8</span>&lt;&lt;<span class="number">10</span>) | (<span class="number">6</span>&lt;&lt;<span class="number">20</span>); <span class="comment">// inter-pkt gap</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// receiver control bits.</span></span><br><span class="line">  regs[E1000_RCTL] = E1000_RCTL_EN | <span class="comment">// enable receiver</span></span><br><span class="line">    E1000_RCTL_BAM |                 <span class="comment">// enable broadcast</span></span><br><span class="line">    E1000_RCTL_SZ_2048 |             <span class="comment">// 2048-byte rx buffers</span></span><br><span class="line">    E1000_RCTL_SECRC;                <span class="comment">// strip CRC</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ask e1000 for receive interrupts.</span></span><br><span class="line">  regs[E1000_RDTR] = <span class="number">0</span>; <span class="comment">// interrupt after every received packet (no timer)</span></span><br><span class="line">  regs[E1000_RADV] = <span class="number">0</span>; <span class="comment">// interrupt after every packet (no timer)</span></span><br><span class="line">  regs[E1000_IMS] = (<span class="number">1</span> &lt;&lt; <span class="number">7</span>); <span class="comment">// RXDW -- Receiver Descriptor Write Back</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="DMA缓冲区"><a href="#DMA缓冲区" class="headerlink" title="DMA缓冲区"></a>DMA缓冲区</h2><p>DMA = 通过DMA引擎，网卡可以直接读取的RAM地址，而不需要内核作为中间商去调配数据的转移。那么在xv6中就设计一种缓冲结构体，这个结构体用于存放网络包字节序列。</p>
<blockquote>
<p>mbuf结构体</p>
</blockquote>
<p>这个结构体十分的简单，mbuf实际上是一个链表。主要介绍的是<code>char *head</code>字段，这个字段永远指向的都是网络包的头部，如下图所示。</p>
<p><img src="https://ember-img.oss-cn-chengdu.aliyuncs.com/image-20230615215318420.png" alt="image-20230615215318420"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mbuf</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mbuf</span>  *<span class="title">next</span>;</span> <span class="comment">// the next mbuf in the chain</span></span><br><span class="line">  <span class="type">char</span>         *head; <span class="comment">// the current start position of the buffer</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> len;   <span class="comment">// the length of the buffer</span></span><br><span class="line">  <span class="type">char</span>         buf[MBUF_SIZE]; <span class="comment">// the backing store</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>mbuf变式(队列)以及相关函数方法</p>
</blockquote>
<ul>
<li>在实验中sock保存便是这个mbufq队列，用于读取mbuf实体的数据，在前文知道了mbuf是一个链表，那么这个mbufq的head、tail则是用于指向mbuf实体的头节点与尾节点。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">----net.h</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mbufq</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mbuf</span> *<span class="title">head</span>;</span>  <span class="comment">// the first element in the queue</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mbuf</span> *<span class="title">tail</span>;</span>  <span class="comment">// the last element in the queue</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>下述宏定义值得注意的是——<code>typeof</code>关键字，是GUN C提供的一种特性。类似于C++的decltype关键字，在此处主要是用于推断函数值的返回类型与判断结构类型。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">----net.h</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mbufpullhdr(mbuf, hdr) (typeof(hdr)*)mbufpull(mbuf, sizeof(hdr))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mbufpushhdr(mbuf, hdr) (typeof(hdr)*)mbufpush(mbuf, sizeof(hdr))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mbufputhdr(mbuf, hdr) (typeof(hdr)*)mbufput(mbuf, sizeof(hdr))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mbuftrimhdr(mbuf, hdr) (typeof(hdr)*)mbuftrim(mbuf, sizeof(hdr))</span></span><br></pre></td></tr></table></figure>
<p>在发送包阶段会给数据添加各种协议头部，由于每个协议头部的结构体不同，使用该方法便能够将m-&gt;head强转为对应结构体类型，之后方便的设置协议的字段了。</p>
<ul>
<li>下述是一些mbuf通用的操作函数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> mbuf *<span class="title function_">mbufalloc</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> headroom)</span>;<span class="comment">//分配一个空的mbuf</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mbuffree</span><span class="params">(<span class="keyword">struct</span> mbuf *m)</span>;<span class="comment">//释放mbuf</span></span><br><span class="line"><span class="comment">//添加一个mbuf节点到mbuf队列的尾部</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mbufq_pushtail</span><span class="params">(<span class="keyword">struct</span> mbufq *q, <span class="keyword">struct</span> mbuf *m)</span>;</span><br><span class="line"><span class="comment">//取出mbuf队列的头部</span></span><br><span class="line"><span class="keyword">struct</span> mbuf *<span class="title function_">mbufq_pophead</span><span class="params">(<span class="keyword">struct</span> mbufq *q)</span>;</span><br><span class="line"><span class="comment">//判断mbuf队列是否为空</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mbufq_empty</span><span class="params">(<span class="keyword">struct</span> mbufq *q)</span>;</span><br><span class="line"><span class="comment">//初始化mbuf队列</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mbufq_init</span><span class="params">(<span class="keyword">struct</span> mbufq *q)</span>;</span><br></pre></td></tr></table></figure>
<h2 id="套接字"><a href="#套接字" class="headerlink" title="套接字"></a>套接字</h2><blockquote>
<p>套接字结构体：<strong>链表</strong></p>
</blockquote>
<p>套接字是传输层的概念，主要是用于服务端与客户端进程端对端的链接。在net实验中，实现的是sock链表用于记录套接字，套接字中包含mbufq字段包含可以读取的网络包的数据。</p>
<p>每一个套接字对应的是一个文件描述符，通过这个描述符用户空间便能够读取内存中对应sock链表的节点数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">----sysnet.c</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">next</span>;</span> <span class="comment">// the next socket in the list</span></span><br><span class="line">  uint32 raddr;      <span class="comment">// the remote IPv4 address</span></span><br><span class="line">  uint16 lport;      <span class="comment">// the local UDP port number</span></span><br><span class="line">  uint16 rport;      <span class="comment">// the remote UDP port number</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span> <span class="comment">// protects the rxq</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mbufq</span> <span class="title">rxq</span>;</span>  <span class="comment">// a queue of packets waiting to be received</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>套接字分配</p>
</blockquote>
<p>在nettest实验中会使用connect系统调用(kernelsysfile.c)用于创建套接字，那么在connect中会调用sockalloc用于创建链表节点。</p>
<p>在新sock节点记录客户端的端口号与服务端的端口号、IP地址，通过判断该节点是否存在于sock链表中，如果存在通过头插的方式将其加入到链表中，反之则清空套接字并退出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">----sysnet.c</span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">sockalloc</span><span class="params">(<span class="keyword">struct</span> file **f, uint32 raddr, uint16 lport, uint16 rport)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">si</span>, *<span class="title">pos</span>;</span></span><br><span class="line"></span><br><span class="line">  si = <span class="number">0</span>;</span><br><span class="line">  *f = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ((*f = filealloc()) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line">  <span class="keyword">if</span> ((si = (<span class="keyword">struct</span> sock*)kalloc()) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initialize objects</span></span><br><span class="line">  si-&gt;raddr = raddr;</span><br><span class="line">  si-&gt;lport = lport;</span><br><span class="line">  si-&gt;rport = rport;</span><br><span class="line">  initlock(&amp;si-&gt;lock, <span class="string">&quot;sock&quot;</span>);</span><br><span class="line">  mbufq_init(&amp;si-&gt;rxq);</span><br><span class="line">  (*f)-&gt;type = FD_SOCK;</span><br><span class="line">  (*f)-&gt;readable = <span class="number">1</span>;</span><br><span class="line">  (*f)-&gt;writable = <span class="number">1</span>;</span><br><span class="line">  (*f)-&gt;sock = si;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add to list of sockets</span></span><br><span class="line">  acquire(&amp;lock);</span><br><span class="line">  pos = sockets;</span><br><span class="line">  <span class="comment">//检测套接字是否重复</span></span><br><span class="line">  ....</span><br><span class="line">  <span class="comment">//头插</span></span><br><span class="line">  si-&gt;next = sockets;</span><br><span class="line">  sockets = si;</span><br><span class="line">  release(&amp;lock);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">bad:</span><br><span class="line">  <span class="keyword">if</span> (si)</span><br><span class="line">    kfree((<span class="type">char</span>*)si);</span><br><span class="line">  <span class="keyword">if</span> (*f)</span><br><span class="line">    fileclose(*f);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>写入套接字</p>
</blockquote>
<p>通过<code>connect</code>获取到套接字描述符fd后，套接字节点与套接字描述符是1对1的关系，使用write(fd,…)后通过识别文件类型便会调用<code>sockwrite</code>，在该函数中主要是创建一个mbuf临时缓冲区并且需要预留网络包的协议头部分。</p>
<p>使用<code>copyin</code>函数将用户空间的要发送的字符串拷贝到mbuf中，并使用<code>net_tx_udp</code>函数将udp的协议头加入到mbuf中，之后便是加入ip、arp、Ethernet协议头到mbuf中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">----sysnet.c</span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">sockwrite</span><span class="params">(<span class="keyword">struct</span> sock *si, uint64 addr, <span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">pr</span> =</span> myproc();</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mbuf</span> *<span class="title">m</span>;</span></span><br><span class="line"></span><br><span class="line">  m = mbufalloc(MBUF_DEFAULT_HEADROOM);</span><br><span class="line">  <span class="keyword">if</span> (!m)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (copyin(pr-&gt;pagetable, mbufput(m, n), addr, n) == <span class="number">-1</span>) &#123;</span><br><span class="line">    mbuffree(m);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  net_tx_udp(m, si-&gt;raddr, si-&gt;lport, si-&gt;rport);</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>读取套接字</p>
</blockquote>
<p>与write相似，通过read系统调用<code>sockread</code>函数读取对应的套接字链表。判断套接字的mbuf是否为空，为空则休眠该进程等待mbuf的输入。当该节点的mbuf被写入便会唤醒该节点，那么就可以读取接收的网络包的数据并使用<code>copyout</code>拷贝回用户空间。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">----sysnet.c</span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">sockread</span><span class="params">(<span class="keyword">struct</span> sock *si, uint64 addr, <span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">pr</span> =</span> myproc();</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mbuf</span> *<span class="title">m</span>;</span></span><br><span class="line">  <span class="type">int</span> len;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;si-&gt;lock);</span><br><span class="line">  <span class="keyword">while</span> (mbufq_empty(&amp;si-&gt;rxq) &amp;&amp; !pr-&gt;killed) &#123;</span><br><span class="line">    sleep(&amp;si-&gt;rxq, &amp;si-&gt;lock);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (pr-&gt;killed) &#123;</span><br><span class="line">    release(&amp;si-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  m = mbufq_pophead(&amp;si-&gt;rxq);</span><br><span class="line">  release(&amp;si-&gt;lock);</span><br><span class="line"></span><br><span class="line">  len = m-&gt;len;</span><br><span class="line">  <span class="keyword">if</span> (len &gt; n)</span><br><span class="line">    len = n;</span><br><span class="line">  <span class="keyword">if</span> (copyout(pr-&gt;pagetable, addr, m-&gt;head, len) == <span class="number">-1</span>) &#123;</span><br><span class="line">    mbuffree(m);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  mbuffree(m);</span><br><span class="line">  <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="网络协议"><a href="#网络协议" class="headerlink" title="网络协议"></a>网络协议</h2><p>网络协议包的加工就如下图所示，从上至下添加每一层的协议头。不同的是，在xv6的ping测试中没有使用应用层的协议，添加的是原生的字符序列。在传输层使用的是udp协议，在链路层添加arp协议头，在物理层添加了以太网Ethernet的协议头。</p>
<p><img src="https://ember-img.oss-cn-chengdu.aliyuncs.com/packet.png" alt="packet"></p>
<h3 id="地址信息"><a href="#地址信息" class="headerlink" title="地址信息"></a>地址信息</h3><p>在net.h中定义了qemu模拟的xv6主机的ip地址与mac地址。 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">----net.h</span><br><span class="line"><span class="type">static</span> uint32 local_ip = MAKE_IP_ADDR(<span class="number">10</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">15</span>); <span class="comment">// qemu&#x27;s idea of the guest IP</span></span><br><span class="line"><span class="type">static</span> uint8 local_mac[ETHADDR_LEN] = &#123; <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x56</span> &#125;;</span><br><span class="line"><span class="type">static</span> uint8 broadcast_mac[ETHADDR_LEN] = &#123; <span class="number">0xFF</span>, <span class="number">0XFF</span>, <span class="number">0XFF</span>, <span class="number">0XFF</span>, <span class="number">0XFF</span>, <span class="number">0XFF</span> &#125;;</span><br></pre></td></tr></table></figure>
<h3 id="物理层：Ethernet"><a href="#物理层：Ethernet" class="headerlink" title="物理层：Ethernet"></a>物理层：Ethernet</h3><blockquote>
<p>Ethernet结构体</p>
</blockquote>
<p>该结构体中简单地定义了Ethernet的协议字段，也就是本机mac地址、目的主机的mac地址，还有协议类型type，在本实验中只有ip与udp类型。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">----net.h</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ETHADDR_LEN 6</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">eth</span> &#123;</span></span><br><span class="line">  uint8  dhost[ETHADDR_LEN];</span><br><span class="line">  uint8  shost[ETHADDR_LEN];</span><br><span class="line">  uint16 type;</span><br><span class="line">&#125; __attribute__((packed));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ETHTYPE_IP  0x0800 <span class="comment">// Internet protocol</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ETHTYPE_ARP 0x0806 <span class="comment">// Address resolution protocol</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>发送Ethernet包</p>
</blockquote>
<p>发送Ethernet包也就是在ip或udp包添加eth头部并发送。发送时候，由于不知道目标主机的mac地址所以目标mac地址被设置为了<strong>广播mac地址</strong>。之后则是调用<code>e1000_tramit</code>代码是e1000网卡发送eth包。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">----net.h</span><br><span class="line"><span class="comment">// sends an ethernet packet</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">net_tx_eth</span><span class="params">(<span class="keyword">struct</span> mbuf *m, uint16 ethtype)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">eth</span> *<span class="title">ethhdr</span>;</span></span><br><span class="line"></span><br><span class="line">  ethhdr = mbufpushhdr(m, *ethhdr);</span><br><span class="line">  memmove(ethhdr-&gt;shost, local_mac, ETHADDR_LEN);</span><br><span class="line">  <span class="comment">// In a real networking stack, dhost would be set to the address discovered</span></span><br><span class="line">  <span class="comment">// through ARP. Because we don&#x27;t support enough of the ARP protocol, set it</span></span><br><span class="line">  <span class="comment">// to broadcast instead.</span></span><br><span class="line">  memmove(ethhdr-&gt;dhost, broadcast_mac, ETHADDR_LEN);</span><br><span class="line">  ethhdr-&gt;type = htons(ethtype);</span><br><span class="line">  <span class="keyword">if</span> (e1000_transmit(m)) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;free packet&quot;</span>);</span><br><span class="line">    mbuffree(m);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>接收Ethernet包</p>
</blockquote>
<p>解析Eth协议头，通过<code>mbupullhdr</code>函数取出eth协议头，判断Ethernet协议的类型并进一步的取出后一个的协议头部。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">----net.c</span><br><span class="line"><span class="type">void</span> <span class="title function_">net_rx</span><span class="params">(<span class="keyword">struct</span> mbuf *m)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">eth</span> *<span class="title">ethhdr</span>;</span></span><br><span class="line">  uint16 type;</span><br><span class="line"></span><br><span class="line">  ethhdr = mbufpullhdr(m, *ethhdr);</span><br><span class="line">  <span class="keyword">if</span> (!ethhdr) &#123;</span><br><span class="line">    mbuffree(m);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  type = ntohs(ethhdr-&gt;type);</span><br><span class="line">  <span class="keyword">if</span> (type == ETHTYPE_IP)</span><br><span class="line">    net_rx_ip(m);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (type == ETHTYPE_ARP)</span><br><span class="line">    net_rx_arp(m);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    mbuffree(m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="链路层：ARP"><a href="#链路层：ARP" class="headerlink" title="链路层：ARP"></a>链路层：ARP</h3><p>ARP虽然实验中有源码，但是在测试中并没有使用arp，因为这个实验是点对点的网络联通测试，所以没有涉及ARP的运用，感兴趣的化可以自行了解。</p>
<h3 id="网络层：IP"><a href="#网络层：IP" class="headerlink" title="网络层：IP"></a>网络层：IP</h3><blockquote>
<p>IP结构体</p>
</blockquote>
<p>在该结构体中定义了一些IP必要的字段，如检验和、包的生存期、本机ip与目的主机的ip等字段，相对来说比较简单，并没有实现IPv6。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">----net.h</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip</span> &#123;</span></span><br><span class="line">  uint8  ip_vhl; <span class="comment">// version &lt;&lt; 4 | header length &gt;&gt; 2</span></span><br><span class="line">  uint8  ip_tos; <span class="comment">// type of service</span></span><br><span class="line">  uint16 ip_len; <span class="comment">// total length</span></span><br><span class="line">  uint16 ip_id;  <span class="comment">// identification</span></span><br><span class="line">  uint16 ip_off; <span class="comment">// fragment offset field</span></span><br><span class="line">  uint8  ip_ttl; <span class="comment">// time to live</span></span><br><span class="line">  uint8  ip_p;   <span class="comment">// protocol</span></span><br><span class="line">  uint16 ip_sum; <span class="comment">// checksum</span></span><br><span class="line">  uint32 ip_src, ip_dst;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IPPROTO_ICMP 1  <span class="comment">// Control message protocol</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IPPROTO_TCP  6  <span class="comment">// Transmission control protocol</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IPPROTO_UDP  17 <span class="comment">// User datagram protocol</span></span></span><br></pre></td></tr></table></figure>
<p>添加ip协议头部与解析头部几乎与Ethernet操作一样，在接收ip包时，<code>net_rx_ip</code>函数会多一些检测如检验和的检测等。</p>
<h3 id="传输层：UDP"><a href="#传输层：UDP" class="headerlink" title="传输层：UDP"></a>传输层：UDP</h3><blockquote>
<p>结构体</p>
</blockquote>
<p>传输层协议有TCP与UDP，在本实验中也涉及不了TCP的设计，UDP的设计也相对比较简单。在挑战中会有TCP设计，感兴趣的话可以尝试一下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">----net.h</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">udp</span> &#123;</span></span><br><span class="line">  uint16 sport; <span class="comment">// source port</span></span><br><span class="line">  uint16 dport; <span class="comment">// destination port</span></span><br><span class="line">  uint16 ulen;  <span class="comment">// length, including udp header, not including IP header</span></span><br><span class="line">  uint16 sum;   <span class="comment">// checksum</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>与IP层相同，添加协议头部与解析协议头部的过程都相似，查看net.c源码是可以读懂的，这里就不赘述了。</p>
<h3 id="应用层：DNS"><a href="#应用层：DNS" class="headerlink" title="应用层：DNS"></a>应用层：DNS</h3><blockquote>
<p>DNS结构体</p>
</blockquote>
<p>看下述结构中有<code>uint8 rd: 1;</code> 这样的对象定义，<code>rd:1</code>是用于声明rd是一个<strong>位域</strong>变量，位域允许在内存中比较小的空间中表示一个小的整数。这对于网络协议结构非常有用，可以将小的标志位压缩到原本会被浪费的字节内存中。在这个例子中，rd 只需要占用一个bit，而不是完整的字节空间，因此可以节省内存并提高效率。</p>
<p><code>__attribute__((packed))</code>是GCC编译器的一个扩展属性(attribute)，它的作用是取消或减少结构体在编译过程中的对齐优化，使用这个属性主要是让<strong>位域</strong>不被对齐优化。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// an DNS packet (comes after an UDP header).</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dns</span> &#123;</span></span><br><span class="line">  uint16 id;  <span class="comment">// request ID</span></span><br><span class="line"></span><br><span class="line">  uint8 rd: <span class="number">1</span>;  <span class="comment">// recursion desired</span></span><br><span class="line">  uint8 tc: <span class="number">1</span>;  <span class="comment">// truncated</span></span><br><span class="line">  uint8 aa: <span class="number">1</span>;  <span class="comment">// authoritive</span></span><br><span class="line">  uint8 opcode: <span class="number">4</span>; </span><br><span class="line">  uint8 qr: <span class="number">1</span>;  <span class="comment">// query/response</span></span><br><span class="line">  uint8 rcode: <span class="number">4</span>; <span class="comment">// response code</span></span><br><span class="line">  uint8 cd: <span class="number">1</span>;  <span class="comment">// checking disabled</span></span><br><span class="line">  uint8 ad: <span class="number">1</span>;  <span class="comment">// authenticated data</span></span><br><span class="line">  uint8 z:  <span class="number">1</span>;  </span><br><span class="line">  uint8 ra: <span class="number">1</span>;  <span class="comment">// recursion available</span></span><br><span class="line">  </span><br><span class="line">  uint16 qdcount; <span class="comment">// number of question entries</span></span><br><span class="line">  uint16 ancount; <span class="comment">// number of resource records in answer section</span></span><br><span class="line">  uint16 nscount; <span class="comment">// number of NS resource records in authority section</span></span><br><span class="line">  uint16 arcount; <span class="comment">// number of resource records in additional records</span></span><br><span class="line">&#125; __attribute__((packed));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dns_question</span> &#123;</span></span><br><span class="line">  uint16 qtype;</span><br><span class="line">  uint16 qclass;</span><br><span class="line">&#125; __attribute__((packed));</span><br><span class="line">  </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARECORD (0x0001)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> QCLASS  (0x0001)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dns_data</span> &#123;</span></span><br><span class="line">  uint16 type;</span><br><span class="line">  uint16 <span class="class"><span class="keyword">class</span>;</span></span><br><span class="line">  uint32 ttl;</span><br><span class="line">  uint16 len;</span><br><span class="line">&#125; __attribute__((packed));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>对于一些字段的使用可以观察<code>nettests.c</code>的代码会生成dns请求和解析dns请求。</p>
<blockquote>
<p>制作DNS请求</p>
</blockquote>
<p>传入一个<code>uint8* obuf</code>到函数中，这个地址的数据是DNS请求会在后续的write调用中替代字节序列数据。简短的介绍一下制作DNS请求的步骤：</p>
<ol>
<li><strong>制作DNS头部</strong>：将obuf的地址强转为dns结构体对象的基址</li>
<li>请求的id值保存到dns对象的字段中，rd赋值为1说明需要递归解析出域名地址，qdcount赋值为1说明只有一个请求。<code>htons</code>函数方法将本机字节转换为网络字节顺序，Risc-V使用小端序，而网络顺序是大端序。</li>
<li>接着是将dns结构体后续的地址强转为需要<strong>解析的域名字符串</strong>(“pdos.csail.mit.edu.”)的地址，这就是dns要传输的数据部分。</li>
<li><strong>制作DNS尾部</strong>：将数据部分后续地址强转为dns_question结构体地址。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Make a DNS request</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">dns_req</span><span class="params">(uint8 *obuf)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dns</span> *<span class="title">hdr</span> =</span> (<span class="keyword">struct</span> dns *) obuf;</span><br><span class="line">  hdr-&gt;id = htons(<span class="number">6828</span>);</span><br><span class="line">  hdr-&gt;rd = <span class="number">1</span>;</span><br><span class="line">  hdr-&gt;qdcount = htons(<span class="number">1</span>);</span><br><span class="line">  </span><br><span class="line">  len += <span class="keyword">sizeof</span>(<span class="keyword">struct</span> dns);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// qname part of question</span></span><br><span class="line">  <span class="type">char</span> *qname = (<span class="type">char</span> *) (obuf + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> dns));</span><br><span class="line">  <span class="type">char</span> *s = <span class="string">&quot;pdos.csail.mit.edu.&quot;</span>;</span><br><span class="line">  encode_qname(qname, s);</span><br><span class="line">  len += <span class="built_in">strlen</span>(qname) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// constants part of question</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dns_question</span> *<span class="title">h</span> =</span> (<span class="keyword">struct</span> dns_question *) (qname+<span class="built_in">strlen</span>(qname)+<span class="number">1</span>);</span><br><span class="line">  h-&gt;qtype = htons(<span class="number">0x1</span>);</span><br><span class="line">  h-&gt;qclass = htons(<span class="number">0x1</span>);</span><br><span class="line"></span><br><span class="line">  len += <span class="keyword">sizeof</span>(<span class="keyword">struct</span> dns_question);</span><br><span class="line">  <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上是DNS包的制作，与ping不同的是将字节数据部分替换为DNS头部+数据部分，实际上就是是数据形式变得更加规范。那么这样来说在服务端接收到包之后对其进行对于的解析，可以得到域名的数据。</p>
<p>到此本文就结束了，对于DNS解析部分可以观察对于的代码相对于制作dns请求来说是比较复杂的，但实际上也不难。</p>
<h1 id="挑战"><a href="#挑战" class="headerlink" title="挑战"></a>挑战</h1><ul>
<li>[ ] In this lab, the networking stack uses interrupts to handle ingress packet processing, but not egress packet processing. A more sophisticated strategy would be to queue egress packets in software and only provide a limited number to the NIC at any one time. You can then rely on TX interrupts to refill the transmit ring. Using this technique, it becomes possible to prioritize different types of egress traffic. (<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2022/labs/guidance.html">easy</a>)</li>
<li>[ ] The provided networking code only partially supports ARP. Implement a full <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc826">ARP cache</a> and wire it in to <code>net_tx_eth()</code>. (<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2022/labs/guidance.html">moderate</a>)</li>
<li>[ ] The E1000 supports multiple RX and TX rings. Configure the E1000 to provide a ring pair for each core and modify your networking stack to support multiple rings. Doing so has the potential to increase the throughput that your networking stack can support as well as reduce lock contention. (<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2022/labs/guidance.html">moderate</a>), but difficult to test/measure</li>
<li>[ ] <code>sockrecvudp()</code> uses a singly-linked list to find the destination socket, which is inefficient. Try using a hash table and RCU instead to increase performance. (<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2022/labs/guidance.html">easy</a>), but a serious implementation would difficult to test/measure</li>
<li>[ ] <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc792">ICMP</a> can provide notifications of failed networking flows. Detect these notifications and propagate them as errors through the socket system call interface.</li>
<li>[ ] The E1000 supports several stateless hardware offloads, including checksum calculation, RSC, and GRO. Use one or more of these offloads to increase the throughput of your networking stack. (<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2022/labs/guidance.html">moderate</a>), but hard to test/measure</li>
<li>[ ] The networking stack in this lab is susceptible to receive livelock. Using the material in lecture and the reading assignment, devise and implement a solution to fix it. (<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2022/labs/guidance.html">moderate</a>), but hard to test.</li>
<li>[ ] Implement a UDP server for xv6. (<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2022/labs/guidance.html">moderate</a>)</li>
<li>[ ] Implement a minimal TCP stack and download a web page.</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>Mit6.S081:lab net</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="http://www.ember-l.top/2023/06/15/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab7%EF%BC%9Anet/">http://www.ember-l.top/2023/06/15/操作系统/lab/Lab7：net/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>Ember🍐</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2023-06-15</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2023-08-03</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><a class="post-meta__tags" href="/tags/xv6/">xv6</a></div><div class="post_share"><div class="social-share" data-image="https://ember-img.oss-cn-chengdu.aliyuncs.com/img41.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css" media="print" onload="this.media='all'"><script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js" defer></script></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">投喂硬币</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/06/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Chapter%205%EF%BC%9A%E4%B8%AD%E6%96%AD%E4%B8%8E%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/"><img class="prev-cover" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/202301251415483.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">xv6：中断与设备驱动</div></div></a></div><div class="next-post pull-right"><a href="/2023/06/26/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab8%EF%BC%9Alocks/"><img class="next-cover" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/202301251415687.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Mit6.S081:lab locks</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/07/26/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab10%EF%BC%9Ammap/" title="Mit6.S081:lab mmap"><img class="cover" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img30.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-26</div><div class="title">Mit6.S081:lab mmap</div></div></a></div><div><a href="/2023/04/24/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab2%EF%BC%9Asyscall/" title="Mit6.S081:lab syscall"><img class="cover" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/202301251416606.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-24</div><div class="title">Mit6.S081:lab syscall</div></div></a></div><div><a href="/2023/03/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab1%EF%BC%9Autilities/" title="Mit6.S081:lab utilities"><img class="cover" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/202301251415687.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-14</div><div class="title">Mit6.S081:lab utilities</div></div></a></div><div><a href="/2023/04/16/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab4%EF%BC%9Atraps/" title="Mit6.S081:lab traps(详解)"><img class="cover" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img21.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-16</div><div class="title">Mit6.S081:lab traps(详解)</div></div></a></div><div><a href="/2023/04/16/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab3%EF%BC%9Apgtbl/" title="Mit6.S081:lab pgtbl"><img class="cover" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img32.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-16</div><div class="title">Mit6.S081:lab pgtbl</div></div></a></div><div><a href="/2023/05/10/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab5%EF%BC%9ACOW/" title="Mit6.S081:lab COW"><img class="cover" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-10</div><div class="title">Mit6.S081:lab COW</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="author_top is-center"><div class="card-info-avatar"><div class="avatar-img"><img src="/assets/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-status-box"><div class="author-status"><g-emoji class="g-emoji" alias="palm_tree" fallback-src="https://lskypro.acozycotage.net/LightPicture/2022/12/fe1dc0402e623096.jpg">🐟</g-emoji><span>认真摸鱼中</span></div></div></div><div class="author-info__name">Ember🍐</div><div class="author-info__description">BugMaker 💦💦💦</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ember-l"><i></i><span>Follow me🚀</span></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="/assets/qq.jpg" target="_blank" title="QQ"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-QQ"></use></svg></a><a class="social-icon faa-parent animated-hover" href="/assets/wx.jpg" target="_blank" title="微信"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-weixin"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://github.com/ember-l" target="_blank" title="github"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-github1"></use></svg></a><a class="social-icon faa-parent animated-hover" href="mailto:2508856440@qq.com" target="_blank" title="邮箱"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-youxiang"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://www.zhihu.com/people/low-45-75" target="_blank" title="知乎"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shejiaotubiao-10"></use></svg></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><a class="faa-parent animated-hover"><svg class="faa-tada icon" style="height:27px;width:27px;fill:currentColor;position:relative;top:3px" aria-hidden="true"><use xlink:href="#icon-fengche"></use></svg></a><span>公告</span></div><div class="announcement_content"><center><b>--- 主域名 ---<br><a href="https://www.ember-l.top" title="此线路部署于Vercel" class="anno_content"><font color="#cc7227">ember-l.top</font></a></b></center></div><div id="welcome-info"></div></div><div class="card-widget tzy-right-widget" id="card-wechat"><div id="flip-wrapper"><div id="flip-content"><div class="face"></div><div class="back face"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><a class="faa-parent animated-hover"><svg class="faa-tada icon" style="height:27px;width:27px;fill:currentColor;position:relative;top:3px" aria-hidden="true"><use xlink:href="#icon-mulu"></use></svg></a><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#networking-hard"><span class="toc-text">networking(hard)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%EF%BC%9A"><span class="toc-text">实现：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%EF%BC%9A%E6%8E%A5%E5%8F%97%E7%BD%91%E7%BB%9C%E5%8C%85"><span class="toc-text">中断执行流程：接受网络包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E8%AE%BE%E7%BD%AE"><span class="toc-text">中断设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DMA%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-text">DMA缓冲区</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="toc-text">套接字</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE"><span class="toc-text">网络协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E4%BF%A1%E6%81%AF"><span class="toc-text">地址信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%A9%E7%90%86%E5%B1%82%EF%BC%9AEthernet"><span class="toc-text">物理层：Ethernet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE%E8%B7%AF%E5%B1%82%EF%BC%9AARP"><span class="toc-text">链路层：ARP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%B1%82%EF%BC%9AIP"><span class="toc-text">网络层：IP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E8%BE%93%E5%B1%82%EF%BC%9AUDP"><span class="toc-text">传输层：UDP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%B1%82%EF%BC%9ADNS"><span class="toc-text">应用层：DNS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8C%91%E6%88%98"><span class="toc-text">挑战</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 By Ember🍐</div><div class="footer_custom_text"><a href="https://icp.gov.moe/?keyword=20232016" target="_blank">萌ICP备20232016号</a> <p>There is only one heroism in the world to see the world as it is and to love it<p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://www.jsdelivr.com/"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用JsDelivr为静态资源提供CDN加速"></a> &nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Coding-0cedbe?style=flat&logo=Codio" title="本站采用双线部署，联通线路托管于Coding"></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="share" type="button" title="分享链接" onclick="share()"><i class="fas fa-share-nodes"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><script src="https://cdn.staticfile.org/algoliasearch/4.14.3/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.staticfile.org/instantsearch.js/4.49.2/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.ember-l.top',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
        setTimeout(function(){
          let tk_comment = document.querySelectorAll('.tk-comments-container .tk-comment')
          if (tk_comment.length > 0) {
            let html = `<div class="swiper-wrapper">`
            for (let i = 0; i < tk_comment.length; i++) {
              let tk_id = tk_comment[i].getAttribute('id') || ''
              let tk_nick = tk_comment[i].querySelector('.tk-nick')?.innerText || ''
              let tk_href = tk_comment[i].querySelector('.tk-nick')?.href || ''
              let tk_avatar = tk_comment[i].querySelector('.tk-avatar-img')?.src || ''
              let tk_time = tk_comment[i].querySelector('.tk-time')?.innerText || ''
              let tk_city = tk_comment[i].querySelector('.tk-extras .tk-extra:first-child span:last-child')?.innerText || ''
              let tk_content = tk_comment[i].querySelector('.tk-content>span:last-child')?.innerHTML || ''
              tk_content = tk_content.replace(/\n/g, '') // replace \n
              tk_content = tk_content.replace(/<blockquote>.*?<\/blockquote>/gi, '') // replace blockquote
              tk_content = tk_content.replace(/<pre.*?<\/pre>/gi, '[代码]') // replace code
              html += `
                <div class="swiper-slide">
                  <div class="comment-barrage-item">
                    <div class="barrage-info">
                      <a class="barrage-title" title="跳转至评论区" href="#post-comment">热评</a>
                      <a href="${tk_href ? tk_href + '" target="_blank" rel="noopener noreferrer" title="访问 '+ tk_nick +'"' : 'javascript:void(0);"'}>
                        <img class="barrage-avatar" src="${tk_avatar}">
                      </a>
                      <span class="barrage-nick">${tk_nick}</span>
                      <span class="barrage-city">${tk_city}</span>
                      <span class="barrage-time">${tk_time}</span>
                      <a class="barrage-close" onclick="eurkon.switchCommentBarrage()" title="隐藏热评"><i class="fa-solid fa-xmark"></i></a>
                    </div>
                    <div class="barrage-content">
                      <a title="跳转至该评论" href="#${tk_id}">${tk_content}</a>
                    </div>
                  </div>
                </div>`
            }
            html += '</div>'
            let barrageContainer = document.getElementById('comment-barrage') || document.createElement('div')
            barrageContainer.id = 'comment-barrage'
            barrageContainer.innerHTML = html
            barrageContainer.style.display = window.localStorage.getItem('commentBarrageDisplay') === 'false' ? 'none' : 'block'
            document.getElementById('post-comment').appendChild(barrageContainer)
            var barrageSwiper = new Swiper('#comment-barrage', {
              direction: 'vertical',
              loop: true,
              mousewheel: true,
              autoplay: {
                delay: 3000,
                disableOnInteraction: true,
              }
            })
            barrageContainer.onmouseenter = function () {
              barrageSwiper.autoplay.stop()
            };
            barrageContainer.onmouseleave = function () {
              barrageSwiper.autoplay.start()
            };
          }
        }, 1000)
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.ember-l.top',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script src="/js/share.js"></script><script src="/js/key.js"></script><script src="/js/barrage.js"></script><script defer src="/js/light.js"></script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer data-pjax src="/js/readPercent.js"></script><script async src="//at.alicdn.com/t/c/font_3864328_90xjkz8cfrn.js"></script><script async src="/js/fps.js"></script><script src="/js/nav.js" async></script><script src="/js/sun_moon.js" async></script><script src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async data-pjax src="/js/txmap.js"></script><script src="/js/charts.js" async></script><script defer data-pjax src="/js/beautify.js"></script><script src="/js/twikoo_beautify.js"></script><script charset="UTF-8" id="LA_COLLECT" src="https://sdk.51.la/js-sdk-pro.min.js"></script><script src="https://sdk.51.la/perf/js-sdk-perf.min.js" crossorigin="anonymous"></script><script> LA.init({id:"Jx18u1PbLX8sXMaz",ck:"Jx18u1PbLX8sXMaz"})</script><script>new LingQue.Monitor().init({id:"Jx18u1PbLX8sXMaz",sendSuspicious:true});</script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/fireworks.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="http://www.ember-l.top/categories/MIT6-824/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 阿梨の分布式系统学习 (7)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://www.ember-l.top/categories/C/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🎮 阿梨のC++学习 (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://www.ember-l.top/categories/操作系统/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🐱‍👓 阿梨の操作系统学习 (15)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://www.ember-l.top/categories/Tool/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📒 阿梨の常用工具 (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="http://www.ember-l.top/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #fed558}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/07/17/操作系统/lab/Lab9：fs/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/202301251415687.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-07-17</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/07/17/操作系统/lab/Lab9：fs/&quot;);" href="javascript:void(0);" alt="">Mit6.S081:lab fs</a><div class="blog-slider__text">MIT：lab9</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/07/17/操作系统/lab/Lab9：fs/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/07/26/操作系统/lab/Lab10：mmap/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img30.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-07-26</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/07/26/操作系统/lab/Lab10：mmap/&quot;);" href="javascript:void(0);" alt="">Mit6.S081:lab mmap</a><div class="blog-slider__text">MIT：lab4</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/07/26/操作系统/lab/Lab10：mmap/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/03/14/操作系统/Chapter 1：操作系统接口/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img21.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-14</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/03/14/操作系统/Chapter 1：操作系统接口/&quot;);" href="javascript:void(0);" alt="">xv6：操作系统接口</a><div class="blog-slider__text">MIT：xv6 chapter1</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/03/14/操作系统/Chapter 1：操作系统接口/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/01/20/分布式系统/Spanner论文笔记/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img32.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-01-20</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/01/20/分布式系统/Spanner论文笔记/&quot;);" href="javascript:void(0);" alt="">Spanner</a><div class="blog-slider__text">No compromises:distributed transactions with consistency, availability, and performance</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/01/20/分布式系统/Spanner论文笔记/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/01/20/分布式系统/FaRM论文笔记/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/202301251415687.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-01-20</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/01/20/分布式系统/FaRM论文笔记/&quot;);" href="javascript:void(0);" alt="">FaRM</a><div class="blog-slider__text">No compromises:distributed transactions with consistency, availability, and performance</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/01/20/分布式系统/FaRM论文笔记/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/03/14/操作系统/Chapter 2：操作系统组成/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/202301251415483.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-14</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/03/14/操作系统/Chapter 2：操作系统组成/&quot;);" href="javascript:void(0);" alt="">xv6：操作系统组成</a><div class="blog-slider__text">MIT：xv6 chapter2</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/03/14/操作系统/Chapter 2：操作系统组成/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/03/14/分布式系统/实验/Sharded KV Service/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/202301251416606.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-14</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/03/14/分布式系统/实验/Sharded KV Service/&quot;);" href="javascript:void(0);" alt="">Lab4:Shards KV Service(未完善)</a><div class="blog-slider__text">MIT6.824 lab4实现# 描述</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/03/14/分布式系统/实验/Sharded KV Service/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/01/20/C++/Effective C++/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/202301251415687.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-01-20</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/01/20/C++/Effective C++/&quot;);" href="javascript:void(0);" alt="">Effect C++笔记</a><div class="blog-slider__text">Effective C++ 的部分学习笔记</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/01/20/C++/Effective C++/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/01/13/分布式系统/实验/KVRaft/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/202301251417569.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-01-13</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/01/13/分布式系统/实验/KVRaft/&quot;);" href="javascript:void(0);" alt="">Lab:KVRaft</a><div class="blog-slider__text">MIT6.824 lab3实现# 描述</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/01/13/分布式系统/实验/KVRaft/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/03/14/操作系统/Chapter 3：页表/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img31.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-14</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/03/14/操作系统/Chapter 3：页表/&quot;);" href="javascript:void(0);" alt="">xv6：页表</a><div class="blog-slider__text">MIT：xv6 chapter3</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/03/14/操作系统/Chapter 3：页表/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/03/14/分布式系统/实验/Debug/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img25.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-14</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/03/14/分布式系统/实验/Debug/&quot;);" href="javascript:void(0);" alt="">Debugging by Pretty Printing</a><div class="blog-slider__text">Lab2：Raft美化调试工具配置方法</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/03/14/分布式系统/实验/Debug/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var qweather_key = 'b16a1fa0e63c46a4b8f28abfb06ae3fe';
  var gaud_map_key = 'e2b04289e870b005374ee030148d64fd&s=rsv3';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '113.34532,23.15624';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1s');
    arr[i].setAttribute('data-wow-delay', '700ms');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>
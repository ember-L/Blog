<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>xv6ï¼šæ–‡ä»¶ç³»ç»Ÿ | EmberğŸ</title><meta name="author" content="EmberğŸ"><meta name="copyright" content="EmberğŸ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="MITï¼šxv6 chapter8"><meta property="og:type" content="article"><meta property="og:title" content="xv6ï¼šæ–‡ä»¶ç³»ç»Ÿ"><meta property="og:url" content="http://www.ember-l.top/2023/09/25/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Chapter%208%EF%BC%9A%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/index.html"><meta property="og:site_name" content="EmberğŸ"><meta property="og:description" content="MITï¼šxv6 chapter8"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://ember-img.oss-cn-chengdu.aliyuncs.com/layers.png"><meta property="article:published_time" content="2023-09-24T16:00:00.000Z"><meta property="article:modified_time" content="2023-09-25T15:24:00.037Z"><meta property="article:author" content="EmberğŸ"><meta property="article:tag" content="æ“ä½œç³»ç»Ÿ"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://ember-img.oss-cn-chengdu.aliyuncs.com/layers.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.ember-l.top/2023/09/25/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Chapter%208%EF%BC%9A%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:{appId:"FNCTP04VYC",apiKey:"5edd8c47a13fcf53938686d6f1752dbb",indexName:"dev_blog",hits:{per_page:6},languages:{input_placeholder:"æœç´¢æ–‡ç« ",hits_empty:"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}",hits_stats:"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼Œç”¨æ—¶ ${time} æ¯«ç§’"}},localSearch:void 0,translate:void 0,noticeOutdate:{limitDay:365,position:"top",messagePrev:"It has been",messageNext:"days since the last update, the content of the article may be outdated."},highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:200},copy:{success:"å¤åˆ¶æˆåŠŸ",error:"å¤åˆ¶é”™è¯¯",noSupport:"æµè§ˆå™¨ä¸æ”¯æŒ"},relativeDate:{homepage:!1,post:!1},runtime:"å¤©",date_suffix:{just:"åˆšåˆš",min:"åˆ†é’Ÿå‰",hour:"å°æ—¶å‰",day:"å¤©å‰",month:"ä¸ªæœˆå‰"},copyright:{limitCount:50,languages:{author:"ä½œè€…: EmberğŸ",link:"é“¾æ¥: ",source:"æ¥æº: EmberğŸ",info:"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“",cht_to_chs:"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“",day_to_night:"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼",night_to_day:"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼",bgLight:"#49b1f5",bgDark:"#1f1f1f",position:"bottom-left"},source:{justifiedGallery:{js:"https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js",css:"https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"xv6ï¼šæ–‡ä»¶ç³»ç»Ÿ",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-09-25 23:24:00"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const a=864e5*o,n={value:t,expiry:(new Date).getTime()+a};localStorage.setItem(e,JSON.stringify(n))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise(((t,o)=>{const a=document.createElement("script");a.src=e,a.async=!0,a.onerror=o,a.onload=a.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)})),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme"),o=(new Date).getHours();void 0===t?o<=6||o>=18?activateDarkMode():activateLightMode():"light"===t?activateLightMode():activateDarkMode();const a=saveToLocal.get("aside-status");void 0!==a&&("hide"===a?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="/css/font.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="/css/wave.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/css/progress_bar.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="/css/readPercent.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3864328_90xjkz8cfrn.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><span id="fps"></span><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="/css/twikoo_beautify.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="/css/tag.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/Swiper/8.0.6/swiper-bundle.min.css"><script data-pjax src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/Swiper/8.0.6/swiper-bundle.min.js"></script><link rel="stylesheet" href="/css/barrage.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css"><script src="/js/reward.js"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.16/dist/sweetalert2.all.min.js"></script><svg aria-hidden="true" style="position:absolute;overflow:hidden;width:0;height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248 626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"><style>#recent-posts>.recent-post-item>.recent-post-info>.article-meta-wrap>.tags:before{content:"\A";white-space:pre}#recent-posts>.recent-post-item>.recent-post-info>.article-meta-wrap>.tags>.article-meta__separator{display:none}</style><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload='this.media="all"'><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload='this.media="screen"'><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",(()=>{preloader.endLoading()})),document.addEventListener("pjax:send",(()=>{preloader.initLoading()})),document.addEventListener("pjax:complete",(()=>{preloader.endLoading()}))</script><link rel="stylesheet" href="/css/precess_bar.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">5</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-SmartHome"></use></svg> <span>é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shuji"></use></svg> <span>æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zongheshuju"></use></svg> <span>å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fabu-"></use></svg> <span>æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenlei"></use></svg> <span>åˆ†ç±»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:randomPost();"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenxiang"></use></svg> <span>éšä¾¿é€›é€›</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-meishikafei"></use></svg> <span>å¨±ä¹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-yinle"></use></svg> <span>éŸ³ä¹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Gallery/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fabu-"></use></svg> <span>ç…§ç‰‡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/movies/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-dianying"></use></svg> <span>ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shijie"></use></svg> <span>ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-pengyouquan"></use></svg> <span>æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Gallery/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-liuyan"></use></svg> <span>ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg> <span>å‹äººé“¾</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-wangye"></use></svg> <span>å°ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon--tongjibiao"></use></svg> <span>ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/article/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon--tongjibiao"></use></svg> <span>æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingshalou"></use></svg> <span>ç”Ÿæ¶¯</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-food-doughnut"></use></svg> <span>å…³äº</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url('https://ember-img.oss-cn-chengdu.aliyuncs.com/layers.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">EmberğŸ</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-SmartHome"></use></svg> <span>é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shuji"></use></svg> <span>æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zongheshuju"></use></svg> <span>å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fabu-"></use></svg> <span>æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenlei"></use></svg> <span>åˆ†ç±»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:randomPost();"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenxiang"></use></svg> <span>éšä¾¿é€›é€›</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-meishikafei"></use></svg> <span>å¨±ä¹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-yinle"></use></svg> <span>éŸ³ä¹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Gallery/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fabu-"></use></svg> <span>ç…§ç‰‡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/movies/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-dianying"></use></svg> <span>ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shijie"></use></svg> <span>ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-pengyouquan"></use></svg> <span>æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Gallery/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-liuyan"></use></svg> <span>ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg> <span>å‹äººé“¾</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-wangye"></use></svg> <span>å°ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon--tongjibiao"></use></svg> <span>ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/article/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon--tongjibiao"></use></svg> <span>æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingshalou"></use></svg> <span>ç”Ÿæ¶¯</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-food-doughnut"></use></svg> <span>å…³äº</span></a></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="æ£€ç´¢ç«™å†…ä»»ä½•ä½ æƒ³è¦çš„ä¿¡æ¯"><svg class="faa-tada icon" style="height:25px;width:25px;fill:currentColor;position:relative;top:2px;right:8px" aria-hidden="true"><use xlink:href="#icon-sousuo"></use></svg> <span>æœç´¢</span></a></div><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:5px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">xv6ï¼šæ–‡ä»¶ç³»ç»Ÿ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2023-09-24T16:00:00.000Z" title="å‘è¡¨äº 2023-09-25 00:00:00">2023-09-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-09-25T15:24:00.037Z" title="æ›´æ–°äº 2023-09-25 23:24:00">2023-09-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">æ“ä½œç³»ç»Ÿ</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">1.6w</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>59åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="xv6ï¼šæ–‡ä»¶ç³»ç»Ÿ"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="File-system"><a href="#File-system" class="headerlink" title="File system"></a>File system</h1><blockquote><p><strong>å†™åœ¨å‰é¢</strong>ï¼šæœ¬æ–‡æ˜¯åŸºäºxv6ä»¥åŠMIT6.S081è¯¾ç¨‹å†…å®¹æ‰€å†™çš„ç¬”è®°ï¼Œåœ¨é˜…è¯»æ—¶é…åˆxv6æºç ç†è§£æ•ˆæœæ›´ä½³ã€‚</p></blockquote><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>â€‹ è®¾è®¡æ–‡ä»¶ç³»ç»Ÿçš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†<strong>ç»„ç»‡</strong>ä¸<strong>å­˜å‚¨</strong>æ•°æ®ã€‚æ–‡ä»¶ç³»ç»Ÿä¸­æä¾›äº†<strong>å…±äº«</strong>ç”¨æˆ·ä¸ç¨‹åºçš„æ•°æ®çš„æ–¹å¼ã€‚åŒæ—¶ä¹Ÿæä¾›äº†<strong>æŒä¹…åŒ–</strong>(persistence)ï¼Œä¹Ÿå°±æ˜¯åœ¨è®¾å¤‡ä¸¢å¤±å¹¶é‡å¯åï¼Œæ•°æ®ä»ç„¶èƒ½å¤Ÿä¿å­˜ï¼Œä¼—æ‰€å‘¨çŸ¥å†…å­˜(RAM)è®¾å¤‡çš„æ•°æ®æ–­ç”µåæ˜¯ä¼šä¸¢å¤±çš„ã€‚</p><p>â€‹ xv6çš„æ–‡ä»¶ç³»ç»Ÿæä¾›äº†UNIXé£æ ¼çš„æ–‡ä»¶ã€ç›®å½•ã€è·¯å¾„åå’Œåœ¨ç£ç›˜å­˜å‚¨æ•°æ®(persistence)çš„æ–¹å¼ã€‚åŒæ—¶è¿™æ ·çš„æ–‡ä»¶ç³»ç»Ÿä¹Ÿä¼šç»™è®¾è®¡å¸¦æ¥ä¸€äº›æŒ‘æˆ˜ï¼š</p><ul><li><strong>ä¿å­˜åœ¨ç¡¬ç›˜ä¸Š(on-disk)çš„æ•°æ®ç»“æ„</strong>ï¼šæ–‡ä»¶ç³»ç»Ÿéœ€è¦è¡¨ç¤ºç›®å½•å’Œæ–‡ä»¶åç§°çš„æ ‘(tree)ï¼Œè®°å½•æ¯ä¸ªæ–‡ä»¶å†…å®¹å—çš„æ ‡è¯†ï¼Œå¹¶è®°å½•ç£ç›˜ä¸­é‚£äº›å—æ˜¯ç©ºé—²çš„ã€‚</li><li><strong>crashæ¢å¤(crash recovery)</strong>ï¼šå¦‚æœç”µè„‘crashå‘ç”Ÿï¼Œæ–‡ä»¶ç³»ç»Ÿéœ€è¦åœ¨é‡å¯åæ­£å¸¸å·¥ä½œã€‚é—®é¢˜åœ¨äºåœ¨crashä¼šä¸­æ–­æ›´æ–°çš„é¡ºåºï¼Œå¹¶ä¸”å¯¼è‡´on-diskæ•°æ®ç»“æ„ä¸æ–‡ä»¶æ•°æ®ä¸ä¸€è‡´ã€‚</li><li><strong>ç»´æŒä¸å˜é‡(maintian in variant)</strong>ï¼šä¸åŒçš„è¿›ç¨‹åŒæ—¶æ“ä½œä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œéœ€è¦åè°ƒæ•°æ®çš„æ›´æ–°ï¼Œé¢„é˜²å¹¶å‘è¯»å†™çš„æ•°æ®ç«äº‰ã€‚</li><li><strong>å†…å­˜ç¼“å­˜å¸¸ç”¨å—(in-memory cache of popular blocks)</strong>ï¼šç£ç›˜çš„è®¿é—®é€šå¸¸ä¼šæ¯”å†…å­˜è®¿é—®æ…¢å‡ ä¸ªæ•°é‡çº§ï¼Œæ‰€ä»¥æ–‡ä»¶ç³»ç»Ÿéœ€è¦ç»´æŒ<strong>å¸¸ç”¨æ•°æ®å—</strong>åœ¨å†…å­˜ä¸­çš„ç¼“å­˜ã€‚</li></ul><p>xv6ä¸­æ–‡ä»¶ç³»ç»Ÿçš„è®¾è®¡æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä½†æ˜¯ç”¨äºå­¦ä¹ æ˜¯ååˆ†ä¸é”™çš„ã€‚</p><h2 id="xv6æ–‡ä»¶ç³»ç»Ÿ"><a href="#xv6æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="xv6æ–‡ä»¶ç³»ç»Ÿ"></a>xv6æ–‡ä»¶ç³»ç»Ÿ</h2><p>xv6æ–‡ä»¶ç³»ç»Ÿçš„å®ç°è¢«ç»„ç»‡ä¸º7ä¸ªå±‚ï¼Œå¦‚ä¸‹å›¾æ‰€è¿°ï¼š</p><ol><li><strong>disk layer</strong>ï¼Œè¿›ç¨‹åœ¨ç£ç›˜è®¾å¤‡ä¸Šè¯»å†™å—(blocks);</li><li><strong>buffer cache layer</strong>ï¼Œå°†ç£ç›˜çš„å—ç¼“å­˜åœ¨<strong>å†…å­˜</strong>ä¸­å¹¶åŒæ­¥è®¿é—®ï¼Œå¹¶ä¸”åœ¨åªæœ‰ä¸€ä¸ªå†…æ ¸è¿›ç¨‹æ‰èƒ½åœ¨ä¸€ä¸ªæ—¶é—´æ®µå†…ä¿®æ”¹ç¼“å­˜ï¼Œå°†è¯¥å—å­˜å…¥å¯¹åº”ç£ç›˜çš„å—ä¸­</li><li><strong>logging layer</strong>ï¼Œå°†æ›´é«˜çš„å±‚ä¸­å¯¹äºå‡ ä¸ªæˆ–æ˜¯å¤šä¸ªçš„æ•°æ®å—çš„æ›´æ–°ä¿å­˜åœ¨ä¸€ä¸ª<strong>äº‹åŠ¡</strong>ä¸­(transaction)ï¼Œå¹¶ä¸”å´è¡¨è¿™äº›å—èƒ½å¤Ÿåœ¨é¢ä¸´crashæ—¶èƒ½å¤Ÿ<strong>åŸå­çš„æ›´æ–°</strong>(è¦ä¹ˆå…¨éƒ¨æ›´æ–°ï¼Œè¦ä¹ˆéƒ½ä¸æ›´æ–°)ã€‚</li><li><strong>inode layer</strong>ï¼Œæä¾›å•ç‹¬çš„æ–‡ä»¶çš„ä¿¡æ¯(metadata)ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶éƒ½æœ‰å”¯ä¸€ç¼–å·(i-number)çš„<code>inode</code>ï¼Œä¸€ä¸ªæ–‡ä»¶åªæœ‰ä¸€ä¸ª<code>inode</code>çš„ï¼Œåœ¨ç£ç›˜ä¸­æœ‰å›ºå®šçš„å—ä¼šä¿å­˜<code>inode</code>æ•°æ®ã€‚</li><li><strong>directory layer</strong>ï¼Œå°†ç›®å½•è®¾ç½®ä¸ºäº†ä¸€ç§ç‰¹æ®Šçš„<strong>inode</strong>ç§ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´ç›®å½•æ˜¯æ–‡ä»¶ï¼Œç›®å½•ä¼šä¿å­˜ç›®å½•æˆ–æ–‡ä»¶çš„æ¡ç›®çš„åºåˆ—ï¼Œæ¯ä¸€ä¸ªæ¡ç›®éƒ½ä¼šåŒ…å«æ–‡ä»¶åä¸i-numberã€‚</li><li><strong>pathname layer</strong>ï¼Œæä¾›åˆ†å±‚çº§çš„è·¯å¾„å‘½åæ–¹å¼ï¼Œå¦‚/usr/rt,/xv6/fs.cï¼Œè§£æè·¯å¾„æ˜æ—¶ä½¿ç”¨é€’å½’çš„æ–¹å¼æŸ¥è¯¢(findå®éªŒä¸­å°±æœ‰æ‰€æ¶‰åŠ)ã€‚</li><li><strong>descriptor layer</strong>ï¼Œå°†Unixèµ„æº(pipesï¼Œdevicesã€fileâ€¦)æŠ½è±¡åŒ–ï¼Œä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿçš„æ¥å£ï¼Œç®€åŒ–æ“ä½œç£ç›˜æ–‡ä»¶çš„æ–¹å¼ã€‚</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/layers.png" alt="layers"></p><p>â€‹ ä»¥ä¸Šä¾¿æ˜¯æ–‡ä»¶ç³»ç»Ÿä¸xv6æ–‡ä»¶ç³»ç»Ÿå¤§è‡´è®¾è®¡ï¼Œæ¥ä¸‹æ¥å°†ä¼šç”±åº•å±‚çš„disk layeré€æ¸è®²è§£åˆ°é¡¶å±‚çš„descriptor layerã€‚</p><h1 id="Disk-Layer"><a href="#Disk-Layer" class="headerlink" title="Disk Layer"></a>Disk Layer</h1><h2 id="ç£ç›˜ç¡¬ä»¶äº¤äº’"><a href="#ç£ç›˜ç¡¬ä»¶äº¤äº’" class="headerlink" title="ç£ç›˜ç¡¬ä»¶äº¤äº’"></a>ç£ç›˜ç¡¬ä»¶äº¤äº’</h2><p>â€‹ ä»æœ€ä½å±‚<strong>Disk layer</strong>è®²èµ·ï¼Œåœ¨å®é™…ä¸­risc-vä¸»æ¿ä¸Šä¼šè¿æ¥è®¸å¤šçš„å­˜å‚¨è®¾å¤‡ï¼Œæœ‰SSDä¸HDDä¸¤ç§å¸¸ç”¨çš„ç£ç›˜ç±»å‹ï¼Œä¸¤è€…çš„åŒºåˆ«åœ¨äºæ€§èƒ½ä¸æˆæœ¬æ–¹é¢ã€‚</p><p>â€‹ è¿™äº›å­˜å‚¨è®¾å¤‡è¿æ¥åˆ°äº†ç”µè„‘æ€»çº¿(bus)ä¹‹ä¸Šï¼Œæ€»çº¿ä¹Ÿè¿æ¥äº†<strong>CPUå’Œå†…å­˜</strong>ã€‚ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿè¿è¡Œåœ¨CPUä¸Šï¼Œå°†å†…éƒ¨çš„æ•°æ®å­˜å‚¨åœ¨å†…å­˜ï¼ŒåŒæ—¶ä¹Ÿä¼šä»¥è¯»å†™blockçš„å½¢å¼å­˜å‚¨åœ¨SSDæˆ–HDDã€‚è¯»å†™æ–‡ä»¶çš„æ¥å£æ¯”è¾ƒç®€å•æœ‰read/writeï¼Œç„¶åä»¥blockç¼–å·ä½œä¸ºå‚æ•°ã€‚</p><p>â€‹ åœ¨ä¸‹å›¾ä¸­æ˜¯CSAPPä¸­ç¡¬ä»¶çš„ç»„ç»‡ï¼Œé€šå¸¸æƒ…å†µCPUè¯»å–ç£ç›˜çš„æ–‡ä»¶æˆ–æ˜¯ç¨‹åºï¼Œéƒ½ä¼šå°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/hw_org.png" alt="hw_org"></p><blockquote><p><strong>æœ¯è¯­</strong>ï¼šsectorä¸block</p></blockquote><ul><li><strong>sector</strong>ï¼Œé€šå¸¸æ˜¯ç£ç›˜é©±åŠ¨å¯ä»¥è¯»å†™çš„æœ€å°å•å…ƒï¼Œå®ƒè¿‡å»é€šå¸¸æ˜¯512å­—èŠ‚ã€‚</li><li><strong>block</strong>ï¼Œé€šå¸¸æ˜¯æ“ä½œç³»ç»Ÿæˆ–è€…æ–‡ä»¶ç³»ç»Ÿè§†è§’çš„æ•°æ®ã€‚å®ƒç”±<strong>æ–‡ä»¶ç³»ç»Ÿå®šä¹‰</strong>ï¼Œåœ¨xv6ä¸­å®šä¹‰ä¸º1024å­—èŠ‚ã€‚æ‰€ä»¥xv6ä¸­<code>block = 2 * sector</code>ã€‚é€šå¸¸æ¥è¯´ä¸€ä¸ªblockå¯¹åº”äº†ä¸€ä¸ªæˆ–è€…å¤šä¸ªsectorã€‚</li></ul><p>ä½†æ˜¯è¿™ä¸¤ä¸ªæœ¯è¯­æ²¡æœ‰æ˜ç¡®çš„ç•Œé™ï¼Œæ‰€ä»¥å®¹æ˜“å¯¼è‡´æ··æ·†ã€‚</p><h2 id="ç£ç›˜å¸ƒå±€"><a href="#ç£ç›˜å¸ƒå±€" class="headerlink" title="ç£ç›˜å¸ƒå±€"></a>ç£ç›˜å¸ƒå±€</h2><p>â€‹ ä»æ–‡ä»¶ç³»ç»Ÿçš„è§’åº¦æ¥çœ‹ç£ç›˜è¿˜æ˜¯å¾ˆç›´è§‚çš„ã€‚å› ä¸ºå¯¹äºç£ç›˜å°±æ˜¯è¯»å†™blockæˆ–è€…sectorï¼Œæˆ‘ä»¬å¯ä»¥å°†ç£ç›˜çœ‹ä½œæ˜¯ä¸€ä¸ªå·¨å¤§çš„blockçš„æ•°ç»„ï¼Œæ•°ç»„ä»0å¼€å§‹ï¼Œä¸€ç›´å¢é•¿åˆ°ç£ç›˜çš„æœ€åã€‚</p><blockquote><p>ç£ç›˜å—ä¸ç±»å‹</p></blockquote><ul><li><strong>boot block</strong>ï¼Œblock0ï¼Œè¢«ç”¨ä½œboot sectoræ¥å¯åŠ¨æ“ä½œç³»ç»Ÿã€‚æ“ä½œç³»ç»Ÿä¹Ÿæ˜¯ä¸€ä¸ªç¨‹åºä¿å­˜åœ¨æ•°æ®å—ä¸­ï¼Œç‚¹å‡»å¼€æœºåï¼Œboot loaderä¼šå°†è¯¥æ“ä½œç³»ç»ŸåŠ è½½å†…å­˜ä¸­ã€‚xv6ä¸­æ²¡æœ‰ä½¿ç”¨boot blockã€‚</li><li><strong>super block</strong>ï¼Œblock1é€šå¸¸è¢«ç§°ä¸ºsuper blockï¼Œå®ƒæè¿°äº†æ–‡ä»¶ç³»ç»Ÿçš„çº¿ç®¡ä¿¡æ¯ã€‚åŒ…å«ç£ç›˜ä¸Šæœ‰å¤šå°‘ä¸ªblockå…±åŒæ„æˆäº†æ–‡ä»¶ç³»ç»Ÿè¿™æ ·çš„ä¿¡æ¯ã€‚é€šè¿‡block1æ„é€ å‡ºå¤§éƒ¨åˆ†çš„æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ã€‚</li><li><strong>log block</strong>ï¼Œblock2-block31ã€‚å®é™…ä¸Šlogçš„å¤§å°å¯èƒ½ä¸åŒï¼Œè¿™é‡Œåœ¨super blockä¸­ä¼šå®šä¹‰logå°±æ˜¯30ä¸ªblockã€‚</li><li><strong>inode block</strong>ï¼Œåœ¨block32åˆ°block45ä¹‹é—´ã€‚ä¸€ä¸ªinodeæ˜¯64å­—èŠ‚ï¼Œæè¿°çš„äº†æ–‡ä»¶çš„ä¸€äº›ç›¸å…³ä¿¡æ¯ã€‚</li><li><strong>bitmap block</strong>ï¼Œæ„å»ºæ–‡ä»¶ç³»ç»Ÿçš„é»˜è®¤æ–¹æ³•ï¼Œå®ƒåªå æ®ä¸€ä¸ªblockã€‚å®ƒè®°å½•äº†data blockæ˜¯å¦ç©ºé—²ã€‚ä¸€ä¸ªå­—èŠ‚æœ‰8ä¸ªä½ï¼Œé‚£ä¹ˆä¸€ä¸ªå­—èŠ‚å¯ä»¥è¡¨ç¤º8ä¸ªæ•°æ®å—(é€šè¿‡æŒ‡å®šä½0å’Œ1è¡¨ç¤ºæ•°æ®å—æ˜¯å¦è¢«ä½¿ç”¨)ï¼Œä¾‹å¦‚<code>0000 0110</code>å°±å¯ä»¥è¡¨ç¤ºç¬¬2å’Œç¬¬3ä¸ªæ•°æ®å—è¢«ä½¿ç”¨äº†ï¼Œä¸€ä¸ªbitmapå°±å¯ä»¥è¡¨ç¤º8*1024ä¸ªæ•°æ®å—ã€‚</li><li><strong>data block</strong>ï¼Œblock46ä»¥åçš„å—éƒ½å±data blockï¼Œdata blockå­˜å‚¨äº†æ–‡ä»¶çš„å†…å®¹å’Œç›®å½•çš„å†…å®¹ã€‚</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/fs.png" alt="fs"></p><p>é€šå¸¸æ¥è¯´ï¼Œbitmap blockï¼Œinode blockså’Œlog blocksè¢«ç»Ÿç§°ä¸º<strong>metadata block</strong>ã€‚å®ƒä»¬è™½ç„¶ä¸å­˜å‚¨å®é™…çš„æ•°æ®ï¼Œä½†æ˜¯å®ƒä»¬å­˜å‚¨äº†èƒ½å¸®åŠ©æ–‡ä»¶ç³»ç»Ÿå®Œæˆå·¥ä½œçš„å…ƒæ•°æ®ã€‚</p><blockquote><p><strong>ä»£ç </strong>ï¼šè¶…çº§å—ç»“æ„ä½“</p></blockquote><p>è¿™ä¸ªç»“æ„ä½“æè¿°äº†æ–‡ä»¶ç³»ç»Ÿä¸­ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚æ–‡ä»¶ç³»ç»Ÿblockã€inodeã€logçš„æ•°é‡ç­‰ä¿¡æ¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">superblock</span> &#123;</span></span><br><span class="line">  uint magic;        <span class="comment">// Must be FSMAGIC</span></span><br><span class="line">  uint size;         <span class="comment">// Size of file system image (blocks)</span></span><br><span class="line">  uint nblocks;      <span class="comment">// Number of data blocks</span></span><br><span class="line">  uint ninodes;      <span class="comment">// Number of inodes.</span></span><br><span class="line">  uint nlog;         <span class="comment">// Number of log blocks</span></span><br><span class="line">  uint logstart;     <span class="comment">// Block number of first log block</span></span><br><span class="line">  uint inodestart;   <span class="comment">// Block number of first inode block</span></span><br><span class="line">  uint bmapstart;    <span class="comment">// Block number of first free map block</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p><strong>ä»£ç </strong>ï¼šè¶…çº§å—åˆå§‹åŒ–</p></blockquote><p>â€‹ æ–‡ä»¶å’Œç›®å½•å†…å®¹éƒ½ä¿å­˜åœ¨ç£ç›˜å—ä¸­ï¼Œè¿™å°±éœ€è¦ä¸€ä¸ª<strong>ç©ºé—²æ± </strong>(free pool)ç”¨äºåˆ†é…ç©ºé—²å—ã€‚xv6å—åˆ†é…å™¨(block allocator)ç»´æŒäº†ä¸€ä¸ª<strong>bitmapå—</strong>ï¼Œä¸€ä¸ªä½(bit)ä»£è¡¨ä¸€ä¸ªå—ï¼Œ0ä»£è¡¨å—ç©ºé—²ã€1ä»£è¡¨å—æ­£åœ¨ä½¿ç”¨ã€‚<code>mkfs</code>(mkfs/mkfs.cï¼Œç”¨Cè¯­è¨€ç¼–å†™çš„ç¨‹åºï¼Œæœ¬è´¨ä¸Šæ—¶åˆ¶ä½œä¸€ä¸ªé•œåƒä¹Ÿå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶)ç¨‹åºè®¾ç½®äº†è¿™äº›ä½å¯¹åº”äº†å„ä¸ªå—çš„ç¼–å·ï¼Œæœ‰<code>boot block</code>ã€<code>superblock</code>ç­‰ã€‚</p><p>â€‹ è¾“å…¥<code>make clean</code>åå†è¾“å…¥<code>make qemu</code>ï¼Œå¯ä»¥ä»<code>makefile</code>è¾“å‡ºä¿¡æ¯çœ‹åˆ°å¦‚ä¸‹æ¶ˆæ¯æ‰€ç¤ºï¼Œç¬¬ä¸€æ¡æ˜¯<code>makefile</code>çš„ç¼–è¯‘ä¿¡æ¯ï¼Œå¤§æ¦‚å°±æ˜¯å°† <code>REAMDE</code>ã€<code>user/_cat</code>ï¼Œè¿™äº›ç¨‹åºåŠ è½½åˆ°ç£ç›˜ï¼Œå®é™…æ˜¯å°†è¿™äº›ç¨‹åºå†™å…¥åˆ°äº†<code>fs.img</code>æ–‡ä»¶ä¸­ï¼Œæœ€åå°†è¿™ä¸ªé•œåƒæ–‡ä»¶åŠ è½½åˆ°qemuçš„è™šæ‹Ÿç£ç›˜ä¸Šã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkfs/mkfs fs.img README  user/_cat user/_echo user/_forktest user/_grep user/_init user/_kill user/_ln user/_ls user/_mkdir user/_rm user/_sh user/_stressfs user/_usertests user/_grind user/_wc user/_zombie  user/_bigfile</span><br><span class="line">----makefile</span><br><span class="line"><span class="comment">#ä½¿ç”¨gccç¼–è¯‘mkfsæ–‡ä»¶</span></span><br><span class="line"><span class="section">mkfs/mkfs: mkfs/mkfs.c $K/fs.h $K/param.h</span></span><br><span class="line">	gcc <span class="variable">$(XCFLAGS)</span> -Werror -Wall -I. -o mkfs/mkfs mkfs/mkfs.c</span><br><span class="line"><span class="comment">#åˆ¶ä½œfs.imgé•œåƒï¼Œçœ‹/mkfs/mkfs.cä»£ç å¯çŸ¥è¿™ä¸ªé•œåƒå®é™…å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶</span></span><br><span class="line"><span class="comment">#				fsfd = open(argv[1], O_RDWR|O_CREAT|O_TRUNC, 0666);</span></span><br><span class="line"><span class="section">fs.img: mkfs/mkfs README <span class="variable">$(UEXTRA)</span> <span class="variable">$(UPROGS)</span></span></span><br><span class="line">	mkfs/mkfs fs.img README <span class="variable">$(UEXTRA)</span> <span class="variable">$(UPROGS)</span></span><br></pre></td></tr></table></figure><p>â€‹ æ¥ä¸‹æ¥çš„<code>makefile</code>çš„è¾“å‡ºä¿¡æ¯ä¾¿æ˜¯mkfsæ–‡ä»¶ç³»ç»Ÿçš„<code>printf</code>è¯­å¥çš„è¾“å‡ºä¿¡æ¯ï¼Œå¤§è‡´å°±æ˜¯å‘Šè¯‰ä½ æ–‡ä»¶ç³»ç»Ÿä¸­<strong>å—çš„å¸ƒå±€åŠåˆ†é…æƒ…å†µ</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmeta 70 (boot, super, <span class="built_in">log</span> blocks 30 inode blocks 13, bitmap blocks 25) blocks 199930 total 200000</span><br><span class="line">balloc: first 799 blocks have been allocated</span><br><span class="line">balloc: write bitmap block at sector 45</span><br></pre></td></tr></table></figure><p>â€‹ åœ¨åé¢æœ‰ä¸€ä¸ª<code>balloc</code>å¼€å¤´çš„è¾“å‡ºè¯­å¥ï¼Œè¿™å®é™…ä¸Šæ˜¯å—åˆ†é…å™¨çš„å‡½æ•°ï¼Œæ¥ç€äº†è§£ä¸€ä¸‹å—åˆ†é…çš„ç›¸å…³æ“ä½œã€‚</p><p>åœ¨<code>mkfs/mkfs.c</code>ä¸­å°±å°±ç¼–å†™äº†è¶…çº§å—çš„åˆå§‹åŒ–æ•°æ®ï¼Œä¸»è¦æ˜¯å®šä¹‰äº†æ–‡ä»¶ç³»ç»Ÿçš„å¤§å°ã€ç£ç›˜å—çš„æ•°é‡ã€æ—¥å¿—å—çš„æ•°é‡ã€æ—¥å¿—å—çš„å¼€å§‹ç¼–å·ã€inodeå—çš„å¼€å§‹ç¼–å·ã€bmapå—çš„å¼€å§‹ç¼–å·ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">....</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> stat xv6_stat  <span class="comment">// avoid clash with host struct stat</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/fs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/param.h&quot;</span></span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">superblock</span> <span class="title">sb</span>;</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">  ....</span><br><span class="line">  sb.magic = FSMAGIC;</span><br><span class="line">  sb.size = xint(FSSIZE);</span><br><span class="line">  sb.nblocks = xint(nblocks);</span><br><span class="line">  sb.ninodes = xint(NINODES);</span><br><span class="line">  sb.nlog = xint(nlog);</span><br><span class="line">  sb.logstart = xint(<span class="number">2</span>);</span><br><span class="line">  sb.inodestart = xint(<span class="number">2</span>+nlog);</span><br><span class="line">  sb.bmapstart = xint(<span class="number">2</span>+nlog+ninodeblocks);</span><br><span class="line">  ....</span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Buffer-cache-layer"><a href="#Buffer-cache-layer" class="headerlink" title="Buffer cache layer"></a>Buffer cache layer</h1><h2 id="ç®€ä»‹-1"><a href="#ç®€ä»‹-1" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><strong>buffer cacheå±‚</strong>ä¸»è¦å®Œæˆä»¥ä¸‹ä¸¤ä¸ªä»»åŠ¡ï¼š</p><ol><li><strong>åŒæ­¥</strong>å¯¹ç£ç›˜å—çš„è®¿é—®ï¼šåªæœ‰ä¸€ä¸ªç£ç›˜å—çš„ä¸€ä¸ªå‰¯æœ¬ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ªå†…æ ¸çº¿ç¨‹èƒ½å¤Ÿåœ¨åŒä¸€æ—¶é—´å†…æ“ä½œè¿™ä¸ªå†…å­˜å‰¯æœ¬ã€‚</li><li>ç¼“å­˜<strong>å¸¸ç”¨çš„å—</strong>ä»¥æå‡æ€§èƒ½ï¼šè®¿é—®ç£ç›˜æ˜¯ç‰¹åˆ«æ…¢çš„æ“ä½œï¼Œç¼“å­˜ç»å¸¸ä½¿ç”¨çš„å—åœ¨å†…å­˜ä¸­ï¼Œå¯ä»¥åŠ å¿«æ•°æ®è®¿é—®çš„é€Ÿåº¦ã€‚</li></ol><p>åœ¨bio.cæ–‡ä»¶ä¸­å£°æ˜äº†buffer cacheå±‚æä¾›çš„ä¸‰ä¸ªæ¥å£ï¼šbuffer cacheå±‚å¯¹æ¯ä¸€ä¸ªbufferåŒ…å«ä¸€ä¸ª<code>sleeplock</code>ï¼Œä¿è¯bufferçš„åŒæ­¥æ€§ã€‚</p><ul><li><strong>bread</strong>ï¼šè·å–ä¸€ä¸ªbufï¼Œå…¶ä¸­åŒ…å«æŒ‡å®šç£ç›˜å—çš„å‰¯æœ¬ï¼Œè¿™ä¸ªå‰¯æœ¬èƒ½å¤Ÿåœ¨åç»­åœ¨ç£ç›˜ä¸­è¢«è¯»å–ä¸ä¿®æ”¹ã€‚è¿”å›ä¸€ä¸ªå·²é”å®šçš„bufã€‚</li><li><strong>bwrite</strong>ï¼šå°†å·²ä¿®æ”¹çš„bufferå†™å›å¯¹åº”çš„ç£ç›˜å—ä¸­ã€‚</li><li><strong>brelse</strong>ï¼šå†…æ ¸çº¿ç¨‹å®Œæˆbufferç›¸å…³ä¿®æ”¹åï¼Œè°ƒç”¨è¯¥æ¥å£é‡Šæ”¾è¿™ä¸ªbufã€‚é‡Šæ”¾é”å®šçš„bufã€‚</li></ul><p>â€‹ buffer cacheæ˜¯å†…å­˜ä¸­ä¿å­˜çš„å›ºå®šé•¿åº¦çš„<strong>åŒå‘buf(ç»“æ„ä½“)é“¾è¡¨</strong>ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´å†…å­˜ä¸­ä¸å¯èƒ½ç¼“å­˜æ‰€æœ‰çš„ç£ç›˜å—ï¼Œé‚£ä¹ˆå½“buffer cacheæ»¡äº†ä¹‹åï¼Œè¯»å–ä¸€ä¸ªæ–°çš„ç£ç›˜å—ï¼Œå°±éœ€è¦å›æ”¶<code>buf</code>èŠ‚ç‚¹ã€‚åœ¨xv6ä¸­ä½¿ç”¨äº†LRU(least recently used)ç®—æ³•ï¼Œä¹Ÿå°±æ˜¯å°†æœ€å°‘ä½¿ç”¨çš„å—å†™å›ç£ç›˜å›æ”¶<code>buf</code>èŠ‚ç‚¹ã€‚</p><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><blockquote><p>bufç»“æ„ä½“</p></blockquote><ul><li><strong>valid</strong>ï¼šbufä¸­æ˜¯å¦å«æœ‰å—çš„å‰¯æœ¬ã€‚</li><li><strong>disk</strong>ï¼šbufferå—çš„å†…å®¹æ˜¯å¦å·²ç»å†™å›äº†ç£ç›˜ï¼Œè¿™å°†ä¼šæ”¹å˜å—çš„å†…å®¹ã€‚</li><li><strong>dev</strong>ï¼šè®¾å¤‡idã€‚</li><li><strong>blockno</strong>ï¼šç£ç›˜å—çš„ç¼–å·ã€‚</li><li><strong>refcnt</strong>ï¼šå¼•ç”¨è®¡æ•°ï¼ŒæŒæœ‰bufèŠ‚ç‚¹<code>sleeplock</code>çš„æ•°é‡ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">buf</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> valid;   <span class="comment">// has data been read from disk?</span></span><br><span class="line">  <span class="type">int</span> disk;    <span class="comment">// does disk &quot;own&quot; buf?</span></span><br><span class="line">  uint dev;</span><br><span class="line">  uint blockno;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sleeplock</span> <span class="title">lock</span>;</span></span><br><span class="line">  uint refcnt;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">prev</span>;</span> <span class="comment">// LRU cache list</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">next</span>;</span></span><br><span class="line">  uchar data[BSIZE];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> <span class="title">buf</span>[<span class="title">NBUF</span>];</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Linked list of all buffers, through prev/next.</span></span><br><span class="line">  <span class="comment">// Sorted by how recently the buffer was used.</span></span><br><span class="line">  <span class="comment">// head.next is most recent, head.prev is least.</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> <span class="title">head</span>;</span></span><br><span class="line">&#125; bcache;</span><br></pre></td></tr></table></figure><blockquote><p><strong>buffer cacheåˆå§‹åŒ–</strong>ï¼š</p></blockquote><p>åˆ›å»ºåŒå‘é“¾è¡¨bcacheï¼Œbcacheä¸­æœ‰30ä¸ªbufèŠ‚ç‚¹ã€‚å¦‚ä¸‹å›¾</p><ul><li>ç”±<strong>å³åˆ°å·¦</strong>æ˜¯ä½¿ç”¨<code>next</code>æŒ‡é’ˆï¼Œè¿™ä¸ªæ˜¯<strong>MRU</strong>(most recently used)é“¾è¡¨ã€‚å³è¾¹çš„ç¬¬ä¸€ä¸ªå°±æ˜¯æœ€å¸¸(popular)ç”¨çš„bufferèŠ‚ç‚¹ï¼Œä¾æ¬¡ä½¿ç”¨<code>next</code>æŒ‡å‘è¯»å–ä¸‹ä¸€ä¸ªå—ï¼Œè¿™äº›å—çš„<strong>å¸¸ç”¨ç¨‹åº¦</strong>ä¾æ¬¡ä¸‹é™ã€‚</li><li>ä»<strong>å·¦åˆ°å³</strong>æ˜¯ä½¿ç”¨<code>prev</code>æŒ‡é’ˆï¼Œè¿™åˆ™æ˜¯<strong>LRU</strong>é“¾è¡¨ï¼Œä¸<strong>MRU</strong>é“¾è¡¨åˆšå¥½ç›¸åã€‚åœ¨xv6ä¸­ä¼šå°†LRUé“¾è¡¨çš„èŠ‚ç‚¹çš„bufferå†™å›ç£ç›˜ã€‚</li></ul><p>ä¸‹å›¾ä¸­<code>bcache.head</code>ä½œç”¨æ˜¯ä½¿ç”¨<code>prev</code>ä¸<code>next</code>æŒ‡é’ˆæŒ‡å‘<strong>MRU</strong>ä¸<strong>LRU</strong>ä¸¤ä¸ªæ–¹å‘çš„é“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€‚</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/linklist-5.png" alt="linklist-5"></p><p>ä¸‹è¿°ä»£ç ä¸­ï¼Œå°†æ¯ä¸€ä¸ªbufferèŠ‚ç‚¹éƒ½è®¾ç½®äº†ä¸€ä¸ª<code>sleeplock</code>ï¼Œéå†bcache.bufçš„æ‰€æœ‰èŠ‚ç‚¹åˆ›å»ºäº†åŒå‘é“¾è¡¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">binit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">b</span>;</span></span><br><span class="line"></span><br><span class="line">  initlock(&amp;bcache.lock, <span class="string">&quot;bcache&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create linked list of buffers</span></span><br><span class="line">  bcache.head.prev = &amp;bcache.head;</span><br><span class="line">  bcache.head.next = &amp;bcache.head;</span><br><span class="line">  <span class="keyword">for</span>(b = bcache.buf; b &lt; bcache.buf+NBUF; b++)&#123;</span><br><span class="line">    b-&gt;next = bcache.head.next;</span><br><span class="line">    b-&gt;prev = &amp;bcache.head;</span><br><span class="line">    initsleeplock(&amp;b-&gt;lock, <span class="string">&quot;buffer&quot;</span>);</span><br><span class="line">    bcache.head.next-&gt;prev = b;</span><br><span class="line">    bcache.head.next = b;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>bread</strong>ï¼šè·å¾—æŒ‡å®šå—çš„bufï¼Œè¿”å›ä»¥é”å®šçš„buf</p></blockquote><p>â€‹ åœ¨breadæ¥å£ä¸­ä¼šè°ƒç”¨bgetå‡½æ•°ï¼Œè¿”å›æŒ‡å®šç£ç›˜å—å·çš„bufã€‚å¦‚æœè¯¥bufæ˜¯æ–°åˆ†é…çš„èŠ‚ç‚¹é‡Œé¢æ²¡æœ‰æ•°æ®ï¼Œåˆ™è°ƒç”¨<code>virtio_disk_rw</code>æ¥å£è¯»å–ç£ç›˜å—çš„å†…å®¹åˆ°bufä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> buf*</span><br><span class="line"><span class="title function_">bread</span><span class="params">(uint dev, uint blockno)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">b</span>;</span></span><br><span class="line"></span><br><span class="line">  b = bget(dev, blockno);</span><br><span class="line">  <span class="keyword">if</span>(!b-&gt;valid) &#123;</span><br><span class="line">    virtio_disk_rw(b, <span class="number">0</span>);</span><br><span class="line">    b-&gt;valid = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>bwrite</strong>ï¼šå°†bufferå†™å…¥ç£ç›˜å—</p></blockquote><p>ä¸€æ—¦<code>bread</code>è¯»å–äº†ç£ç›˜å¹¶å°†bufferè¿”å›äº†è°ƒç”¨è€…ï¼Œè°ƒç”¨è€…å°†ç‹¬å ä½¿ç”¨è¿™ä¸ªbufferã€‚åªæœ‰åœ¨è°ƒç”¨äº†<code>bwrite</code>ä¹‹åå°†ä¿®æ”¹çš„æ•°æ®å†™å…¥ç£ç›˜æ‰èƒ½é‡Šæ”¾bufferã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">bwrite</span><span class="params">(<span class="keyword">struct</span> buf *b)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>(!holdingsleep(&amp;b-&gt;lock))</span><br><span class="line">    panic(<span class="string">&quot;bwrite&quot;</span>);</span><br><span class="line">  virtio_disk_rw(b, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>bget</strong>ï¼šè·å–æŒ‡å®šå—çš„buffer</p></blockquote><p><code>bget</code>ä¸­ä¼šåšä¸¤ä»¶äº‹ï¼š</p><ol><li><strong>æŸ¥æ‰¾å·²ç¼“å­˜çš„buf</strong>ï¼šä½¿ç”¨nextæŒ‡é’ˆæ‰«æ<strong>MRU</strong>é“¾è¡¨ï¼Œé€šè¿‡åˆ¤æ–­<code>dev</code>ä¸<code>blockno</code>å‚æ•°ï¼Œå¦‚æœå·²ç»ç¼“å­˜äº†è¿™ä¸ªå—ï¼Œè·å–<code>sleeplock</code>åè¿”å›å·²é”å®šçš„bufèŠ‚ç‚¹ã€‚åä¹‹è¯´æ˜æ²¡æœ‰ç¼“å­˜æŒ‡å®šçš„ç£ç›˜å—ï¼Œåˆ™è¿›å…¥ä¸‹ä¸€æ­¥ã€‚</li><li><strong>æŸ¥æ‰¾ç©ºbuf</strong>ï¼šä½¿ç”¨prevæŒ‡é’ˆæ‰«æ<strong>LRU</strong>é“¾è¡¨ï¼ŒæŸ¥æ‰¾æ²¡æœ‰ä½¿ç”¨è¿‡çš„bufèŠ‚ç‚¹(<code>b-&gt;refcnt = 0</code>)ï¼Œå°†è¯¥bufèŠ‚ç‚¹çš„ç›¸åº”å­—æ®µå¡«å…¥ï¼Œè·å–<code>sleeplock</code>åè¿”å›å·²é”å®šçš„bufèŠ‚ç‚¹ã€‚</li></ol><p>â€‹ ä¸ºäº†ç¡®ä¿<strong>åŒæ­¥æ€§</strong>ï¼Œæ–‡ä»¶ç³»ç»Ÿä½¿ç”¨é”æ§åˆ¶åŒæ­¥ï¼Œå› æ­¤æ¯ä¸€ä¸ªç£ç›˜å—åªèƒ½ç¼“å­˜åœ¨ä¸€ä¸ªbufferä¸­ï¼Œç¡®å®šreadersèƒ½å¤Ÿçœ‹è§å†™å…¥ã€‚<code>bget</code>å‡½æ•°ä¸­å¯¹é“¾è¡¨æ‰«æï¼Œæ£€æŸ¥bufèŠ‚ç‚¹æ˜¯å¦ç¼“å­˜ï¼Œè¿™ä¸ªè¿‡ç¨‹æŒæœ‰<code>bcache.lock</code>ç›´åˆ°è¿”å›ï¼Œä»¥ç¡®ä¿ä¸ä¼šå¤šä¸ªbufèŠ‚ç‚¹ç¼“å­˜ä¸€ä¸ªç£ç›˜å—æˆ–æ˜¯ä¸€ä¸ªbufèŠ‚ç‚¹ç¼“å­˜å¤šä¸ªç£ç›˜èŠ‚ç‚¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> buf*</span><br><span class="line"><span class="title function_">bget</span><span class="params">(uint dev, uint blockno)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">b</span>;</span></span><br><span class="line"></span><br><span class="line">  acquire(&amp;bcache.lock);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Is the block already cached?</span></span><br><span class="line">  <span class="keyword">for</span>(b = bcache.head.next; b != &amp;bcache.head; b = b-&gt;next)&#123;</span><br><span class="line">    <span class="keyword">if</span>(b-&gt;dev == dev &amp;&amp; b-&gt;blockno == blockno)&#123;</span><br><span class="line">      b-&gt;refcnt++;</span><br><span class="line">      release(&amp;bcache.lock);</span><br><span class="line">      acquiresleep(&amp;b-&gt;lock);</span><br><span class="line">      <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Not cached.</span></span><br><span class="line">  <span class="comment">// Recycle the least recently used (LRU) unused buffer.</span></span><br><span class="line">  <span class="keyword">for</span>(b = bcache.head.prev; b != &amp;bcache.head; b = b-&gt;prev)&#123;</span><br><span class="line">    <span class="keyword">if</span>(b-&gt;refcnt == <span class="number">0</span>) &#123;</span><br><span class="line">      b-&gt;dev = dev;</span><br><span class="line">      b-&gt;blockno = blockno;</span><br><span class="line">      b-&gt;valid = <span class="number">0</span>;</span><br><span class="line">      b-&gt;refcnt = <span class="number">1</span>;</span><br><span class="line">      release(&amp;bcache.lock);</span><br><span class="line">      acquiresleep(&amp;b-&gt;lock);</span><br><span class="line">      <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  panic(<span class="string">&quot;bget: no buffers&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>â€‹ <code>bget</code>ä¸­åœ¨<code>bcache.lock</code><strong>å…³é”®åŒº</strong>(critical section)ä¹‹å¤–ï¼Œä½¿ç”¨<code>sleeplock</code>ä¿æŠ¤bufèŠ‚ç‚¹æ•°æ®å®‰å…¨ï¼Œä¿æŠ¤å¯¹ç£ç›˜å—çš„bufèŠ‚ç‚¹çš„è¯»å†™ã€‚åœ¨å…³é”®åŒºä¹‹å†…ï¼Œä¸»è¦æ˜¯ä¿æŠ¤äº†<code>b-&gt;refcnt</code>å˜é‡ä¿è¯bufèŠ‚ç‚¹ä¸è¢«é‡æ–°ç”¨äºå…¶ä»–ç£ç›˜èŠ‚ç‚¹ï¼Œä¿æŠ¤å·²ç¼“å­˜å—çš„ä¿¡æ¯ã€‚</p><blockquote><p><strong>brelse</strong>ï¼šè°ƒç”¨è€…é‡Šæ”¾bufferï¼Œå‡å°‘å¼•ç”¨è®¡æ•°</p></blockquote><p>â€‹ å½“è°ƒç”¨è€…å®Œæˆäº†bufferçš„æ“ä½œï¼Œå¿…é¡»è°ƒç”¨<code>brelse</code>(b-release)é‡Šæ”¾å—ã€‚<code>brelse</code>é‡Šæ”¾<code>sleeplock</code>å¹¶å‡å°‘å¼•ç”¨è®¡æ•°ã€‚å½“å¼•ç”¨è®¡æ•°ä¸ºé›¶(<code>b-&gt;refcnt=0</code>)çš„bufèŠ‚ç‚¹ç§»åŠ¨åˆ°é“¾è¡¨çš„æœ€å³æ–¹(å¦‚ä¸‹å›¾æ‰€ç¤º)ï¼Œè¿™ä¸ªbufferèŠ‚ç‚¹å°±å˜æˆäº†<strong>æœ€ç»å¸¸ä½¿ç”¨</strong>çš„èŠ‚ç‚¹äº†ï¼Œåœ¨<code>bget</code>ä¸­æŸ¥æ‰¾å·²ç¼“å­˜çš„èŠ‚ç‚¹ä¾¿å¯ä»¥æœ€å…ˆæ‰¾åˆ°è¯¥èŠ‚ç‚¹ã€‚</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/release_buffer.png" alt="release_buffer"></p><p>â€‹ ç§»åŠ¨bufèŠ‚ç‚¹ä¼šå¼•èµ·buffer cacheé“¾è¡¨ä»¥<strong>æœ€è¿‘ä½¿ç”¨é¢‘ç‡</strong>è¿›è¡Œæ’åºï¼š(ä»å³å¾€å·¦)åœ¨é“¾è¡¨çš„ç¬¬ä¸€ä¸ªbufferæ˜¯æœ€è¿‘æœ€å¤šä½¿ç”¨çš„ï¼Œæœ€åä¸€ä¸ªåˆ™æ˜¯æœ€è¿‘æœ€å°‘ä½¿ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">brelse</span><span class="params">(<span class="keyword">struct</span> buf *b)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>(!holdingsleep(&amp;b-&gt;lock))</span><br><span class="line">    panic(<span class="string">&quot;brelse&quot;</span>);</span><br><span class="line"></span><br><span class="line">  releasesleep(&amp;b-&gt;lock);</span><br><span class="line"></span><br><span class="line">  acquire(&amp;bcache.lock);</span><br><span class="line">  b-&gt;refcnt--;</span><br><span class="line">  <span class="keyword">if</span> (b-&gt;refcnt == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// no one is waiting for it.</span></span><br><span class="line">    b-&gt;next-&gt;prev = b-&gt;prev;</span><br><span class="line">    b-&gt;prev-&gt;next = b-&gt;next;</span><br><span class="line">    b-&gt;next = bcache.head.next;</span><br><span class="line">    b-&gt;prev = &amp;bcache.head;</span><br><span class="line">    bcache.head.next-&gt;prev = b;</span><br><span class="line">    bcache.head.next = b;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  release(&amp;bcache.lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Logging-layer"><a href="#Logging-layer" class="headerlink" title="Logging layer"></a>Logging layer</h1><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><blockquote><p><strong>crash safty</strong></p></blockquote><p>â€‹ åœ¨å®é™…ä¸­ï¼šå½“ä½¿ç”¨<code>make</code>å‘½ä»¤ç¼–è¯‘æ–‡ä»¶æ—¶å€™ï¼Œä¼šé¢‘ç¹çš„ä¸æ–‡ä»¶ç³»ç»Ÿäº¤äº’ï¼Œåˆ›å»ºè¯»å†™æ–‡ä»¶ï¼Œä½†æ˜¯åœ¨<code>make</code>å‘½ä»¤æ‰§è¡Œçš„æœŸé—´ï¼Œä½ çš„ç¬”è®°æœ¬æ–­ç”µäº†ã€‚é‚£ä¹ˆåˆ°ä½ é‡å¯ç¬”è®°æœ¬åï¼Œä½¿ç”¨<code>ls</code>å‘½ä»¤æ˜¾ç¤ºæ–‡ä»¶ä¼šå‘ˆç°ä½ æœŸæœ›çš„çŠ¶æ€ã€‚</p><p>â€‹ <strong>crashæ¢å¤</strong>(crash recovery)æ˜¯æ–‡ä»¶ç³»ç»Ÿä¸­æœ€æœ‰è¶£çš„é—®é¢˜ä¹‹ä¸€ã€‚è¿™ä¸ªé—®é¢˜ä¸»è¦æ˜¯å› ä¸ºè®¸å¤šæ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œä¼šä¼´éšç€å†™ç£ç›˜æ“ä½œï¼Œè¦å†™å…¥ç£ç›˜çš„æ•°æ®æ˜¯ä¿å­˜åœ¨å†…å­˜ä¸­çš„(å·²ç»åœ¨å†…å­˜ä¸­ä¿®æ”¹æ•°æ®)ï¼Œä½†æ˜¯å½“æ•°æ®å†™å…¥ç£ç›˜åˆ°ä¸€åŠæˆ–æ˜¯æ²¡æœ‰å°†å†…å­˜çš„æ•°æ®å†™å…¥å®Œï¼Œå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜â€”â€”é‡å¯ç³»ç»Ÿåå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</p><blockquote><p><strong>crashæƒ…æ™¯</strong></p></blockquote><p>â€‹ ä»¥åˆ›å»ºå’Œå†™å…¥xæ–‡ä»¶ä¸ºä¾‹ï¼Œä¸»è¦è°ƒç”¨äº†<code>open</code>ä¸<code>write</code>è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚é‚£ä¹ˆechoæœŸé—´æ‰“å°ä¸€äº›å†™å…¥ç£ç›˜çš„å…³é”®æ“ä½œï¼Œå¿½ç•¥äº†è¯»å–æ“ä½œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;hi&quot;</span> &gt; x</span></span><br><span class="line">write:33 allocate inode for x</span><br><span class="line">write:33 init inode x </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">&lt;-crash1</span></span><br><span class="line">write:46 record x in directory&#x27;s data block</span><br><span class="line">write:32 update root inode</span><br><span class="line">write:33 update inode x</span><br></pre></td></tr></table></figure><p>â€‹ ç¬¬ä¸€äºŒå¥å¾—çŸ¥ï¼Œåˆ†é…inodeå—33ï¼Œå°±æ˜¯ä¸ºxæ–‡ä»¶åˆ†é…ä¸€ä¸ªinodeï¼Œå¹¶ä¸”åˆå§‹åŒ–inodeçš„æ•°æ®ï¼Œ(å°†ç£ç›˜å—è¯»å–åˆ°buffer cacheï¼Œå¹¶å†…å­˜ä¸­åˆå§‹åŒ–åï¼Œå†™å›ç£ç›˜)ã€‚æ¥ç€æ˜¯æ›´æ–°æ ¹ç›®å½•çš„æ•°æ®å—ï¼Œå°±æ˜¯æ·»åŠ xæ–‡ä»¶çš„æè¿°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºå†™åˆ°äº†46è¿™ä¸ªç£ç›˜å—ä¸Šã€‚æœ€åå†æ˜¯æ›´æ–°ç³»ç»Ÿ<strong>æ ¹ç›®å½•çš„inode</strong>ï¼Œå†æ˜¯å°†xæ–‡ä»¶çš„inodeå†™å›ç£ç›˜(å°†buffer cacheä¸­çš„inodeå†™å›ç£ç›˜)ã€‚</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/fs.png" alt="fs"></p><p>â€‹ é‚£ä¹ˆæ­¤æ—¶åœ¨ä¸Šå›¾ä¸­crash1ç‚¹å‡ºç°ç³»ç»Ÿcrashï¼Œé‚£ä¹ˆä¿å­˜åœ¨buffer cacheçš„å†…å®¹å°†ä¼šè¢«å…¨éƒ¨æ¸…ç©ºã€‚é‚£ä¹ˆç³»ç»Ÿå°±ä¼šä¸¢å¤±xæ–‡ä»¶çš„inodeï¼Œä½†æ˜¯è¿™ä¸ªinodeå·²ç»è¢«<strong>æ ‡è®°ä¸ºå·²ä½¿ç”¨</strong>(å¯ä»¥æŸ¥çœ‹<code>ialloc</code>çš„å®ç°é€»è¾‘)ã€‚åœ¨æ ¹ç›®å½•ä¸‹ä¹Ÿæ‰¾ä¸åˆ°xæ–‡ä»¶çš„inodeï¼Œä¹Ÿå°±<strong>æ— æ³•åˆ é™¤è¿™ä¸ªinode</strong>ã€‚è¿™ä¸ªé—®é¢˜ä¹Ÿæ˜¯å¯ä»¥æ¢å¤çš„ï¼Œå°±æ˜¯åœ¨é‡å¯æ—¶æ£€æŸ¥æ‰€æœ‰çš„inodeå—ï¼Œå¦‚æœinodeæ²¡æœ‰æ•°æ®å—å°±ç›´æ¥åˆ é™¤è¿™ä¸ªinodeå°±å¯ä»¥äº†ï¼Œæ˜¾ç„¶è¿™æ˜¯ååˆ†éº»çƒ¦çš„æ–¹æ¡ˆã€‚</p><p>â€‹ ä¸€ä¸ªè¿˜æœ‰é£é™©æƒ…æ™¯æ˜¯ï¼Œ<strong>åŒä¸€ä¸ªæ•°æ®å—å±äºä¸¤ä¸ªæ–‡ä»¶</strong>ï¼Œä¾‹å¦‚ï¼šåœ¨æ–‡ä»¶æˆªæ–­(å°†æ–‡ä»¶å¤§å°ä¿®æ”¹ä¸º0ï¼Œé‡Šæ”¾æ–‡ä»¶å†…å®¹)æ—¶å‘ç”Ÿcrashï¼Œç”±äºè¿™äº›å†™ç£ç›˜æ“ä½œæ˜¯åºåˆ—åŒ–çš„ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´inodeä¸­å¼•ç”¨äº†ä¸€ä¸ª<strong>æ•°æ®å—</strong>ï¼Œä½†æ˜¯åœ¨<strong>bitmapå—</strong>ä¸­å´æ ‡è®°äº†è¿™ä¸ªå—ä¸ºç©ºé—²ã€‚</p><p>â€‹ inodeå¼•ç”¨äº†ç©ºé—²å—ä¼šé€ æˆçš„é—®é¢˜æ˜¯ï¼Œåœ¨é‡å¯åï¼Œå†…æ ¸å¯èƒ½åˆ†é…è¿™ä¸ªæ•°æ®å—ç»™å…¶ä»–æ–‡ä»¶ï¼Œè¿™å°±ä¼šé€ æˆä¸¤ä¸ªä¸åŒçš„æ–‡ä»¶çš„å†…å®¹æŒ‡å‘äº†åŒä¸€ä¸ªæ•°æ®å—ã€‚å¦‚æœxv6æ”¯æŒå¤šç”¨æˆ·ï¼Œè¿™å°±ä¼šé€ æˆ<strong>å®‰å…¨é—®é¢˜</strong>ï¼Œå› ä¸ºæ—§æ–‡ä»¶çš„ç”¨æˆ·èƒ½å¤Ÿè¯»å†™æ–°æ–‡ä»¶ç”¨æˆ·çš„æ•°æ®ã€‚</p><h2 id="ç®€ä»‹-2"><a href="#ç®€ä»‹-2" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><blockquote><p><strong>æ—¥å¿—ç®€ä»‹</strong></p></blockquote><p>â€‹ ä¸ºäº†æ°å½“çš„åº”å¯¹æ–‡ä»¶ç³»ç»Ÿçš„crashé—®é¢˜ï¼Œå› æ­¤åœ¨xv6ä¸­æä¾›çš„è§£å†³æ–¹æ¡ˆçš„æ–¹æ¡ˆæ˜¯<strong>æ—¥å¿—(logging)</strong>ï¼Œè¿™æ˜¯æ¥è‡ªä¸æ•°æ®åº“çš„è§£å†³æ–¹æ¡ˆï¼Œæä¾›äº†å¦‚ä¸‹å±æ€§ï¼š</p><ul><li><strong>åŸå­æ€§(atomic)</strong>ï¼Œç¡®ä¿æ–‡ä»¶ç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨æ˜¯åŸå­æ€§çš„ã€‚è¿™ä¸ªå±æ€§å’Œæ•°æ®åº“äº‹åŠ¡çš„åŸå­æ€§æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œæ¯”å¦‚ä½ è°ƒç”¨<code>write</code>ç³»ç»Ÿè°ƒç”¨ï¼Œæ‰€æœ‰å†™å…¥ç£ç›˜å—çš„æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸ä¼šå‡ºç°å†™å…¥éƒ¨åˆ†çš„é—®é¢˜ã€‚</li><li><strong>å¿«é€Ÿæ¢å¤(Fast Recovery)</strong>ï¼Œåœ¨é‡å¯ä¹‹åï¼Œä¸éœ€è¦åšå¤§é‡çš„å·¥ä½œæ¥ä¿®å¤æ–‡ä»¶ç³»ç»Ÿï¼Œåªéœ€è¦éå¸¸å°çš„å·¥ä½œé‡ã€‚åœ¨å¦ä¸€ä¸ªè§£å†³æ–¹æ¡ˆä¸­ï¼Œå¯èƒ½éœ€è¦è¯»å–æ–‡ä»¶ç³»ç»Ÿçš„æ‰€æœ‰blockï¼Œå¹¶æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦è¿˜å¤„äºæ­£ç¡®çš„çŠ¶æ€ï¼Œå†æ¥ä¿®å¤ã€‚æ‰€ä»¥æ—¥å¿—æœ‰<strong>å¿«é€Ÿæ¢å¤</strong>çš„å±æ€§ã€‚</li><li><strong>é«˜æ€§èƒ½(high performance)</strong>ï¼ŒåŸåˆ™ä¸Šæ¥è¯´ï¼Œå®ƒå¯ä»¥éå¸¸çš„é«˜æ•ˆï¼Œä½†æ˜¯åœ¨xv6å¹¶ä¸é«˜æ•ˆã€‚</li></ul><p>â€‹ logå—ä¿å­˜åœ¨å›ºå®šçš„ç£ç›˜å—ä¸­ï¼Œå·²ç»åœ¨superblockä¸­æ ‡è¯†ã€‚åœ¨superblockä¸­è®°å½•äº†<strong>logå—çš„å¼€å§‹ç´¢å¼•</strong>ä»¥åŠ<strong>logå—çš„æ•°é‡</strong>ï¼Œlogå—æ€»å…±æœ‰30å—(2-31)ã€‚</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/fs.png" alt="fs"></p><p>â€‹ é€šè¿‡crash saftyéƒ¨åˆ†å¾—çŸ¥ï¼Œæ–‡ä»¶ç³»ç»Ÿè°ƒç”¨å¯¹æ‰€æœ‰ç£ç›˜å—çš„ä¿®æ”¹æ˜¯ä¸èƒ½åœ¨å†™å…¥çš„ä¸­é€”å‘ç”Ÿç³»ç»Ÿcrashã€‚å› æ­¤åœ¨æ—¥å¿—è®¾è®¡ä¸­ï¼Œå°†ä¸€ç³»åˆ—ç£ç›˜çš„å†™å…¥æ“ä½œï¼Œ<strong>åŒ…è£…æˆäº†ä¸€ä¸ªäº‹åŠ¡</strong>ï¼Œå°†æ‰€æœ‰ç£ç›˜å—çš„å†™å…¥ï¼Œè½¬æ¢æˆäº†å¯¹logå—çš„å†™å…¥ã€‚æ¥ç€äº†è§£ä¸€ä¸‹æ—¥å¿—äº‹åŠ¡çš„è¿‡ç¨‹ã€‚</p><blockquote><p><strong>æ—¥å¿—äº‹åŠ¡</strong></p></blockquote><p>å°†å†™å…¥æ“ä½œçš„åˆ†è£…æˆäº‹åŠ¡ä»¥åŠå°†æ—¥å¿—äº‹åŠ¡äº§ç”Ÿæ•ˆæœçš„è¿‡ç¨‹å¦‚ä¸‹ï¼Œä¸»è¦æœ‰å››ä¸ªæ­¥éª¤ï¼š</p><ol><li><strong>æ—¥å¿—å†™å…¥(log write)</strong>ï¼Œå°†ç›´æ¥å†™å…¥ç£ç›˜å—ï¼Œæ”¹ä¸ºå†™åˆ°logå—ã€‚å‡è®¾æˆ‘ä»¬åœ¨å†…å­˜ä¸­ç¼“å­˜äº†bitmapå—ï¼Œä¹Ÿå°±æ˜¯å—45ã€‚å½“éœ€è¦æ›´æ–°bitmapæ—¶ï¼Œä¸æ˜¯ç›´æ¥å†™block 45ï¼Œè€Œæ˜¯å°†æ•°æ®å†™å…¥åˆ°logå—ä¸­ï¼Œå¹¶è®°å½•è¿™ä¸ªæ›´æ–°åº”è¯¥å†™å…¥åˆ°block 45ã€‚å¯¹äºæ‰€æœ‰çš„å†™ blockéƒ½ä¼šæœ‰ç›¸åŒçš„æ“ä½œã€‚</li><li><strong>æ“ä½œæäº¤(commit op)</strong>ï¼Œåœ¨æŸä¸ªæ—¶é—´ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„<strong>å†™æ“ä½œç»“æŸ</strong>äº†ï¼Œæ¯”å¦‚è¯´4-5ä¸ªå†™ç£ç›˜å—æ“ä½œéƒ½ç»“æŸï¼Œå¹¶ä¸”éƒ½ä¿å­˜åœ¨logå—ä¸­ï¼Œæˆ‘ä»¬ä¼šæäº¤è¿™äº›å†™æ“ä½œï¼Œä¹Ÿå°±æ˜¯<strong>æäº¤äº‹åŠ¡</strong>ã€‚è¿™æ„å‘³ç€éœ€è¦åœ¨logçš„æŸä¸ªä½ç½®è®°å½•å±äºåŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œçš„ä¸ªæ•°ï¼Œä¾‹å¦‚5ã€‚</li><li><strong>å®‰è£…æ—¥å¿—(install log)</strong>ï¼Œå®‰è£…æ—¥å¿—å°±æ˜¯å°†logå—åŒºåŸŸä¿å­˜çš„æ‰€æœ‰è¦ä¿®æ”¹çš„ç£ç›˜å—ï¼Œè½¬ç§»åˆ°å¯¹åº”çš„ç£ç›˜å—ï¼Œæ¯”å¦‚è¯´log5å—ä¿å­˜çš„æ˜¯595å—çš„å†™å…¥æ•°æ®ï¼Œé‚£ä¹ˆå°±æ˜¯å°†log5å—å¤åˆ¶åˆ°595å—ï¼Œä¾æ¬¡å®‰è£…æ‰€æœ‰æ—¥å¿—ã€‚</li><li><strong>æ¸…ç†æ—¥å¿—(clean log)</strong>ï¼Œå®Œæˆå®‰è£…æ—¥å¿—åï¼Œå°±å¯ä»¥æ¸…é™¤logå—ã€‚æ¸…é™¤logå—å®é™…ä¸Šå°±æ˜¯å°†å±äºåŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿè°ƒç”¨çš„æ“ä½œçš„ä¸ªæ•°è®¾ç½®ä¸º0ã€‚</li></ol><p>ä»¥ä¸Šä¾¿æ˜¯æ—¥å¿—äº‹åŠ¡çš„æ‰€æœ‰å·¥ä½œæµç¨‹ï¼Œæ¥ç€è®¨è®ºä¸€ä¸‹å¯èƒ½å‘ç”Ÿçš„crashç‚¹ã€‚</p><blockquote><p><strong>æ—¥å¿—ä¸crash</strong></p></blockquote><ol><li>åœ¨1å’Œ2ä¹‹é—´å‘ç”Ÿcrashï¼Œé‡å¯ä¹‹åä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿï¼Œå°±åƒæ˜¯åœ¨æ‰§è¡Œæ–‡ä»¶ç³»ç»Ÿè°ƒç”¨ä¹‹å‰çš„çŠ¶æ€ä¸€æ ·ã€‚</li><li>åœ¨2å’Œ3ä¹‹é—´å‘ç”Ÿcrashï¼Œè¿™æ—¶æ‰€æœ‰çš„å†™æ“ä½œéƒ½ä¿å­˜åœ¨logå—ä¸­ï¼Œå·²ç»æœ‰<code>committed</code>çš„æ ‡è®°ï¼Œé‡å¯ä¹‹åå°±å†æ¬¡æ‰§è¡Œ<strong>install log</strong>æ“ä½œå°±å¯ä»¥äº†ã€‚ä½†æ˜¯åœ¨2è¿‡ç¨‹ä¸­crashï¼Œå°±æ²¡æœ‰<code>committed</code>æ ‡è®°ï¼Œé‡å¯ä¹‹åï¼Œå°±åƒæ˜¯æ²¡æœ‰å†™å…¥ä¸€æ ·ã€‚</li><li>åœ¨3æ‰§è¡Œçš„è¿‡ç¨‹å’Œ4å‘ç”Ÿä¹‹å‰å‘ç”Ÿcrashï¼Œä¸‹æ¬¡é‡å¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼š<strong>redo log</strong>ï¼Œæˆ‘ä»¬æˆ–è®¸ä¼šå†æ¬¡å°†logå—ä¸­çš„æ•°æ®å†æ¬¡æ‹·è´åˆ°æ–‡ä»¶ç³»ç»Ÿã€‚logä¸­çš„æ•°æ®æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬å°±ç®—é‡å¤å†™äº†æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯æ¬¡å†™å…¥çš„æ•°æ®ä¹Ÿæ˜¯ä¸å˜çš„ã€‚è¿™å°±è¯´æ˜<code>install log</code>æ“ä½œæ˜¯å¹‚ç­‰çš„(<strong>idempotence</strong>ï¼Œè¡¨ç¤ºæ‰§è¡Œå¤šæ¬¡å’Œæ‰§è¡Œä¸€æ¬¡æ•ˆæœä¸€æ ·)ã€‚</li></ol><p>ä»¥ä¸Šä¾¿æ˜¯æ—¥å¿—åœ¨xv6å®ç°çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯æœ€ç®€å•çš„æ—¥å¿—å®ç°æ–¹å¼ã€‚</p><blockquote><p><strong>æ•°æ®äº¤äº’è¿‡ç¨‹</strong></p></blockquote><p>å¦‚ä¸‹å›¾æ‰€ç¤ºæ˜¯<strong>log write</strong>ä¸<strong>log install</strong>çš„è¿‡ç¨‹ï¼Œä¾‹å¦‚ï¼Œé€šè¿‡writeç³»ç»Ÿè°ƒç”¨ï¼Œè¦å†™å…¥æ•°æ®åˆ°æ–‡ä»¶ä¸­ï¼Œä¸»è¦è¿‡ç¨‹å¦‚ä¸‹ï¼šåªä»¥è¯»å†™bitmapå—ä¸ºä¾‹</p><ol><li>è¯»å–å—2(ç£ç›˜ä¸­æ—¥å¿—å—ç¼–å·æ˜¯2-32)ä¸å—45åˆ°<code>bcache</code>ï¼Œåˆ†åˆ«ä¸ºæ—¥å¿—å¤´ä¸bitmapå—ã€‚</li><li>åœ¨å†…å­˜ä¸­bcacheä¿®æ”¹ä¸¤ä¸ªå—åï¼Œè§¦å‘<strong>log commit</strong>ï¼Œè¿™æ—¶å°±å°†bcacheä¸­çš„å—45ä¸å—2å†™å…¥åˆ°logå—ä¸­(å†™å…¥ç£ç›˜)ã€‚</li><li>ä¹‹åçš„æŸä¸ªæ—¶é—´ç‚¹è§¦å‘<strong>log install</strong>ï¼Œå°†logå—ä¸­çš„$D_{b1}$ï¼Œå…¶ä¸­b1æŒ‡çš„æ˜¯é€»è¾‘å—ï¼Œå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®å—åºåˆ—å·ï¼Œæ¯”å¦‚æ–‡ä»¶çš„æ•°æ®ä¿å­˜åœ¨å—400ï¼Œ450ï¼Œ460ï¼Œé‚£ä¹ˆb1=400ï¼Œb2 = 450ï¼Œb3 = 460ã€‚é‚£ä¹ˆæ­¤æ—¶b1ä¿å­˜çš„æ•°æ®å°±æ˜¯å—45çš„æ•°æ®ï¼Œç›´æ¥å†™å…¥åˆ°ç£ç›˜å—45å°±å¯ä»¥äº†</li></ol><p>å¦‚ä¸‹å›¾æ‰€ç¤º<strong>H</strong>ä»£è¡¨<strong>log header</strong>ï¼Œå…¶ä¿å­˜blockæ•°ç»„å†…å®¹æ˜¯ç®­å¤´<strong>H</strong>æŒ‡å‘çš„å·¦ä¸Šè§’çš„çŸ©å½¢æ¡†ä¸­çš„æ•°æ®ï¼Œå›¾ä¸­çš„æµç¨‹å¦‚ä¸Šé¢ä¸‰æ­¥éª¤ã€‚</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/log.png" alt="log"></p><h2 id="ä»£ç ï¼šlogging"><a href="#ä»£ç ï¼šlogging" class="headerlink" title="ä»£ç ï¼šlogging"></a>ä»£ç ï¼šlogging</h2><blockquote><p><strong>æ—¥å¿—ç»“æ„</strong></p></blockquote><p>åœ¨xv6ä¸­è®¾è®¡çš„logç»“æ„ï¼š</p><ul><li><strong>logheaderç»“æ„</strong>ï¼šå…¶ä¸­nè¡¨ç¤ºæœ¬æ¬¡logè¦æ“ä½œçš„blockæ•°é‡ï¼Œblockæ•°ç»„ä»£è¡¨è¦å†™å…¥ç£ç›˜blockçš„ç¼–å·ã€‚åœ¨<code>param.h</code>ä¸­å®šä¹‰äº†ä¸€æ¬¡äº‹åŠ¡ä¸­logæœ€å¤§çš„blockæ•°é‡ã€‚</li><li><strong>logç»“æ„</strong>ï¼šä¸»è¦å®šä¹‰äº†å…³äºlogç£ç›˜å—ç›¸å…³çš„å…ƒæ•°æ®ï¼Œæ¯”è¾ƒç‰¹åˆ«çš„æ˜¯xv6å°†æ—¥å¿—å¤´åµŒå…¥äº†logç»“æ„ä¸­ï¼Œç¬¬ä¸€ä¸ªlogç£ç›˜å—ä¿å­˜çš„å°±æ˜¯logheaderã€‚</li><li><strong>logå¯¹è±¡</strong>ï¼šå¯¹äºæ—¥å¿—è¿™ä¸ªæ•°æ®å¯¹è±¡åœ¨xv6ä¸­åªæœ‰ä¸€ä¸ªï¼Œä¸€æ¬¡åœ¨å¹¶å‘çš„äº‹åŠ¡æ‰§è¡Œæ—¶ï¼Œéœ€è¦ä½¿ç”¨sleep-lockç”¨æ¥è§£å†³ç«äº‰ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">----param.h</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXOPBLOCKS  10  <span class="comment">// max # of blocks any FS op writes</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGSIZE      (MAXOPBLOCKS*3)  <span class="comment">// max data blocks in on-disk log</span></span></span><br><span class="line">----<span class="built_in">log</span>.c</span><br><span class="line"><span class="comment">//4 + 4*30 = 124å­—èŠ‚</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">logheader</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> n;</span><br><span class="line">  <span class="type">int</span> block[LOGSIZE];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//124 + 24 + 5 * 4 = 168å­—èŠ‚</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">log</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span> <span class="comment">// 24å­—èŠ‚</span></span><br><span class="line">  <span class="type">int</span> start; 		<span class="comment">//ç£ç›˜ä¸Šæ—¥å¿—å—çš„ç¼–å·ï¼Œåœ¨xv6ä¸­æ˜¯block2</span></span><br><span class="line">  <span class="type">int</span> size;			<span class="comment">//æ—¥å¿—å—æ€»æ•°é‡</span></span><br><span class="line">  <span class="type">int</span> outstanding; <span class="comment">// ç»Ÿè®¡æ­£åœ¨æ‰§è¡Œçš„æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨æ•°é‡ï¼Œä¾‹å¦‚ï¼šreadã€write</span></span><br><span class="line">  <span class="type">int</span> committing;  <span class="comment">// å½“å‰äº‹åŠ¡æ­£åœ¨æäº¤</span></span><br><span class="line">  <span class="type">int</span> dev;        <span class="comment">//ç£ç›˜è®¾å¤‡ç¼–å·</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">logheader</span> <span class="title">lh</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">log</span> <span class="title">log</span>;</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>æ—¥å¿—å°è£…</strong></p></blockquote><p>â€‹ å¦‚å‰é¢çš„æ—¥å¿—ä»‹ç»ï¼Œxv6å°†å¯¹äºç£ç›˜çš„å¤šæ¬¡äº¤äº’æ“ä½œå°è£…ä¸º<strong>æ—¥å¿—äº‹åŠ¡</strong>ï¼Œä¿å­˜è¯»å†™çš„åŸå­æ€§ï¼Œåœ¨xv6ä¸­å°±ä½¿ç”¨äº†ä¸¤ä¸ªæ¥å£å®ç°äº‹åŠ¡çš„å°è£…ï¼š</p><p><strong>begin_op</strong>ï¼šåœ¨è¿›è¡Œç£ç›˜è¯»å†™å‰è°ƒç”¨ï¼Œä¸å¹¶å‘æ“ä½œä¸­ä¸ºä¿æŠ¤å…³é”®åŒºçš„åŠ é”ä¸€æ ·ã€‚è°ƒç”¨<code>begin_op</code>ä¼šè¿›å…¥æ­»å¾ªç¯ï¼Œè¿™æ—¶è¿›ç¨‹ä¼šå¤„äºä¸¤ç§çŠ¶æ€ï¼š</p><ol><li><strong>sleepç­‰å¾…</strong>ï¼š(1).å½“å¦ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨æäº¤æ—¶éœ€è¦å°†å½“å‰äº‹åŠ¡è¿›ç¨‹ä¼‘çœ ã€(2).å½“æ—¥å¿—å—çš„ç©ºé—´æ»¡çš„æ—¶å€™éœ€è¦ä¼‘çœ ï¼Œé¿å…æ—¥å¿—å—çš„ç©ºé—´è¢«è¦†å†™ã€‚åªæœ‰å½“å¦ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨<code>wakeup</code>æ‰§è¡Œçš„æ—¶å€™ï¼Œè¯¥äº‹åŠ¡æ‰å¯èƒ½ä¼šè¢«å”¤é†’ï¼Œå¹¶å¾€ä¸‹æ‰§è¡Œæ“ä½œã€‚</li><li><strong>æ‰§è¡Œäº‹åŠ¡</strong>ï¼šå¢åŠ outstandingçš„æ•°é‡é‡Šæ”¾logé”ï¼Œè·³å‡ºæ­»å¾ªç¯ï¼Œæ­£å¸¸æ‰§è¡Œç£ç›˜è¯»å†™æ“ä½œã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">begin_op</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  acquire(&amp;<span class="built_in">log</span>.lock);</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">log</span>.committing)&#123;<span class="comment">//æœ‰æ—¥å¿—äº‹åŠ¡æ­£åœ¨æäº¤ï¼Œåæ¥çš„äº‹åŠ¡ç­‰å¾…</span></span><br><span class="line">      sleep(&amp;<span class="built_in">log</span>, &amp;<span class="built_in">log</span>.lock);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">log</span>.lh.n + (<span class="built_in">log</span>.outstanding+<span class="number">1</span>)*MAXOPBLOCKS &gt; LOGSIZE)&#123;</span><br><span class="line">      <span class="comment">//æ—¥å¿—å—çš„ç©ºé—´å·²æ»¡ï¼Œç­‰å¾…æ—¥å¿—æäº¤ã€‚</span></span><br><span class="line">      <span class="comment">//åœ¨è¿™é‡Œå°±è¡¨ç¤ºï¼Œlogç³»ç»Ÿåªæ»¡è¶³ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶å¹¶å‘</span></span><br><span class="line">      <span class="comment">//åæ¥çš„ç¬¬ä¸‰ä¸ªä»¥åŠåæ¥çš„æ‰§è¡Œçš„äº‹åŠ¡éœ€è¦ä¼‘çœ ç­‰å¾…</span></span><br><span class="line">      sleep(&amp;<span class="built_in">log</span>, &amp;<span class="built_in">log</span>.lock);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//å¢åŠ outstading</span></span><br><span class="line">      <span class="built_in">log</span>.outstanding += <span class="number">1</span>;</span><br><span class="line">      release(&amp;<span class="built_in">log</span>.lock);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>end_op</strong>ï¼šå½“ç£ç›˜è¯»å†™æ“ä½œæ‰§è¡Œå®Œæ¯•åï¼Œè°ƒç”¨end_opç›¸å½“äºé‡Šæ”¾é”çš„æ“ä½œï¼Œæ­¤æ—¶å°†<code>outstanding-1</code>ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¼€å§‹æäº¤äº‹åŠ¡ã€‚end_opè°ƒç”¨æ—¶åŒæ ·æœ‰ä¸¤ç§çŠ¶æ€ï¼š</p><ol><li><p><code>outstading==0</code>ï¼šè¯´æ˜æ—¥å¿—ç»“æŸæ—¶ï¼Œlogç³»ç»Ÿå½“å‰è¿›ç¨‹åœ¨è¿›è¡Œäº‹åŠ¡æ“ä½œå¹¶ç»“æŸï¼Œé‚£ä¹ˆæ­¤æ—¶å°±å¯ä»¥è¿›è¡Œ<strong>äº‹åŠ¡æäº¤</strong>æ“ä½œã€‚</p></li><li><p><code>outstading!=0</code>ï¼šè¯´æ˜åœ¨æ—¥å¿—ç³»ç»Ÿä¸­ï¼ŒåŒæ—¶æœ‰ä¸¤ä¸ªè¿›ç¨‹åœ¨è¿›è¡Œlogäº‹åŠ¡æ“ä½œï¼Œä¸€ä¸ªäº‹åŠ¡ç»“æŸçš„æ—¶å€™ï¼Œ<code>outstading!=0</code>å°±è¯´æ˜å¦ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆå½“å‰äº‹åŠ¡å°±ä¸èƒ½æäº¤(ä¸»è¦åŸå› æ˜¯ä¸ºäº†æé«˜logå—çš„åˆ©ç”¨ç‡)ã€‚æ¥ç€ä¾¿å”¤é†’(wakeup)ä¼‘çœ è¿›ç¨‹ï¼Œå› ä¸ºå¦‚æœè¿˜æœ‰è¿›ç¨‹åœ¨<code>begin_op</code>ç­‰å¾…ï¼Œå¹¶ä¸”<code>log.lh.n</code>çš„å€¼å°äº10ï¼Œé‚£ä¹ˆåœ¨begin_opä¼‘çœ çš„è¿›ç¨‹ä¾¿ä¼šè¢«å”¤é†’ã€‚å¦‚æœ<code>log.lh.n</code>å¤§äº10ï¼Œé‚£ä¹ˆä¼‘çœ çš„è¿›ç¨‹ä»ç„¶ä¼šä¼‘çœ ï¼ŒæŒ‡å¯¼å½“å‰logäº‹åŠ¡æäº¤ã€‚</p></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">end_op</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> do_commit = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;<span class="built_in">log</span>.lock);</span><br><span class="line">  <span class="built_in">log</span>.outstanding -= <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">log</span>.committing)</span><br><span class="line">    panic(<span class="string">&quot;log.committing&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">log</span>.outstanding == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">//å‡†å¤‡æäº¤</span></span><br><span class="line">    do_commit = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">log</span>.committing = <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="comment">//å”¤é†’begin_opä¼‘çœ çš„è¿›ç¨‹</span></span><br><span class="line">    wakeup(&amp;<span class="built_in">log</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  release(&amp;<span class="built_in">log</span>.lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(do_commit)&#123;</span><br><span class="line">    commit();<span class="comment">//å°†å†…å­˜ä¸­çš„å†…å®¹å†™å…¥åˆ°æ—¥å¿—å—</span></span><br><span class="line">    acquire(&amp;<span class="built_in">log</span>.lock);</span><br><span class="line">    <span class="built_in">log</span>.committing = <span class="number">0</span>;</span><br><span class="line">    wakeup(&amp;<span class="built_in">log</span>);</span><br><span class="line">    release(&amp;<span class="built_in">log</span>.lock);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Q1</strong>ï¼šä¸ºä»€ä¹ˆ<code>log.lh.n&lt;10</code>çš„æ—¶å€™ï¼Œåœ¨begin_opä¼‘çœ çš„è¿›ç¨‹å°±ä¼šè¢«å”¤é†’å‘¢ï¼Ÿ</p><p><strong>A1</strong>ï¼šåœ¨<code>begin_op</code>æœ‰è¿™æ ·çš„åˆ¤æ–­<code>log.lh.n + (log.outstanding+1) * MAXOPBLOCKS &gt; LOGSIZE</code>ï¼Œå¯ä»¥ç”±æ­¤è®¡ç®—å¾—å‡ºï¼Œè™½ç„¶æ˜¯ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œå´æœ‰ä¸¤ä¸ªæŸç¼šï¼Œåªæœ‰å½“æ—¥å¿—å—å°‘äº10çš„æ—¶å€™ï¼Œæ‰èƒ½å¤Ÿæ”¯æŒä¸¤ä¸ªè¿›ç¨‹å¹¶å‘æ‰§è¡Œlogäº‹åŠ¡ã€‚</p><p><strong>Q2</strong>ï¼šä¸¤ä¸ªlogå¹¶å‘æ‰§è¡Œäº‹åŠ¡ï¼Œéš¾é“ä¸ä¼šè€—å°½logå—çš„ç©ºé—´å—ï¼Œä¾‹å¦‚ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶ä¿®æ”¹ç£ç›˜çš„15ä»¥ä¸Šçš„å—ï¼Ÿ</p><p><strong>A2</strong>ï¼šåœ¨writeç³»ç»Ÿè°ƒç”¨å‡½æ•°(kernel/file.c:filewrite)ä¸­ï¼Œä¸€æ¬¡äº‹åŠ¡ä¿®æ”¹ç£ç›˜å—çš„å¤§å°æœ‰æ‰€é™åˆ¶ï¼Œè¿™æ ·å°±ä¸ä¼šå¯¼è‡´ç©ºé—´è¢«è€—å°½ã€‚</p><blockquote><ol><li><strong>æ—¥å¿—å†™å…¥</strong></li></ol></blockquote><p>â€‹ ç”±äºæ—¥å¿—äº‹åŠ¡å­˜åœ¨ï¼Œxv6å°±ä¸èƒ½å¤Ÿç›´æ¥ä½¿ç”¨<code>bwrite</code>å°†<code>bcache</code>çš„ä¿®æ”¹æ•°æ®ç›´æ¥å†™å›ç£ç›˜å—ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ä½¿ç”¨<code>log_write()</code>å‡½æ•°ï¼šç®€å•æ¥è¯´å°±æ˜¯åœ¨logç»“æ„ä¸­è®°å½•ä¸‹ä¿®æ”¹çš„ç£ç›˜å—çš„ç¼–å·ã€‚</p><p>â€‹ è¿™æ ·åšçš„æ˜¯æ–¹ä¾¿åœ¨åç»­çš„<strong>æäº¤æ“ä½œ</strong>ä¸­æ–‡ä»¶ç³»ç»Ÿå°†bcacheä¸­å·²ä¿®æ”¹å—å…ˆä¿å­˜åˆ°ç£ç›˜logä¸­ï¼Œä¿è¯äº‹åŠ¡æ“ä½œçš„åŸå­æ€§ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// log_write() replaces bwrite(); a typical use is:</span></span><br><span class="line"><span class="comment">//   bp = bread(...)</span></span><br><span class="line"><span class="comment">//   modify bp-&gt;data[]</span></span><br><span class="line"><span class="comment">//   log_write(bp)</span></span><br><span class="line"><span class="comment">//   brelse(bp)</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">log_write</span><span class="params">(<span class="keyword">struct</span> buf *b)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;<span class="built_in">log</span>.lock);</span><br><span class="line">  <span class="comment">//å¼‚å¸¸æ£€æŸ¥</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">log</span>.lh.n &gt;= LOGSIZE || <span class="built_in">log</span>.lh.n &gt;= <span class="built_in">log</span>.size - <span class="number">1</span>)</span><br><span class="line">    panic(<span class="string">&quot;too big a transaction&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">log</span>.outstanding &lt; <span class="number">1</span>)</span><br><span class="line">    panic(<span class="string">&quot;log_write outside of trans&quot;</span>);</span><br><span class="line">  <span class="comment">//ç®€å•çš„æ“ä½œæ“ä½œ</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="built_in">log</span>.lh.n; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">log</span>.lh.block[i] == b-&gt;blockno)   <span class="comment">// log absorption</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">log</span>.lh.block[i] = b-&gt;blockno;</span><br><span class="line">  <span class="keyword">if</span> (i == <span class="built_in">log</span>.lh.n) &#123;  <span class="comment">// Add new block to log?</span></span><br><span class="line">    bpin(b);	<span class="comment">//å¢åŠ bufå¼•ç”¨</span></span><br><span class="line">    <span class="built_in">log</span>.lh.n++;</span><br><span class="line">  &#125;</span><br><span class="line">  release(&amp;<span class="built_in">log</span>.lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ol><li><strong>æäº¤æ“ä½œ</strong></li></ol></blockquote><p><code>commit</code>ï¼šåœ¨end_opä¸­ï¼Œä¼šè°ƒç”¨commitå‡½æ•°è¿›è¡Œäº‹åŠ¡æäº¤ï¼Œä¸»è¦çš„æµç¨‹å¦‚ä¸‹</p><ul><li><code>write_log</code>ï¼šå°†bcacheä¿®æ”¹çš„å—å†™å…¥åˆ°ç£ç›˜logå—ä¸Šã€‚</li><li><code>1-write_head</code>ï¼šå°†logæ•°æ®å¯¹è±¡å†™å›ç£ç›˜å—ï¼Œæ˜¯çœŸæ­£çš„<strong>æ—¥å¿—æäº¤ç‚¹</strong>ï¼ï¼ï¼</li><li><code>install_trans</code>ï¼šå°†ç£ç›˜logå—çš„æ•°æ®å†™å›ç›®æ ‡çš„ç£ç›˜å—ä¸Šã€‚</li><li><code>2-write_head</code>ï¼šæ¸…ç©ºå½“å‰logäº‹åŠ¡</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">commit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">log</span>.lh.n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    write_log();     <span class="comment">// Write modified blocks from cache to log</span></span><br><span class="line">    write_head();    <span class="comment">// Write header to disk -- the real commit</span></span><br><span class="line">    install_trans(<span class="number">0</span>); <span class="comment">// Now install writes to home locations</span></span><br><span class="line">    <span class="built_in">log</span>.lh.n = <span class="number">0</span>;</span><br><span class="line">    write_head();    <span class="comment">// Erase the transaction from the log</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>write_log</code>ï¼šè¿™ä¸ªå‡½æ•°å¹¶ä¸éš¾ï¼Œç†æ¸…<code>from</code>ä¸<code>to</code>ä¸¤ä¸ªbufçš„å«ä¹‰ã€‚</p><ul><li><strong>from</strong>ï¼šæ˜¯åœ¨bcacheä¸­ä¿å­˜çš„äº‹åŠ¡æ“ä½œä¸­ï¼Œå¯¹ç›®æ ‡ç£ç›˜å—å·²ä¿®æ”¹çš„æ•°æ®ã€‚</li><li><strong>to</strong>ï¼šæ˜¯ç£ç›˜logå—ï¼Œç¼–å·æ˜¯2-31ã€‚</li></ul><p>é‚£ä¹ˆè¿™é‡Œçš„æ„æ€ä¹Ÿå°±æ˜¯å°†å†…å­˜ä¿å­˜çš„å·²ä¿®æ”¹çš„ç£ç›˜å—ï¼Œå†™åˆ°ç£ç›˜logå—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Copy modified blocks from cache to log.</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">write_log</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> tail;</span><br><span class="line">  <span class="comment">//å°†bcacheå†…å­˜ä¸­ä¿å­˜çš„å¯¹æ•°æ®ä¿®æ”¹çš„æ•°æ®å…ˆå†™å…¥ç£ç›˜logå—</span></span><br><span class="line">  <span class="keyword">for</span> (tail = <span class="number">0</span>; tail &lt; <span class="built_in">log</span>.lh.n; tail++) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">to</span> =</span> bread(<span class="built_in">log</span>.dev, <span class="built_in">log</span>.start+tail+<span class="number">1</span>); <span class="comment">// log block</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">from</span> =</span> bread(<span class="built_in">log</span>.dev, <span class="built_in">log</span>.lh.block[tail]); <span class="comment">// cache block</span></span><br><span class="line">    memmove(to-&gt;data, from-&gt;data, BSIZE);</span><br><span class="line">    bwrite(to);  <span class="comment">// write the log</span></span><br><span class="line">    brelse(from);</span><br><span class="line">    brelse(to);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>write_head</code>ï¼šè¿™ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ªä½œç”¨ï¼Œå…ˆä»‹ç»ç¬¬ä¸€ä¸ªä½œç”¨ã€‚</p><ol><li>ä½œä¸º<strong>æäº¤ç‚¹</strong>ï¼šå°±æ˜¯å°†å†…å­˜ä¸­logæ•°æ®å¯¹è±¡çš„å†™å›ç£ç›˜å—2ï¼Œä¹Ÿå°±æ˜¯ç£ç›˜logå—çš„å¼€å§‹ç¼–å·ï¼Œä¸»è¦æ˜¯<code>logheader</code>ä¿å­˜çš„ç›®æ ‡ç£ç›˜å—çš„ç¼–å·ã€‚åœ¨ä¸‹è¿°ä»£ç å—ä¸­<strong>bwrite</strong>å°†logæ•°æ®å¯¹è±¡å†™å…¥logå—ï¼Œä¹Ÿå°±ä»£è¡¨çš„æ˜¯æ—¥å¿—äº‹åŠ¡çš„<strong>æäº¤ç‚¹</strong>ã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">write_head</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//è¯»å–ç£ç›˜ä¸Šçš„logheader</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">buf</span> =</span> bread(<span class="built_in">log</span>.dev, <span class="built_in">log</span>.start);</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">logheader</span> *<span class="title">hb</span> =</span> (<span class="keyword">struct</span> logheader *) (buf-&gt;data);</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  hb-&gt;n = <span class="built_in">log</span>.lh.n;</span><br><span class="line">  <span class="comment">//ä¿®æ”¹ç£ç›˜çš„logheaderå—ä¿å­˜çš„å†…å®¹</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="built_in">log</span>.lh.n; i++) &#123;</span><br><span class="line">    hb-&gt;block[i] = <span class="built_in">log</span>.lh.block[i];</span><br><span class="line">  &#125;</span><br><span class="line">  bwrite(buf); <span class="comment">// -&gt;commit pointï¼Œè¿™é‡Œæ‰æ˜¯çœŸæ­£çš„äº‹åŠ¡æäº¤ç‚¹</span></span><br><span class="line">  brelse(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹</p><p>â€‹ åœ¨<code>bwrite</code>å‘ç”Ÿå‰å‡ºç°crashï¼Œé‚£ä¹ˆæ•´ä¸ªäº‹åŠ¡å°±è§†ä¸ºæŠ¥åºŸï¼Œé‡å¯åä¹Ÿä¸èƒ½äº‹åŠ¡è¿˜åŸã€‚åœ¨å…¶ä¹‹åå‘ç”Ÿï¼Œé‚£ä¹ˆè¿™ä¸ªäº‹åŠ¡ä¹Ÿå°±ä»£è¡¨æˆåŠŸæ‰§è¡Œäº†ã€‚è¿™é‡Œä¹Ÿå°±å¾ˆå¥½çš„ä½“ç°äº†äº‹åŠ¡çš„<strong>åŸå­æ€§</strong>ã€‚</p><blockquote><ol><li><strong>å®‰è£…äº‹åŠ¡</strong></li></ol></blockquote><p>â€‹ <strong>install_trans</strong>ï¼šè¿™ä¸ªå‡½æ•°å‘ç”Ÿåœ¨æ—¥å¿—æäº¤ç‚¹ä¹‹åã€‚åœ¨äº‹åŠ¡æˆåŠŸæäº¤åï¼Œxv6å°±å¯ä»¥æ”¾å¿ƒçš„å°†logå—ä¸­ä¿å­˜çš„æ•°æ®å†™å›ç›®æ ‡ç£ç›˜å—äº†ã€‚ä¸‹è¿°ä»£ç ä¹Ÿå°±æ˜¯å°†ç£ç›˜logå—çš„æ•°æ®å†™å›ç›®æ ‡ç£ç›˜å—ï¼Œç†è§£èµ·æ¥ä¹Ÿååˆ†çš„ç®€å•ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">install_trans</span><span class="params">(<span class="type">int</span> recovering)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> tail;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (tail = <span class="number">0</span>; tail &lt; <span class="built_in">log</span>.lh.n; tail++) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">lbuf</span> =</span> bread(<span class="built_in">log</span>.dev, <span class="built_in">log</span>.start+tail+<span class="number">1</span>); <span class="comment">// read log block</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">dbuf</span> =</span> bread(<span class="built_in">log</span>.dev, <span class="built_in">log</span>.lh.block[tail]); <span class="comment">// read dst</span></span><br><span class="line">    memmove(dbuf-&gt;data, lbuf-&gt;data, BSIZE);  <span class="comment">// copy block to dst</span></span><br><span class="line">    bwrite(dbuf);  <span class="comment">// write dst to disk</span></span><br><span class="line">    <span class="keyword">if</span>(recovering == <span class="number">0</span>)</span><br><span class="line">      bunpin(dbuf);</span><br><span class="line">    brelse(lbuf);</span><br><span class="line">    brelse(dbuf);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ol><li><strong>æ¸…ç†æ—¥å¿—</strong></li></ol></blockquote><p><code>write_head</code>ï¼šè¿™é‡Œä»‹ç»å…¶ç¬¬äºŒä¸ªä½œç”¨</p><ol><li><strong>æ¸…ç†æ—¥å¿—</strong>ï¼šåœ¨è°ƒç”¨write_headå‰ï¼Œæˆ‘ä»¬é¦–å…ˆå°†<code>log.lh.n</code>é‡ç½®ä¸º0ï¼Œé‚£ä¹ˆå°±ä»£è¡¨ç£ç›˜å—2ä¸­ä¿å­˜çš„logheadrçš„nå­—æ®µä¹Ÿè¢«ç½®ä¸º0ï¼Œé‚£ä¹ˆè¿™é‡Œ<code>write_header</code>ä½œç”¨å°±æ˜¯ï¼Œé˜²æ­¢åœ¨æ­¤åå‘ç”Ÿcrashåï¼Œxv6é‡å¯ååˆé‡æ–°å®‰è£…æ—¥å¿—ã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">commit</span><span class="params">()</span></span><br><span class="line">&#123; </span><br><span class="line">  ....</span><br><span class="line">  install_trans(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">log</span>.lh.n = <span class="number">0</span>;</span><br><span class="line">  write_head();    <span class="comment">// Erase the transaction from the log</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">write_head</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">buf</span> =</span> bread(<span class="built_in">log</span>.dev, <span class="built_in">log</span>.start);</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">logheader</span> *<span class="title">hb</span> =</span> (<span class="keyword">struct</span> logheader *) (buf-&gt;data);</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  hb-&gt;n = <span class="built_in">log</span>.lh.n;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="built_in">log</span>.lh.n; i++) &#123;</span><br><span class="line">    hb-&gt;block[i] = <span class="built_in">log</span>.lh.block[i];</span><br><span class="line">  &#125;</span><br><span class="line">  bwrite(buf);</span><br><span class="line">  brelse(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>crashæ¢å¤</strong></p></blockquote><p>â€‹ å½“xv6é­é‡crashæ—¶ï¼Œé‚£ä¹ˆåœ¨é‡å¯xv6æ—¶å°±ä¼šé‡æ–°è¯»å–ç£ç›˜logå—ï¼Œé‡æ–°å®‰è£…æ—¥å¿—å¹¶å°†æ¸…é™¤æ—¥å¿—å¤´ä¿å­˜çš„å†…å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">recover_from_log</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  read_head();<span class="comment">//é‡æ–°è¯»å–ç£ç›˜logå—çš„æ‰€æœ‰æ•°æ®</span></span><br><span class="line">  install_trans(<span class="number">1</span>); <span class="comment">//å¦‚æœåœ¨crashå‰å·²ç»æ­£åœ¨æäº¤é‚£ä¹ˆå°±å®‰è£…æ—¥å¿—</span></span><br><span class="line">  <span class="built_in">log</span>.lh.n = <span class="number">0</span>;</span><br><span class="line">  write_head(); <span class="comment">// æ¸…ç©ºlogå—</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Inode-layer"><a href="#Inode-layer" class="headerlink" title="Inode layer"></a>Inode layer</h1><h2 id="ç®€ä»‹-3"><a href="#ç®€ä»‹-3" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><blockquote><p><strong>inodeå¸ƒå±€</strong></p></blockquote><p>inodeæ˜¯æ–‡ä»¶ç³»ç»Ÿçš„<strong>æœ¯è¯­</strong>ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªç›¸å…³çš„æ„æ€ï¼š</p><ul><li>æŒ‡åŒ…å«æ–‡ä»¶å¤§å°å’Œæ•°æ®å—çš„ç¼–å·ï¼Œåœ¨ç£ç›˜ä¸Š(on-disk)çš„<strong>æ•°æ®ç»“æ„</strong>ã€‚</li><li>æŒ‡åŒ…å«ç£ç›˜inodeå’Œé¢å¤–çš„å†…æ ¸ä¿¡æ¯ï¼Œåœ¨å†…å­˜(in-memory)ä¸Šçš„<strong>æ•°æ®ç»“æ„</strong>ã€‚</li></ul><p>â€‹ åœ¨xv6ç£ç›˜çš„å¸ƒå±€å›¾ä¸­ï¼Œinodeæ˜¯32-45åœ¨ç£ç›˜ä¸Šçš„14ä¸ªè¿ç»­çš„å—ã€‚æ¯ä¸ªinodeæœ‰å›ºå®šçš„å¤§å°64å­—èŠ‚ï¼Œä¸€ä¸ªç£ç›˜å—æœ‰16ä¸ªinode(<code>1024/64</code> )ã€‚é‚£ä¹ˆç»™å®šä¸€ä¸ªinodeå·(i-numberæˆ–inode-number)ï¼Œç³»ç»Ÿå°±å¯ä»¥è®¡ç®—å¾—åˆ°inodeæ‰€åœ¨çš„ç£ç›˜å—çš„ç¼–å·ã€‚åœ¨xv6ä¸­å…¬å¼ä¸ºï¼š$32+x/16$ï¼Œä¾‹å¦‚ï¼Œi-number=17ï¼Œé‚£ä¹ˆæ‰€åœ¨çš„blockå°±ä¸º$32+17/16= 33$ã€‚</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/fs.png" alt="fs"></p><blockquote><p><strong>on-disk inode</strong></p></blockquote><p>â€‹ <strong>on-disk inodeæ•°æ®ç»“æ„</strong>åŒ…å«çš„å†…å®¹å¦‚ï¼šæ–‡ä»¶å¤§å°ã€æ–‡ä»¶ç±»å‹(ç›®å½•ã€æ–‡ä»¶ã€ç‰¹æ®Šæ–‡ä»¶)ã€<strong>é“¾æ¥æ•°é‡</strong>(æŒ‡å‘inodeçš„ç›®å½•æ•°é‡)ã€æŒ‡å‘ç£ç›˜æ•°æ®å—çš„åœ°å€çš„æŒ‡é’ˆ(æœ‰ç›´æ¥ã€é—´æ¥åœ°å€ï¼Œå®é™…å°±æ˜¯ç£ç›˜å—ç¼–å·)ç­‰å…ƒæ•°æ®ã€‚ä»¥ä¸‹ä¾¿æ˜¯ç£ç›˜ä¸­ä¿å­˜çš„inodeç»“æ„ï¼Œxv6çš„å®ç°çœå»äº†æ–‡ä»¶åˆ›å»ºã€ä¿®æ”¹æ—¶é—´ç­‰ç­‰ä¿¡æ¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">----fs.h</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NDIRECT 12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NINDIRECT (BSIZE / sizeof(uint))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXFILE (NDIRECT + NINDIRECT)</span></span><br><span class="line"><span class="comment">// On-disk inode structure</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dinode</span> &#123;</span></span><br><span class="line">  <span class="type">short</span> type;           <span class="comment">// File type</span></span><br><span class="line">  <span class="type">short</span> major;          <span class="comment">// Major device number (T_DEVICE only)</span></span><br><span class="line">  <span class="type">short</span> minor;          <span class="comment">// Minor device number (T_DEVICE only)</span></span><br><span class="line">  <span class="type">short</span> nlink;          <span class="comment">// Number of links to inode in file system</span></span><br><span class="line">  uint size;            <span class="comment">// Size of file (bytes)</span></span><br><span class="line">  uint addrs[NDIRECT+<span class="number">1</span>];   <span class="comment">// Data block addresses</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>â€‹ xv6çš„inodeæœ‰12ä¸ªç›´æ¥åœ°å€æŒ‡å‘12ä¸ªæ•°æ®å—ï¼Œ1ä¸ªé—´æ¥åœ°å€æŒ‡å‘1ä¸ªå—(æ•°æ®å—)ï¼Œè¿™ä¸ªæ•°æ®å—åŒ…å«äº†256ä¸ªå—å·(<code>1024/4 = 256</code>ï¼Œé™¤4æ˜¯å› ä¸ºå—å·çš„æ•°æ®ç±»å‹ä¸ºuint32ï¼Œblock number)ã€‚ç”±æ­¤å¯ä»¥è®¡ç®—å¾—åˆ°xv6ä¸­å¯ä»¥å­˜å‚¨æ–‡ä»¶çš„å¤§å°æœ€å¤§ä¸º$(12 + 256) * 1024 = 268KB$ï¼Œç”±æ­¤å¯è§xv6ä¸­å¯ä»¥å®¹çº³çš„æ–‡ä»¶å¤§å°ç‰¹åˆ«çš„å°ã€‚ç°åœ¨inodeçš„åœ°å€å­—æ®µå¸ƒå±€å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/figure8.3.png" alt="figure8.3"></p><p>â€‹ åœ¨fså®éªŒä¸­ä¼šè¦æ±‚èƒ½å¤Ÿå­˜å‚¨å¤§æ–‡ä»¶ï¼Œè¶…è¿‡268KBã€‚å…·ä½“çš„å®ç°æ€è·¯ä¸ºä½¿ç”¨<strong>ä¸¤çº§é—´æ¥æŒ‡é’ˆ</strong>ï¼Œç±»ä¼¼äºä¸‰çº§é¡µè¡¨ä¸€æ ·ï¼Œå°±æ˜¯<strong>ä¸€çº§é—´æ¥åœ°å€</strong>(inodeä¿å­˜çš„ä¸€ä¸ªé—´æ¥åœ°å€æŒ‡é’ˆ)æŒ‡å‘ä¿å­˜çš„æ˜¯256ä¸ª<strong>äºŒçº§é—´æ¥åœ°å€</strong>çš„å—ï¼Œæ¯ä¸ªäºŒçº§é—´æ¥åœ°å€æŒ‡å‘ä¸€ä¸ªä¿å­˜256ä¸ªå—å·(uint32æ— ç¬¦å·æ•´æ•°æŒ‡å‘æ•°æ®å—ï¼Œblock number)çš„æ•°æ®å—ï¼Œå…·ä½“çš„æŒ‡å‘å¦‚ä¸‹å›¾ã€‚åœ¨è¯¥å®éªŒä¸­å°±ä¼šå®ç°å‰11ä¸ªæŒ‡é’ˆä¸ºç›´æ¥åœ°å€ï¼Œç¬¬12ä¸ªä¸ºä¸€çº§é—´æ¥æŒ‡é’ˆï¼Œç¬¬13ä¸ªä½äºŒçº§é—´æ¥æŒ‡é’ˆï¼Œé‚£ä¹ˆæ­¤æ—¶å¯ä»¥å®¹çº³æœ€å¤§çš„æ–‡ä»¶å¤§å°ä¸º$(11 + 256 + 256 <em>256)</em> 1024 = 64MB + 12KB $ã€‚</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/2level_inode.png" alt="2level_inode"></p><p>é‚£ä¹ˆç°ä»£æ“ä½œç³»ç»Ÿä¸‹å¯ä»¥ä¿å­˜å‡ åä¸ªGBçš„æ–‡ä»¶ï¼Œé‚£ä¹ˆinodeçš„åœ°å€å­—æ®µåˆè¯¥å¦‚ä½•è®¾ç½®å‘¢ï¼Ÿæ²¡é”™å°±è¦ä½¿ç”¨<strong>ä¸‰çº§æŒ‡é’ˆ</strong>ï¼Œè¿™æ ·ä¹Ÿå’Œä¸‰çº§é¡µè¡¨æ›´ç›¸ä¼¼äº†ã€‚</p><blockquote><p><strong>inodeé”è®¾è®¡</strong></p></blockquote><p>åœ¨xv6ä¸­å®ç°äº†ä¸¤ç§inodeé”å’Œä¸¤ä¸ªé”é£æ ¼çš„æœºåˆ¶ç”¨äºä¿æŠ¤inodeç»“æ„ã€‚</p><ul><li><strong>itable.lock</strong>ï¼Œæ˜¯è‡ªæ—‹é”ï¼Œä¿æŠ¤inodeå†…å­˜è¡¨ä¸­æœ€å¤šå‡ºç°ä¸€æ¬¡inodeçš„ä¸å˜é‡(å†…å­˜inodeçš„<strong>ref</strong>å­—æ®µï¼Œè®°å½•å†…å­˜ä¸­æœ‰å¤šå°‘ä¸ªæŒ‡é’ˆæŒ‡å‘è¯¥inode)</li><li><strong>inode.lock</strong>ï¼Œæ˜¯ç¡çœ é”ï¼Œæ¯ä¸€ä¸ªinodeéƒ½æœ‰ä¸€ä¸ªè¿™æ ·çš„é”ï¼Œç¡®ä¿ç‹¬å çš„è®¿é—®inodeçš„å­—æ®µ(å¦‚é•¿åº¦)å’ŒinodeæŒ‡å‘çš„æ–‡ä»¶æˆ–ç›®å½•å†…å®¹ã€‚ç¡çœ é”å¯ä»¥å¾ˆå¥½äº†è§£æ”¾CPUå ç”¨é—®é¢˜ã€‚</li><li><strong>refå­—æ®µ</strong>ï¼Œè®°å½•å¼•ç”¨è¯¥æ–‡ä»¶çš„è¿›ç¨‹æ•°ï¼Œå¦‚æœ<code>ref&gt;0</code>ï¼Œ<code>inode</code>ä¼šç»§ç»­ä¿å­˜åœ¨<code>itable</code>ä¸­ï¼Œå¹¶ä¸”ä¸ä¼šå°†è¯¥<code>itable</code>çš„æ¡ç›®ç”¨äºå…¶ä»–<code>inode</code>ã€‚</li><li><strong>nlinkå­—æ®µ</strong>ï¼Œç”¨äºè®¡ç®—ç›®å½•çš„æ–‡ä»¶(å¦‚ä¸åŒç›®å½•è·¯å¾„ä¸‹å¼•ç”¨çš„è¿™ä¸ªæ–‡ä»¶)æŒ‡å‘è¯¥æ–‡ä»¶çš„<strong>æ¡ç›®æ•°</strong>ï¼ŒåŒæ ·çš„<code>nlink&gt;0</code>ï¼Œ<code>inode</code>ä¼šæ¥ç»­ä¿å­˜åœ¨<code>itable</code>ä¸­ã€‚</li></ul><p>â€‹ ä»¥ä¸‹ä¾¿æ˜¯itableçš„ç»“æ„ï¼Œè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå°±æ˜¯ä¸€ä¸ªinodeæ•°ç»„å’Œè‡ªæ—‹é”è€Œå·²ï¼Œç”±äºitableä¿å­˜äºå†…å­˜ä¸­ï¼Œå…¶ä¿å­˜çš„inodeæ•°é‡åªæœ‰50ä¸ªï¼Œæ˜¯å°‘äºç£ç›˜ä¿å­˜çš„inodeæ•°çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">----fs.h</span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> <span class="title">inode</span>[<span class="title">NINODE</span>];</span></span><br><span class="line">&#125; itable;</span><br></pre></td></tr></table></figure><h2 id="ä»£ç ï¼šBlock-allocator"><a href="#ä»£ç ï¼šBlock-allocator" class="headerlink" title="ä»£ç ï¼šBlock allocator"></a>ä»£ç ï¼šBlock allocator</h2><blockquote><p><strong>å—åˆ†é…å™¨</strong>çš„ç›¸å…³æ“ä½œï¼š</p></blockquote><p>â€‹ å—åˆ†é…å™¨æä¾›äº†ä¸¤ä¸ªå‡½æ•°ç”¨äºæ“ä½œç©ºé—²æ± ï¼š</p><p><strong>bfree</strong>ï¼šé‡Šæ”¾ç£ç›˜å—ï¼Œè®¾ç½®bitmapï¼Œæ ‡è®°æŒ‡å®šç£ç›˜å—ä½ç©ºé—²ï¼š</p><ol><li>ä½¿ç”¨<code>bread</code>é€šè¿‡inodeè¯»å–æ–‡ä»¶çš„ç£ç›˜ä¸Š<strong>bitmapå—</strong>ï¼Œå¹¶ç¼“å­˜äº†buffer cacheçš„èŠ‚ç‚¹</li><li>æ›´æ”¹<strong>bmapå—</strong>çš„æŒ‡å®šæ–‡ä»¶æ•°æ®å—å·çš„ä½çš„å€¼ï¼Œå°†æŒ‡å®šä½è®¾ç½®ä¸º9ã€‚ä¾‹å¦‚è¦åˆ é™¤<code>block number = 60</code>çš„å—ï¼Œåªéœ€è¦å°†ç¬¬ä¸€ä¸ª<code>bitmap</code>å—(<code>60/(1024*80) = 0</code>ï¼Œä½¿ç”¨<strong>BBLOCK</strong>è®¡ç®—)ä¸Šï¼Œç¬¬8ä¸ªå­—èŠ‚(<code>60/8 = 7</code>ï¼Œä½¿ç”¨<strong>BPB</strong>è®¡ç®—ï¼Œå­—ç¬¦æ•°ç»„ä»0å¼€å§‹è®¡æ•°)ï¼Œå°†ç¬¬8ä¸ªå­—èŠ‚ä¸Šçš„ç¬¬5ä¸ªä½(<code>60%8 = 4</code>ï¼ŒåŒæ ·æ˜¯ä»0å¼€å§‹)ï¼Œè®¾ç½®ä¸º0å°±å¯ä»¥äº†ã€‚</li><li>è°ƒç”¨<code>log_write</code>ï¼Œå°†è¯¥inodeå—çš„å†™å…¥æ“ä½œæ·»åŠ åˆ°log headerã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">----fs.h</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BSIZE 		  1024</span></span><br><span class="line"><span class="comment">//è®¡ç®—å¾—å‡ºbitmapç£ç›˜çš„ç¼–å·</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BBLOCK(b, sb) ((b)/BPB + sb.bmapstart)</span></span><br><span class="line"><span class="comment">//ä¸€ä¸ªå­—èŠ‚8ä½ï¼Œå¯ä»¥æ ‡è¯†1024 * 8 ä¸ªæ•°æ®å—</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPB           (BSIZE*8)</span></span><br><span class="line">----fs.c</span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">bfree</span><span class="params">(<span class="type">int</span> dev, uint b)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">bp</span>;</span></span><br><span class="line">  <span class="type">int</span> bi, m;</span><br><span class="line">  </span><br><span class="line">  bp = bread(dev, BBLOCK(b, sb));</span><br><span class="line">  <span class="comment">//è·å–æ•°æ®å—å·çš„å¤„äºçš„ä½æ•°</span></span><br><span class="line">  bi = b % BPB;</span><br><span class="line">  <span class="comment">//æ ‡è®°åˆ°ä¸€ä¸ªå­—èŠ‚ä¸­</span></span><br><span class="line">  m = <span class="number">1</span> &lt;&lt; (bi % <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">if</span>((bp-&gt;data[bi/<span class="number">8</span>] &amp; m) == <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;freeing free block&quot;</span>);</span><br><span class="line">  bp-&gt;data[bi/<span class="number">8</span>] &amp;= ~m;<span class="comment">//å°†æŒ‡å®šbitmapå­—èŠ‚ä¸Šçš„æ•°æ®å—ä½è®¾ç½®ä¸º0</span></span><br><span class="line">  log_write(bp);</span><br><span class="line">  brelse(bp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹</p><p><strong>balloc</strong>ï¼šåˆ†é…ç£ç›˜å—ï¼Œè®¾ç½®bitmapï¼Œæ ‡è®°æŒ‡å®šç£ç›˜å—å·²åˆ†é…ï¼š</p><p>è¿™ä¸ªå‡½æ•°äº<code>bfree</code>å‡½æ•°çš„å®ç°æ€è·¯ç›¸åŒï¼Œéƒ½æ˜¯æ“ä½œ<strong>bitmapå—</strong>ï¼Œåªä¸è¿‡æ•ˆæœæ˜¯ç›¸åçš„ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šé˜è¿°äº†ã€‚</p><h2 id="ä»£ç ï¼šInodeåˆ†é…"><a href="#ä»£ç ï¼šInodeåˆ†é…" class="headerlink" title="ä»£ç ï¼šInodeåˆ†é…"></a>ä»£ç ï¼šInodeåˆ†é…</h2><blockquote><p><strong>in-memory inode</strong></p></blockquote><p>åœ¨buffer cacheä¸­ä¿å­˜çš„inodeå—æ˜¯ç›´æ¥æ‹·è´çš„ç£ç›˜ä¸Šçš„inodeå—ï¼Œä½†æ˜¯åœ¨ä¸ºäº†æ–¹ä¾¿<strong>å¹¶å‘æ§åˆ¶</strong>ä»¥åŠinodeæ•°æ®æ“ä½œï¼Œxv6ä¸­è®¾è®¡inodeå±‚ä¸Šä½¿ç”¨çš„inodeç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œæ·»åŠ äº†ä¸€äº›å­—æ®µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">----file.h</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> &#123;</span></span><br><span class="line">  uint dev;           <span class="comment">// ç£ç›˜è®¾å¤‡ç¼–å·</span></span><br><span class="line">  uint inum;          <span class="comment">// Inodeç¼–å·</span></span><br><span class="line">  <span class="type">int</span> ref;            <span class="comment">// å¼•ç”¨è®¡æ•°ï¼Œæœ‰å¤šå°‘è¿›ç¨‹ä½¿ç”¨è¯¥inode</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sleeplock</span> <span class="title">lock</span>;</span> <span class="comment">//åŒ…å«inodeçš„ä¸å˜é‡</span></span><br><span class="line">  <span class="type">int</span> valid;          <span class="comment">// inodeæ˜¯å¦å·²ç»ä»ç£ç›˜ä¸Šè¯»å–</span></span><br><span class="line">  <span class="comment">//ä»¥ä¸‹å­—æ®µæ˜¯å®Œå…¨æ‹·è´äºç£ç›˜inodeå—</span></span><br><span class="line">  <span class="type">short</span> type;         <span class="comment">// copy of disk inode</span></span><br><span class="line">  <span class="type">short</span> major;</span><br><span class="line">  <span class="type">short</span> minor;</span><br><span class="line">  <span class="type">short</span> nlink;</span><br><span class="line">  uint size;</span><br><span class="line">  uint addrs[NDIRECT+<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p><strong>åˆ†é…æ–°çš„indoe</strong></p></blockquote><p>â€‹ é¦–å…ˆxv6è°ƒç”¨<code>ialloc</code>ï¼Œè¿™ä¸ªå‡½æ•°ä¸<code>balloc</code>ç›¸åŒï¼šå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œéå†ç£ç›˜ä¸Šçš„æ‰€æœ‰inodeèŠ‚ç‚¹ï¼Œå¯»æ‰¾åˆ°ç©ºé—²çš„inodeåï¼Œå†™å…¥inodeç±»å‹åˆ°ç£ç›˜ï¼Œç„¶åé€šè¿‡è°ƒç”¨<code>iget</code>ä»inodeè¡¨ä¸­è¿”å›ä¸€ä¸ªæ¡ç›®ã€‚<code>ialloc</code>å¿…é¡»ç¡®å®šåªæœ‰ä¸€ä¸ªè¿›ç¨‹æŒæœ‰å¯¹<code>bp</code>çš„å¼•ç”¨ï¼Œå¹¶ä¸”è¦ç¡®å®šè¿™ä¸ªè¿‡ç¨‹çš„<strong>åŸå­æ€§</strong>ï¼Œä¸èƒ½åŒæ—¶çš„è¢«å…¶ä»–è¿›ç¨‹çœ‹è§è¿™ä¸ªinodeæ˜¯å¯è·å–çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">----fs.h</span><br><span class="line"><span class="comment">// Inodes per block.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IPB           (BSIZE / sizeof(struct dinode))</span></span><br><span class="line"><span class="comment">// Block containing inode i</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IBLOCK(i, sb)     ((i) / IPB + sb.inodestart)</span></span><br><span class="line">----fs.c</span><br><span class="line"><span class="keyword">struct</span> inode*</span><br><span class="line"><span class="title function_">ialloc</span><span class="params">(uint dev, <span class="type">short</span> type)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> inum;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">bp</span>;</span></span><br><span class="line">  <span class="comment">//buffer cacheä¿å­˜çš„inodeå—çš„ç»“æ„æ˜¯ç£ç›˜ä¸Šçš„ç»“æ„</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dinode</span> *<span class="title">dip</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(inum = <span class="number">1</span>; inum &lt; sb.ninodes; inum++)&#123;</span><br><span class="line">    bp = bread(dev, IBLOCK(inum, sb));</span><br><span class="line">    <span class="comment">//bp-&gt;dataå­—æ®µä¿å­˜çš„æ˜¯ä¸€ä¸ªinodeç£ç›˜å—</span></span><br><span class="line">    <span class="comment">//åŠ inum%IPBå°±èƒ½æ‰¾åˆ°æŒ‡å®šçš„ç£ç›˜å—ä¸Šçš„inode</span></span><br><span class="line">    dip = (<span class="keyword">struct</span> dinode*)bp-&gt;data + inum%IPB;</span><br><span class="line">    <span class="keyword">if</span>(dip-&gt;type == <span class="number">0</span>)&#123;  <span class="comment">// a free inode</span></span><br><span class="line">      <span class="built_in">memset</span>(dip, <span class="number">0</span>, <span class="keyword">sizeof</span>(*dip));</span><br><span class="line">      dip-&gt;type = type;</span><br><span class="line">      log_write(bp);   <span class="comment">// mark it allocated on the disk</span></span><br><span class="line">      brelse(bp);</span><br><span class="line">      <span class="keyword">return</span> iget(dev, inum);</span><br><span class="line">    &#125;</span><br><span class="line">    brelse(bp);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;ialloc: no inodes\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹ æ¥ç€çœ‹çœ‹å¦‚ä½•é€šè¿‡<code>iget</code>å°†ç©ºé—²çš„inodeåŠ å…¥inodeè¡¨(å†…å­˜çš„ä¿å­˜çš„ç»“æ„)ã€‚é¦–å…ˆéå†æ•´ä¸ªinodeè¡¨ï¼Œå¦‚æœè¿™ä¸ªinodeä»¥åŠå­˜åœ¨(<code>ip-&gt;ref&gt;0</code>)äºinodeè¡¨ä¸­åˆ™æ·»åŠ å¼•ç”¨è®¡æ•°ï¼Œå¹¶å°†å…¶inodeè¿”å›ï¼Œåä¹‹å°†è®°å½•ä¸€ä¸ªç©ºé—²inodeï¼Œé€€å‡ºå¾ªç¯åï¼Œåˆ†é…inodeè¡¨ä¸­è¿™ä¸ªinodeæ§½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">----fs.c</span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> inode*</span><br><span class="line"><span class="title function_">iget</span><span class="params">(uint dev, uint inum)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">ip</span>, *<span class="title">empty</span>;</span></span><br><span class="line"></span><br><span class="line">  acquire(&amp;itable.lock);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Is the inode already in the table?</span></span><br><span class="line">  empty = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(ip = &amp;itable.inode[<span class="number">0</span>]; ip &lt; &amp;itable.inode[NINODE]; ip++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(ip-&gt;ref &gt; <span class="number">0</span> &amp;&amp; ip-&gt;dev == dev &amp;&amp; ip-&gt;inum == inum)&#123;</span><br><span class="line">      ip-&gt;ref++;</span><br><span class="line">      release(&amp;itable.lock);</span><br><span class="line">      <span class="keyword">return</span> ip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(empty == <span class="number">0</span> &amp;&amp; ip-&gt;ref == <span class="number">0</span>)    <span class="comment">// Remember empty slot.</span></span><br><span class="line">      empty = ip;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Recycle an inode entry.</span></span><br><span class="line">  <span class="keyword">if</span>(empty == <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;iget: no inodes&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//write info to itable&#x27;s inode entry</span></span><br><span class="line">  ....</span><br><span class="line"></span><br><span class="line">  release(&amp;itable.lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ip;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹ ä»¥ä¸Šè¿‡ç¨‹ä¾¿æ˜¯<code>ialloc</code>åˆ†é…iallocè¿‡ç¨‹ï¼Œï¼Œå°†ç£ç›˜çš„inodeå—è¯»å–åˆ°<code>buffer cache</code>ä¸­ï¼Œå¹¶ä»<code>buffer cache</code>è·å–ä¸€ä¸ªç©ºé—²inodeï¼Œå°†å…¶è®°å½•åˆ°inodeè¡¨ä¸­ï¼Œå¹¶è¿”å›è¿™ä¸ªinodeåœ°å€ã€‚</p><p>â€‹ å¦‚æœä½ çœ‹è¿‡åˆ›å»ºæ–‡ä»¶çš„ä»£ç åï¼Œå°±å¯ä»¥çŸ¥é“åœ¨ç”¨æˆ·ä½¿ç”¨<code>open</code>ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œè¿›å…¥å†…æ ¸ä¾¿ä¼šè°ƒç”¨<code>create</code>åˆ›å»ºæ–‡ä»¶ï¼Œæ¥ç€ä¼šè°ƒç”¨<code>ialloc</code>ä¸ºè¯¥æ–‡ä»¶åˆ†é…inodeã€‚</p><blockquote><p><strong>inodeé”</strong></p></blockquote><p>åœ¨è¯»å–æˆ–å†™å…¥inodeçš„å…ƒæ•°æ®æˆ–å†…å®¹ä¹‹å‰ï¼Œå¿…é¡»ä½¿ç”¨é”æ¥é¢„é˜²æ•°æ®ç«äº‰ã€‚inodeé”çš„ä½¿ç”¨æ–¹å¼æ˜¯<code>ilock</code>ä¸<code>unilock</code>ã€‚</p><ul><li><p><code>ilock</code>ä½¿ç”¨ç¡çœ é”(sleep-lock)ä¿æŠ¤inodeã€‚ä¸€æ—¦ilockç‹¬å çš„è®¿é—®inodeï¼Œå¦‚æœéœ€è¦å°±å¯ä»¥<strong>å‘ç£ç›˜è¯»å–</strong>(æ›´å¤šçš„æ˜¯å‘buffer cacheè¯»å–)inodeã€‚</p></li><li><p><code>iunlock</code>é‡Šæ”¾ç¡çœ é”ï¼Œå¯ä»¥è®©å”¤é†’ä¸€ä¸ªå› ç­‰å¾…è¯¥inodeèµ„æºçš„è¿›ç¨‹ã€‚</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">----fs.c</span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">ilock</span><span class="params">(<span class="keyword">struct</span> inode *ip)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">bp</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dinode</span> *<span class="title">dip</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(ip == <span class="number">0</span> || ip-&gt;ref &lt; <span class="number">1</span>)</span><br><span class="line">    panic(<span class="string">&quot;ilock&quot;</span>);</span><br><span class="line"></span><br><span class="line">  acquiresleep(&amp;ip-&gt;lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(ip-&gt;valid == <span class="number">0</span>)&#123;</span><br><span class="line">    bp = bread(ip-&gt;dev, IBLOCK(ip-&gt;inum, sb));</span><br><span class="line">	....<span class="comment">//è¯»å–buffer cacheï¼Œå¹¶æ›´æ–°inodeè¡¨ä¸­çš„inodeæ•°æ®</span></span><br><span class="line">    brelse(bp);</span><br><span class="line">    ip-&gt;valid = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(ip-&gt;type == <span class="number">0</span>)</span><br><span class="line">      panic(<span class="string">&quot;ilock: no type&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Unlock the given inode.</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">iunlock</span><span class="params">(<span class="keyword">struct</span> inode *ip)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>(ip == <span class="number">0</span> || !holdingsleep(&amp;ip-&gt;lock) || ip-&gt;ref &lt; <span class="number">1</span>)</span><br><span class="line">    panic(<span class="string">&quot;iunlock&quot;</span>);</span><br><span class="line"></span><br><span class="line">  releasesleep(&amp;ip-&gt;lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä»£ç ï¼šInodeé‡Šæ”¾"><a href="#ä»£ç ï¼šInodeé‡Šæ”¾" class="headerlink" title="ä»£ç ï¼šInodeé‡Šæ”¾"></a>ä»£ç ï¼šInodeé‡Šæ”¾</h2><blockquote><p><strong>iput</strong>ï¼šé‡Šæ”¾inode</p></blockquote><ul><li><code>iput</code>ï¼šå¦‚æœinodeæ²¡æœ‰å…¶ä»–æŒ‡é’ˆå¼•ç”¨(<code>ip-&gt;ref == 1)</code>å¹¶ä¸”æ²¡æœ‰ç›®å½•é“¾æ¥(<code>ip-&gt;nlink == 0</code>)ï¼Œè¿™ä¸ªå—å°†ä¼šè¢«é‡Šæ”¾ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">----fs.c</span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">iput</span><span class="params">(<span class="keyword">struct</span> inode *ip)</span></span><br><span class="line">&#123;</span><br><span class="line">  acquire(&amp;itable.lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(ip-&gt;ref == <span class="number">1</span> &amp;&amp; ip-&gt;valid &amp;&amp; ip-&gt;nlink == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">// ip-&gt;ref == 1 ä»£è¡¨æ²¡æœ‰å…¶ä»–è¿›ç¨‹å°†è¯¥inodeé”å®š</span></span><br><span class="line">    <span class="comment">// so this acquiresleep() won&#x27;t block (or deadlock).</span></span><br><span class="line">    acquiresleep(&amp;ip-&gt;lock);</span><br><span class="line"></span><br><span class="line">    release(&amp;itable.lock);</span><br><span class="line"></span><br><span class="line">    itrunc(ip);</span><br><span class="line">    ip-&gt;type = <span class="number">0</span>;</span><br><span class="line">    iupdate(ip);</span><br><span class="line">    ip-&gt;valid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    releasesleep(&amp;ip-&gt;lock);</span><br><span class="line"></span><br><span class="line">    acquire(&amp;itable.lock);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ip-&gt;ref--;</span><br><span class="line">  release(&amp;itable.lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>itruc</strong>ï¼šé‡Šæ”¾inodeæŒ‡å‘çš„æ–‡ä»¶æ•°æ®</p></blockquote><p><code>itrunc</code>ï¼šåœ¨iputä¸­ä¼šè°ƒç”¨è¯¥å‡½æ•°ï¼Œå°†æ–‡ä»¶<strong>æˆªæ–­</strong>ä¸º0å­—èŠ‚ï¼Œ<strong>é‡Šæ”¾æ•°æ®å—</strong>ï¼Œå°†inodeçš„<code>type</code>å­—æ®µè®¾ç½®ä¸º0(ä»£è¡¨è¯¥inodeæœªåˆ†é…)ï¼Œæœ€åå°†inodeå†™å›ç£ç›˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">----fs.c</span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">itrunc</span><span class="params">(<span class="keyword">struct</span> inode *ip)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i, j;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">bp</span>;</span></span><br><span class="line">  uint *a;</span><br><span class="line">  <span class="comment">//æŸ¥æ‰¾ç›´æ¥å¼•ç”¨çš„æ•°æ®å—è¿›è¡Œé‡Šæ”¾</span></span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; NDIRECT; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(ip-&gt;addrs[i])&#123;</span><br><span class="line">      bfree(ip-&gt;dev, ip-&gt;addrs[i]);</span><br><span class="line">      ip-&gt;addrs[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//æŸ¥æ‰¾é—´æ¥å¼•ç”¨çš„æ•°æ®å—è¿›è¡Œé‡Šæ”¾</span></span><br><span class="line">  <span class="keyword">if</span>(ip-&gt;addrs[NDIRECT])&#123;</span><br><span class="line">    bp = bread(ip-&gt;dev, ip-&gt;addrs[NDIRECT]);</span><br><span class="line">    a = (uint*)bp-&gt;data;</span><br><span class="line">    <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; NINDIRECT; j++)&#123;</span><br><span class="line">      <span class="keyword">if</span>(a[j])</span><br><span class="line">        bfree(ip-&gt;dev, a[j]);</span><br><span class="line">    &#125;</span><br><span class="line">    brelse(bp);</span><br><span class="line">    bfree(ip-&gt;dev, ip-&gt;addrs[NDIRECT]);</span><br><span class="line">    ip-&gt;addrs[NDIRECT] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ip-&gt;size = <span class="number">0</span>;</span><br><span class="line">  iupdate(ip);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>iput</strong>ï¼šé”ä¸ç±»ä¼¼äºé”çš„æœºåˆ¶</p></blockquote><p>æ¥ç€ç ”ç©¶<code>iput</code>æ˜¯å¦‚ä½•é‡Šæ”¾inodeé”å®šåè®®çš„ï¼Œä¸»è¦è¿ç”¨äº†ä¸¤ä¸ªé”å’Œä¸¤ä¸ªç±»ä¼¼äºé”çš„æœºåˆ¶æœºåˆ¶è§£å†³ã€‚</p><p>â€‹ é¦–å…ˆç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¹¶å‘çº¿ç¨‹ä¸ºäº†ä½¿ç”¨inodeå¯èƒ½ä¼šåœ¨<code>ilock</code>ç­‰å¾…ï¼Œå¹¶ä¸”æ²¡æœ‰å‘ç°è¿™ä¸ªinodeä¸ä¼šå†è¢«åˆ†é…ï¼Œå°±æ˜¯æ²¡æœ‰åœ¨å¹¶å‘çº¿ç¨‹çŸ¥é“çš„æƒ…å†µä¸‹é‡Šæ”¾äº†inodeï¼Œä½†æ˜¯è¿™ä¸ä¼šå‘ç”Ÿï¼Œä¸»è¦æ˜¯å› ä¸ºå¦‚æœinodeæ²¡æœ‰ç›®å½•é“¾æ¥(<code>ip-&gt;link == 0</code>)å¹¶ä¸”<code>ip-&gt;ref == 1</code>ï¼Œç³»ç»Ÿè°ƒç”¨æ²¡æœ‰æ–¹æ³•è·å–å†…å­˜inodeçš„æŒ‡é’ˆã€‚è€Œä¸”å”¯ä¸€çš„å¼•ç”¨è¿˜æ˜¯è°ƒç”¨<code>iput</code>çš„çº¿ç¨‹çš„å¼•ç”¨æ•°ï¼Œæ‰€ä»¥è°ƒç”¨iputä¹‹åæ£€æŸ¥<strong>inodeçš„å¼•ç”¨è®¡æ•°</strong>æ˜¯å¦åœ¨<code>itable.lock</code>çš„å…³é”®åŒºä¹‹å¤–ï¼Œä½†æ˜¯æ­¤æ—¶é“¾æ¥æ•°é‡ä¸º0ï¼Œæ‰€ä»¥è¯´æ˜æ²¡æœ‰å…¶ä»–çº¿ç¨‹å°è¯•è·å–è¿™ä¸ªinodeã€‚</p><p>â€‹ å¦ä¸€ä¸ªç‚¹æ˜¯ï¼Œå¹¶å‘è°ƒç”¨<code>ialloc</code>å¯èƒ½ä¼šé€‰æ‹©<strong>ç›¸åŒ</strong>çš„å¹¶ä¸”<strong>æ­£åœ¨</strong>è¢«<code>iput</code>é‡Šæ”¾çš„inodeï¼Œè¿™ä¸ªåªå¯èƒ½å‘ç”Ÿåœ¨<code>iupdate</code>å†™å…¥inodeåˆ°ç£ç›˜ä¹‹åï¼Œè¿™æ—¶inodeçš„typeå­—æ®µä¸º0ã€‚ä½†æ˜¯è¿™ä¸ªæ•°æ®ç«äº‰æ˜¯è‰¯æ€§çš„ï¼Œåˆ†é…inodeçš„çº¿ç¨‹åœ¨è¯»å–æˆ–å†™å…¥inodeä¹‹å‰ï¼Œä¼šç­‰å¾…ä»¥è·å–inodeçš„ç¡çœ é”ï¼Œç›´åˆ°<code>iput</code>é‡Šæ”¾ã€‚</p><p>â€‹ <code>iput</code>å¯ä»¥å†™å…¥ç£ç›˜ï¼Œè¿™ä¹Ÿå°±æ„å‘³è¿™ä»»ä½•ç³»ç»Ÿè°ƒç”¨ä¼šä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå†™å…¥ç£ç›˜ï¼Œå› ä¸ºç³»ç»Ÿè°ƒç”¨å¯èƒ½æ˜¯æœ€åä¸€ä¸ªæ–‡ä»¶å¼•ç”¨çš„è°ƒç”¨ã€‚<code>read</code>ç³»ç»Ÿè°ƒç”¨ä»¥åªè¯»çš„æ–¹å¼è¯»å–æ–‡ä»¶éƒ½ä¼šåœ¨ç»“æŸä¹‹å‰è°ƒç”¨<code>iput</code>ï¼Œè¿™å°±æ„å‘³åˆ™æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨å°†ä¼šå°è£…åˆ°äº‹åŠ¡ä¸­ã€‚</p><blockquote><p><strong>æŒ‘æˆ˜</strong>ï¼šcrashä¸iput</p></blockquote><p>â€‹ <strong>é—®é¢˜</strong>ï¼šcrashä¸iputçš„äº¤äº’æ˜¯ä¸€ä¸ªæŒ‘æˆ˜ï¼Œå› ä¸ºä¸€äº›è¿›ç¨‹å¯èƒ½æŒæœ‰å†…å­˜inodeçš„å¼•ç”¨ï¼Œæ‰€ä»¥iputå½“æ–‡ä»¶çš„é“¾æ¥æ•°ä¸º0æ—¶ä¹Ÿä¸ä¼šç«‹å³çš„æˆªæ–­ä¸€ä¸ªæ–‡ä»¶ã€‚ä½†æ˜¯å¦‚æœ<strong>crash</strong>å‘ç”Ÿåœ¨æœ€åä¸€ä¸ªè¿›ç¨‹å…³é—­æ–‡ä»¶æ–‡ä»¶æè¿°ç¬¦ä¹‹å‰ï¼Œç„¶åæ–‡ä»¶æ‰è¢«æ ‡è®°ï¼Œä½†è¯¥æ–‡ä»¶å·²ç»åˆ†é…åˆ°ç£ç›˜ä½†æ˜¯æ²¡æœ‰ç›®å½•æ¡ç›®æŒ‡å‘è¿™ä¸ªæ–‡ä»¶ï¼Œåœ¨å†…å­˜inodeå†™å›ç£ç›˜æ—¶crashï¼Œå°±ä¼šæœ‰ç£ç›˜ä¸­æœ‰æ®‹ç•™çš„æ–‡ä»¶æ•°æ®ã€‚</p><p>æ–‡ä»¶ç³»ç»Ÿè§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ol><li>ä»<strong>æ¢å¤</strong>(recovery)æ–¹å¼ä¸Šè§£å†³ï¼šåœ¨é‡å¯ä¹‹åï¼Œæ–‡ä»¶ç³»ç»Ÿæ‰«ææ•´ä¸ªå·²ç»æ ‡è®°åˆ†é…çš„æ–‡ä»¶ï¼Œä½†æ˜¯æ²¡æœ‰ç›®å½•æ¡ç›®æŒ‡å‘ï¼Œæ­¤æ—¶åªé‡æ–°ä¸ºæ–‡ä»¶æ·»åŠ ç›®å½•æ¡ç›®å°±å¯ä»¥äº†ã€‚</li><li>ä»<strong>é”æœºåˆ¶</strong>ä¸Šè§£å†³ï¼šæ–‡ä»¶inodeçš„inumberçš„é“¾æ¥è®¡æ•°ä¸‹é™åˆ°é›¶ï¼Œä½†æ˜¯å¼•ç”¨è®¡æ•°å´ä¸æ˜¯é›¶ã€‚å¦‚æœå½“æ–‡ä»¶çš„å¼•ç”¨è®¡æ•°åˆ°è¾¾æ–‡ä»¶ç³»ç»Ÿåˆ é™¤æ–‡ä»¶ï¼Œç„¶åé€šè¿‡ä»åˆ—è¡¨åˆ é™¤inodeæ›´æ–°ç£ç›˜åˆ—è¡¨ã€‚åœ¨æ¢å¤ä¸Šï¼Œæ–‡ä»¶ç³»ç»Ÿå°†ä¼šé‡Šæ”¾æ‰€æœ‰åœ¨listä¸­æ–‡ä»¶ã€‚</li></ol><p>xv6æ²¡æœ‰å®ç°ä¸Šè¿°ä¸¤ç§æ–¹æ¡ˆï¼Œè¿™ä¹Ÿæ„å‘³è¿™ä¸Šè¿°çš„é”™è¯¯æƒ…å†µå¯èƒ½ä¼šå‘ç”Ÿåœ¨xv6ä¸­ã€‚</p><h2 id="ä»£ç ï¼šæ•°æ®å—åˆ†é…"><a href="#ä»£ç ï¼šæ•°æ®å—åˆ†é…" class="headerlink" title="ä»£ç ï¼šæ•°æ®å—åˆ†é…"></a>ä»£ç ï¼šæ•°æ®å—åˆ†é…</h2><p>â€‹ åœ¨ä¸ºæ–‡ä»¶æ·»åŠ æ•°æ®æ—¶ï¼Œé€šå¸¸ä¼šåˆ›å»ºæ–°çš„æ•°æ®å—ã€‚æŸ¥çœ‹<code>write</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå°±å¯ä»¥çŸ¥é“åˆ›å»ºæ•°æ®å—æ˜¯è°ƒç”¨äº†<code>bmap</code>å‡½æ•°ï¼Œåœ¨<code>bmap</code>ä¸­è°ƒç”¨äº†<code>balloc</code>å‡½æ•°å°±æ˜¯ç”¨äºåˆ›å»ºæ•°æ®å—çš„ã€‚</p><blockquote><p><strong>bmap</strong>ï¼šæŸ¥æ‰¾æ•°æ®å—ç¼–å·</p></blockquote><p>â€‹ <code>bmap</code>å‡½æ•°ä¸­ä¼šåˆ†åˆ«ä½¿ç”¨<strong>ç›´æ¥åœ°å€æŒ‡é’ˆ</strong>ä¸<strong>é—´æ¥åœ°å€æŒ‡é’ˆ</strong>è®°å½•æ•°æ®å—å·ï¼Œè¿™äº›æŒ‡é’ˆè®°å½•äºinodeä¸­ã€‚åœ¨xv6çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œ<code>ip.addr[0:11]</code>æ˜¯ç›´æ¥æŒ‡é’ˆåœ°å€ï¼Œ<code>ip.addr[12]</code>æ˜¯é—´æ¥åœ°å€æŒ‡é’ˆåœ°å€ã€‚<code>bn</code>æ˜¯ç”¨äºæ ‡è®°ç°åœ¨è¦å†™å…¥æ•°æ®çš„å—ï¼Œæ˜¯è¯¥æ–‡ä»¶çš„ç¬¬å‡ ä¸ªæ•°æ®å—ã€‚</p><ol><li><strong>æŸ¥æ‰¾ç›´æ¥åœ°å€</strong>ï¼šå¦‚æœ<code>bn&lt;NDIRECT</code>ï¼Œè¯´æ˜æ‰€å†™çš„æ•°æ®åç§»æ˜¯å°äº<code>1024*12</code> (12ä¸ªå—)çš„ã€‚æŸ¥æ‰¾è¯¥ç´¢å¼•çš„åœ°å€æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨ä½¿ç”¨<code>balloc</code>åˆ†é…æ•°æ®å—ï¼Œå¹¶å°†è¿™ä¸ªæ•°æ®å—çš„ç¼–å·è®°å½•åˆ°<code>addr</code>æ•°ç»„ä¸­ï¼Œåä¹‹è¿”å›addrä¿å­˜çš„åœ°å€å€¼ã€‚</li><li><strong>æŸ¥æ‰¾é—´æ¥åœ°å€</strong>ï¼šå¦‚æœ<code>ip.addr[12]</code>å­˜åœ¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è¯»å–è¿™ä¸ªä¿å­˜æ•°æ®å—åœ°å€çš„<strong>åœ°å€å—</strong>(address blockï¼Œè¿™ä¸ªå—ä¹Ÿæ˜¯ä¸€ä¸ªæ•°æ®å—)ï¼Œä½¿ç”¨<code>balloc</code>åˆ†é…æ•°æ®å—ï¼Œå¹¶å°†å…¶è®°å½•åˆ°åœ°å€å—çš„æŒ‡å®šç´¢å¼•ä¸­ã€‚åä¹‹ä¸å­˜åœ¨å°±ä½¿ç”¨<code>balloc</code>åˆ†é…åœ°å€å—ã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">----fs.h</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NDIRECT 12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NINDIRECT (BSIZE / sizeof(uint)) <span class="comment">// åœ°å€å—ä¸­256ä¸ªæ•°æ®å—åœ°å€</span></span></span><br><span class="line">----fs.c</span><br><span class="line"><span class="type">static</span> uint</span><br><span class="line"><span class="title function_">bmap</span><span class="params">(<span class="keyword">struct</span> inode *ip, uint bn)</span></span><br><span class="line">&#123;</span><br><span class="line">  uint addr, *a;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">bp</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(bn &lt; NDIRECT)&#123;</span><br><span class="line">    <span class="keyword">if</span>((addr = ip-&gt;addrs[bn]) == <span class="number">0</span>)&#123;</span><br><span class="line">      addr = balloc(ip-&gt;dev);</span><br><span class="line">      <span class="keyword">if</span>(addr == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      ip-&gt;addrs[bn] = addr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">  &#125;</span><br><span class="line">  bn -= NDIRECT;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(bn &lt; NINDIRECT)&#123;</span><br><span class="line">    <span class="comment">// Load indirect block, allocating if necessary.</span></span><br><span class="line">    <span class="keyword">if</span>((addr = ip-&gt;addrs[NDIRECT]) == <span class="number">0</span>)&#123;</span><br><span class="line">      addr = balloc(ip-&gt;dev);</span><br><span class="line">      <span class="keyword">if</span>(addr == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      ip-&gt;addrs[NDIRECT] = addr;</span><br><span class="line">    &#125;</span><br><span class="line">    bp = bread(ip-&gt;dev, addr);</span><br><span class="line">    a = (uint*)bp-&gt;data;<span class="comment">//å¼ºè½¬1024å­—ç¬¦æ•°ç»„ä¸ºåŒ…å«256ä¸ªæ•´æ•°çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span>((addr = a[bn]) == <span class="number">0</span>)&#123;</span><br><span class="line">      addr = balloc(ip-&gt;dev);</span><br><span class="line">      <span class="keyword">if</span>(addr)&#123;</span><br><span class="line">        a[bn] = addr;</span><br><span class="line">        log_write(bp);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    brelse(bp);</span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  panic(<span class="string">&quot;bmap: out of range&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä½¿ç”¨<code>bmap</code>å‡½æ•°ä¾¿<code>readi</code>ä¸<code>writei</code>å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ“ä½œæ•°æ®å—äº†ã€‚</p><h1 id="Directory-layer"><a href="#Directory-layer" class="headerlink" title="Directory layer"></a>Directory layer</h1><h2 id="ç®€ä»‹-4"><a href="#ç®€ä»‹-4" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>â€‹ åœ¨linuxä¸­ç›®å½•(dircetory)è¢«è®¾è®¡å¾—åƒ<strong>æ–‡ä»¶</strong>ä¸€æ ·ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯æ–‡ä»¶åŠ ä¸Šä¸€äº›æ–‡ä»¶ç³»ç»Ÿèƒ½å¤Ÿç†è§£çš„<strong>æ•°æ®ç»“æ„</strong>ã€‚åœ¨inodeä¸­çš„<code>type</code>å­—æ®µä¸º<code>T_DTR</code>åˆ™è¯´æ˜æ˜¯ä¸€ä¸ªç›®å½•ï¼Œå¹¶ä¸”è¿™ä¸ªinodeä¼šä¿å­˜<strong>ç›®å½•æ¡ç›®</strong>ï¼Œå¯ä»¥æ˜¯æ–‡ä»¶æˆ–å­ç›®å½•ï¼Œè¿™äº›ç›®å½•æ¡ç›®åˆ™ä¿å­˜åœ¨ç›®å½•inodeçš„<strong>åœ°å€æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®å—</strong>ä¸­ã€‚</p><p>æ¯ä¸€ä¸ªç›®å½•éƒ½ä¼šåŒ…å«å¤šä¸ªç›®å½•æ¡ç›®ï¼Œå¦‚ä¸‹ç»“æ„ä½“ä¾¿æ˜¯ç›®å½•æ¡ç›®(directory entry)ã€‚é•¿åº¦ä¸º16å­—èŠ‚ï¼Œåˆ†ä¸ºå¦‚ä¸‹ä¸¤ä¸ªå­—æ®µï¼š</p><ul><li><code>inum</code>(2B)ï¼šå­ç›®å½•çš„inodeç¼–å·ï¼›</li><li><code>name</code>(14B)ï¼šæ–‡ä»¶æˆ–è€…å­ç›®å½•çš„åç§°ã€‚</li></ul><p>ç”±æ­¤å¯çŸ¥ä¸€ä¸ªæ•°æ®å—èƒ½å¤Ÿä¿å­˜<code>1024/16 = 64</code>ä¸ªç›®å½•æ¡ç›®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Directory is a file containing a sequence of dirent structures.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DIRSIZ 14</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> &#123;</span></span><br><span class="line">  ushort inum;</span><br><span class="line">  <span class="type">char</span> name[DIRSIZ];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä»‹ç»ä»¥ä¸‹ä¸ç›®å½•ç›¸å…³çš„ä»£ç ã€‚</p><h2 id="ä»£ç ï¼šdirectory-layer"><a href="#ä»£ç ï¼šdirectory-layer" class="headerlink" title="ä»£ç ï¼šdirectory layer"></a>ä»£ç ï¼šdirectory layer</h2><blockquote><p><strong>dirlookup</strong>ï¼šæŸ¥æ‰¾æŒ‡å®šæ–‡ä»¶</p></blockquote><p>â€‹ é€šè¿‡æŒ‡å®šçš„åå­—åœ¨<strong>ç›®å½•inode</strong>ä¸­æŸ¥æ‰¾å¯¹åº”çš„ç›®å½•æ¡ç›®ï¼Œå¦‚æœæ‰¾åˆ°æŒ‡å®šçš„ç›®å½•æ¡ç›®å°±å°†è¿”å›å¯¹åº”çš„<strong>æ–‡ä»¶inodeæŒ‡é’ˆ</strong>ï¼Œå°†<code>*poff</code>è®¾ç½®ä¸ºå½“å‰çš„ç›®å½•æ¡ç›®åç§»é‡ï¼Œä»¥ä¾¿è°ƒç”¨å‡½æ•°å¯ä»¥ä¿®æ”¹è¿™ä¸ªæ¡ç›®ï¼Œæœ€åé€šè¿‡<code>iget</code>è¿”å›ä¸€ä¸ªæœªé”å®šçš„inodeæŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">----fs.c</span><br><span class="line"><span class="keyword">struct</span> inode*</span><br><span class="line"><span class="title function_">dirlookup</span><span class="params">(<span class="keyword">struct</span> inode *dp, <span class="type">char</span> *name, uint *poff)</span></span><br><span class="line">&#123;</span><br><span class="line">  uint off, inum;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> <span class="title">de</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(dp-&gt;type != T_DIR)</span><br><span class="line">    panic(<span class="string">&quot;dirlookup not DIR&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(off = <span class="number">0</span>; off &lt; dp-&gt;size; off += <span class="keyword">sizeof</span>(de))&#123;</span><br><span class="line">    <span class="keyword">if</span>(readi(dp, <span class="number">0</span>, (uint64)&amp;de, off, <span class="keyword">sizeof</span>(de)) != <span class="keyword">sizeof</span>(de))</span><br><span class="line">      panic(<span class="string">&quot;dirlookup read&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(de.inum == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span>(namecmp(name, de.name) == <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="comment">// entry matches path element</span></span><br><span class="line">      <span class="keyword">if</span>(poff)</span><br><span class="line">        *poff = off;</span><br><span class="line">      inum = de.inum;</span><br><span class="line">      <span class="keyword">return</span> iget(dp-&gt;dev, inum);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>dirlink</strong>ï¼šæ·»åŠ æ–‡ä»¶inodeåˆ°ç›®å½•inodeä¸­</p></blockquote><p>â€‹ åœ¨ä½¿ç”¨<code>open</code>åˆ›å»ºæ–‡ä»¶æ—¶ä¼šä½¿ç”¨åˆ°è¯¥å‡½æ•°ï¼Œé€šè¿‡ä¼ é€’ç»™å®šçš„åç§°å’Œi-numberä½œä¸ºä¸€ä¸ª<strong>ç›®å½•æ¡ç›®</strong>åˆ°ç›®å½•inode(<code>dp</code>)ä¸­ã€‚ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li><code>dirlookup</code>åˆ¤æ–­è¦æ·»åŠ çš„ç›®å½•æ¡ç›®inodeæ˜¯å¦å·²ç»å­˜åœ¨äºå½“å‰ç›®å½•inodeä¸­ï¼Œå­˜åœ¨çš„è¯åˆ™è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</li><li>éå†<code>dp</code>æŒ‡å‘çš„ä¿å­˜ç›®å½•æ¡ç›®çš„æ•°æ®å—ï¼Œå¯»æ‰¾ä¸€ä¸ªæ•°æ®å—ä¸­æ˜¯å¦æœ‰ç©ºé—²çš„ç›®å½•æ¡ç›®èŠ‚ç‚¹ï¼Œè‹¥æ‰¾åˆ°åˆ™è·³å‡ºå¾ªç¯ã€‚</li><li>å°†ä¼ é€’çš„å‚æ•°å†™å…¥ç©ºé—²ç›®å½•æ¡ç›®ä¸­ï¼Œå†å°†ç›®å½•æ¡ç›®å†™å›æ•°æ®å—ã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">----fs.c</span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">dirlink</span><span class="params">(<span class="keyword">struct</span> inode *dp, <span class="type">char</span> *name, uint inum)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> off;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> <span class="title">de</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">ip</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check that name is not present.</span></span><br><span class="line">  <span class="keyword">if</span>((ip = dirlookup(dp, name, <span class="number">0</span>)) != <span class="number">0</span>)&#123;</span><br><span class="line">    iput(ip);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Look for an empty dirent.</span></span><br><span class="line">  <span class="keyword">for</span>(off = <span class="number">0</span>; off &lt; dp-&gt;size; off += <span class="keyword">sizeof</span>(de))&#123;</span><br><span class="line">    <span class="keyword">if</span>(readi(dp, <span class="number">0</span>, (uint64)&amp;de, off, <span class="keyword">sizeof</span>(de)) != <span class="keyword">sizeof</span>(de))</span><br><span class="line">      panic(<span class="string">&quot;dirlink read&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(de.inum == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">strncpy</span>(de.name, name, DIRSIZ);</span><br><span class="line">  de.inum = inum;</span><br><span class="line">  <span class="keyword">if</span>(writei(dp, <span class="number">0</span>, (uint64)&amp;de, off, <span class="keyword">sizeof</span>(de)) != <span class="keyword">sizeof</span>(de))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Pathname-layer"><a href="#Pathname-layer" class="headerlink" title="Pathname layer"></a>Pathname layer</h1><h2 id="ä»£ç ï¼šPath-names"><a href="#ä»£ç ï¼šPath-names" class="headerlink" title="ä»£ç ï¼šPath names"></a>ä»£ç ï¼šPath names</h2><p>â€‹ åœ¨æ“ä½œæ–‡ä»¶çš„æ—¶ä¼šæ¶‰åŠä¸€ç³»åˆ—çš„è·¯å¾„åï¼Œå¦‚ç›¸å¯¹è·¯å¾„ã€ç»å¯¹è·¯å¾„ã€å½“å‰è·¯å¾„ç­‰ã€‚åªæœ‰æŒ‡å®šäº†æ­£ç¡®çš„è·¯å¾„åæˆ‘ä»¬æ‰èƒ½æ‰“å¼€æ­£ç¡®çš„æ–‡ä»¶ï¼Œå› æ­¤é€šè¿‡è·¯å¾„æŸ¥è¯¢æ–‡ä»¶ä¹Ÿæ˜¯ååˆ†é‡è¦çš„åŠŸèƒ½ï¼Œåœ¨xv6ä¹Ÿæä¾›äº†è·¯å¾„åè§£æçš„å‡½æ•°ï¼š</p><blockquote><p><strong>namei</strong>ï¼šè§£æè·¯å¾„åå¹¶è¿”å›æŒ‡å®šçš„inode</p></blockquote><p>â€‹ <code>namei</code>æ˜¯è¾“å…¥ä¸€ä¸ªè·¯å¾„åå‚æ•°ï¼Œä»¥æ­¤è§£æè·¯å¾„è·å¾—æ–‡ä»¶inodeã€‚å¦‚ï¼šè¾“å…¥<code>/a/b/c</code>ï¼Œé‚£ä¹ˆè·å¾—çš„å°±æ˜¯æ–‡ä»¶cçš„inodeã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> inode*</span><br><span class="line"><span class="title function_">namei</span><span class="params">(<span class="type">char</span> *path)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> name[DIRSIZ];</span><br><span class="line">  <span class="keyword">return</span> namex(path, <span class="number">0</span>, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>nameiparent</strong>ï¼šè¿”å›æ–‡ä»¶çˆ¶ç›®å½•çš„inode</p></blockquote><p>â€‹ <code>nameiparent</code>æ˜¯<code>namei</code>å‡½æ•°çš„å˜ç§ï¼Œä¸å…¶ä¸åŒçš„æ˜¯éœ€è¦è¾“å…¥ä¸¤ä¸ªå‚æ•°ï¼Œä¼šè¿”å›<strong>çˆ¶ç›®å½•çš„inode</strong>å¹¶å°†è·¯å¾„åçš„æœ€åä¸€ä¸ªå…ƒç´ ä¿å­˜åˆ°nameä¸­ã€‚ä¾‹å¦‚è¾“å…¥<code>/a/b/c</code>ï¼Œnameå°±æ˜¯cè¿™ä¸ªæ–‡ä»¶ï¼Œè€Œinodeåˆ™æ˜¯<code>/a/b</code>è¿™ä¸ªç›®å½•inodeã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> inode*</span><br><span class="line"><span class="title function_">nameiparent</span><span class="params">(<span class="type">char</span> *path, <span class="type">char</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> namex(path, <span class="number">1</span>, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>namex</strong>ï¼šè§£æè·¯å¾„å‡½æ•°</p></blockquote><p>â€‹ <code>namex</code>æ˜¯<code>namei</code>ä¸<code>nameiparent</code>å‡½æ•°çš„å¹¿ä¹‰çš„å‡½æ•°ï¼Œå®é™…ä¸Šæ‰€æœ‰çš„è§£ææ“ä½œç”±<code>namex</code>å®Œæˆã€‚æ¥ç€æŒ‰ç…§æµç¨‹è§£é‡Šä¸€ä¸‹namexæ„æˆï¼š</p><ol><li>åˆ¤æ–­è·¯å¾„åå¼€å§‹å­—ç¬¦ï¼Œç¡®å®šè·¯å¾„åï¼Œå¦‚æœæ˜¯ä»¥<code>&#39;/&#39;</code>å¼€å§‹å°±æ˜¯<strong>ç»å¯¹è·¯å¾„</strong>ï¼Œä¸ºå¼€å§‹è¯»å–æ ¹inode)ï¼Œåä¹‹æ˜¯<strong>å½“å‰è·¯å¾„</strong>ï¼Œè¯»å–å½“å‰è¿›ç¨‹çš„inodeã€‚ä»¥æ­¤è·å¾—ç›®å½•inodeã€‚</li><li>å¾ªç¯æ‰§è¡Œ<code>skipelem</code>å‡½æ•°ï¼Œè§£æè·¯å¾„åç§°è·³è¿‡ä¸€äº›ç›®å½•æˆ–è€…é‡å¤çš„å…ƒç´ (å¦‚<code>&#39;/&#39;</code>å­—ç¬¦)ã€‚</li><li>å¦‚æœ<code>path=/a/b/c</code>ï¼Œç»è¿‡<code>skipelem</code>è°ƒç”¨å<code>path=b/c</code>ã€‚æ˜¾ç„¶pathå¹¶ä¸ä¸º0åˆ™è¿›å…¥å¾ªç¯ï¼Œåœ¨å¾ªç¯å†…éƒ¨é¦–å…ˆæ£€æŸ¥ipè¿™ä¸ªinodeæ˜¯å¦ä¸ºç›®å½•ï¼Œå¦‚æœä¸æ˜¯åˆ™è°ƒç”¨<code>iunlockput</code>å‡½æ•°é‡Šæ”¾inodeã€‚å†åˆ¤æ–­è°ƒç”¨è€…æ˜¯å¦ä¸º<code>nameiparent</code>å‡½æ•°å¹¶ä¸”<code>path</code>æ˜¯å¦ä¸º0ï¼Œæ˜¯çš„è¯åˆ™è¿”å›è¿™ä¸ªç›®å½•inodeã€‚</li><li>åˆ¤æ–­æ–‡ä»¶å(<code>name = /b/c</code>)æ˜¯å¦åœ¨ç›®å½•inode(æ ¹ç›®å½•<code>/</code>)ä¸­å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨è·å–<code>/a/b/</code>ç›®å½•çš„inodeï¼Œå¹¶å°†ipè®¾ç½®ä¸ºå½“å‰inodeã€‚</li></ol><p>ä»¥<code>/a/b/c</code>ä¸ºä¾‹ï¼Œé‚£ä¹ˆç¬¬ä¸€æ¬¡å¾ªç¯<code>path = b/c,name = a ip = a/</code>ï¼Œç¬¬äºŒæ¬¡å¾ªç¯<code>path = cï¼Œname = c ip = b/</code>ï¼Œç¬¬ä¸‰æ¬¡å¾ªç¯<code>path = 0,name = c</code>ï¼Œé€€å‡ºå¾ªç¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> inode*</span><br><span class="line"><span class="title function_">namex</span><span class="params">(<span class="type">char</span> *path, <span class="type">int</span> nameiparent, <span class="type">char</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">ip</span>, *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(*path == <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    ip = iget(ROOTDEV, ROOTINO);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    ip = idup(myproc()-&gt;cwd);</span><br><span class="line">  <span class="comment">//å¦‚///a//b/cï¼Œé‚£ä¹ˆç¬¬ä¸€æ¬¡è°ƒç”¨skipelemå‡½æ•° path = b/cï¼Œname= aã€‚</span></span><br><span class="line">  <span class="keyword">while</span>((path = skipelem(path, name)) != <span class="number">0</span>)&#123;</span><br><span class="line">    ilock(ip);</span><br><span class="line">    <span class="keyword">if</span>(ip-&gt;type != T_DIR)&#123;</span><br><span class="line">      iunlockput(ip);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(nameiparent &amp;&amp; *path == <span class="string">&#x27;\0&#x27;</span>)&#123;</span><br><span class="line">      <span class="comment">// Stop one level early.</span></span><br><span class="line">      iunlock(ip);</span><br><span class="line">      <span class="keyword">return</span> ip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>((next = dirlookup(ip, name, <span class="number">0</span>)) == <span class="number">0</span>)&#123;</span><br><span class="line">      iunlockput(ip);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    iunlockput(ip);</span><br><span class="line">    ip = next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(nameiparent)&#123;</span><br><span class="line">    iput(ip);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ip;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="File-descriptor-layer"><a href="#File-descriptor-layer" class="headerlink" title="File descriptor layer"></a>File descriptor layer</h1><h2 id="ç®€ä»‹-5"><a href="#ç®€ä»‹-5" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>â€‹ Unixè®¾è®¡ä¸­æ¯”è¾ƒæ„æ€çš„æ–¹é¢å°±æ˜¯åœ¨Unixä¸­çš„å¤§éƒ¨åˆ†èµ„æºéƒ½å¯ä»¥è¡¨ç¤ºæˆä¸º<strong>æ–‡ä»¶</strong>ï¼ŒåŒ…æ‹¬è®¾å¤‡(console)ï¼Œç®¡é“ï¼Œæ–‡ä»¶ã€‚File descriptor layeråˆ™æ˜¯å°†æ‰€æœ‰èµ„æºç»Ÿä¸€ä¸ºæ–‡ä»¶çš„å±‚ï¼Œä½“ç°äº†<strong>ä¸€è‡´æ€§</strong>(uniformity).</p><p>â€‹ <strong>æ–‡ä»¶æè¿°ç¬¦</strong>ä»æ•°æ®ç±»å‹çš„è§†è§’æ¥çœ‹å°±æ˜¯ä¸€ä¸ªæ•´å‹<strong>int</strong>ï¼Œé€šè¿‡æ–‡ä»¶æè¿°ç¬¦æˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨<code>write</code>æˆ–<code>read</code>æ–¹æ³•å»æ“ä½œæ–‡ä»¶èµ„æºã€‚ä½†æ˜¯æ–‡ä»¶æè¿°ç¬¦çš„èƒŒåçš„æ•°æ®ç»“æ„å¹¶ä¸æ˜¯ä¸€ä¸ªæ•´å‹æ‰€èƒ½è¡¨è¿°çš„ï¼Œæ–‡ä»¶æè¿°ç¬¦æ˜¯é€šè¿‡<strong>å±‚å±‚æŠ½è±¡</strong>å¾—åˆ°ä¸€ä¸ªç®€æ˜“çš„å¯ä»¥æ“ä½œæ–‡ä»¶èµ„æºçš„<strong>å¥æŸ„</strong>ï¼Œå®é™…åŸç†æ˜¯å°†æ–‡ä»¶çš„inodeä¸æ–‡ä»¶æè¿°ç¬¦é€šè¿‡å†…æ ¸åˆ¶ä½œæˆäº†ä¸€ä¸ªæ˜ å°„ã€‚</p><p>â€‹ é‚£ä¹ˆåœ¨xv6æ˜¯å¦‚ä½•é€šè¿‡æ–‡ä»¶inodeä¸€æ­¥æ­¥ç”Ÿæˆæ–‡ä»¶æè¿°ç¬¦ï¼Œåˆæ˜¯å¦‚ä½•é€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ“ä½œæ–‡ä»¶çš„ï¼Œæ¥ç€å­¦ä¹ ä¸€ä¸‹æœ‰å…³File descriptor layerçš„ä»£ç ã€‚</p><h2 id="ä»£ç ï¼šæ–‡ä»¶ç»“æ„"><a href="#ä»£ç ï¼šæ–‡ä»¶ç»“æ„" class="headerlink" title="ä»£ç ï¼šæ–‡ä»¶ç»“æ„"></a>ä»£ç ï¼šæ–‡ä»¶ç»“æ„</h2><blockquote><p>1.<strong>è¿›ç¨‹ç»“æ„</strong></p></blockquote><p>è¿›ç¨‹çš„ç»“æ„ä½“ä»£ç ï¼Œæˆ‘ä»¬ä¼šå‘ç°procç»“æ„ä½“æœ‰ä¸¤ä¸ªå…³äºæ–‡ä»¶çš„å­—æ®µï¼š</p><ul><li><strong>ofile</strong>ï¼šè¡¨ç¤ºè¿›ç¨‹<strong>å·²æ‰“å¼€</strong>çš„æ–‡ä»¶æˆ–æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œæ¯ä¸€ä¸ªfileç»“æ„å¯¹åº”ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚é‚£ä¹ˆNOFILE==16ï¼Œä¹Ÿå°±ä»£è¡¨xv6ä¸­èƒ½å¤Ÿä¸€ä¸ªè¿›ç¨‹æœ€å¤šèƒ½å¤Ÿæ‰“å¼€16ä¸ªæ–‡ä»¶ã€‚</li><li><strong>cmd</strong>ï¼šcmdä»£è¡¨å½“å‰è¿›ç¨‹çš„<strong>æ–‡ä»¶ç›®å½•</strong>çš„inodeã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">----proc.h</span><br><span class="line"><span class="comment">// Per-process state</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc</span> &#123;</span></span><br><span class="line">  ....<span class="comment">//æœ‰å…³æ–‡ä»¶ç³»ç»Ÿçš„å­—æ®µ</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">ofile</span>[<span class="title">NOFILE</span>];</span>  <span class="comment">// Open files</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">cwd</span>;</span>           <span class="comment">// Current directory</span></span><br><span class="line">  <span class="type">char</span> name[<span class="number">16</span>];               <span class="comment">// Process name (debugging)</span></span><br><span class="line">&#125;;</span><br><span class="line">----param.h</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NOFILE       16  <span class="comment">// open files per process</span></span></span><br></pre></td></tr></table></figure><blockquote><p>2.<strong>æ–‡ä»¶ç»“æ„</strong>ï¼šä¿æŒUnixèµ„æºä¸€è‡´æ€§</p></blockquote><p>â€‹ åœ¨xv6å†…æ ¸ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿<strong>ç®¡ç†</strong>æ–‡ä»¶ã€è®¾å¤‡ã€ç®¡é“ç­‰èµ„æºã€å°†è¿™äº›èµ„æºæŠ½è±¡<strong>ä¸€è‡´åŒ–ä¸ºæ–‡ä»¶</strong>ï¼Œè®¾è®¡æˆä¸ºäº†fileç»“æ„ä½“ã€‚</p><p>â€‹ æ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶éƒ½ç”±ä¸€ä¸ª<code>struct file</code> è¡¨ç¤ºï¼Œå¯¹ <strong>inode</strong>æˆ–<strong>ç®¡é“</strong>ä»¥åŠ I/O åç§»é‡ç­‰å…ƒæ•°æ®çš„å°è£…ï¼Œä¸åŒç±»å‹çš„èµ„æºå¯ä»¥ä½¿ç”¨typeå­—æ®µè¿›è¡Œæ ‡è¯†ã€‚åœ¨ç”¨æˆ·è¿›ç¨‹æ¯æ¬¡è°ƒç”¨openç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„<code>struct file</code>ã€‚fileç»“æ„åœ¨å¤šè¿›ç¨‹åŒæ ·ä¹Ÿå¯ä»¥å¾ˆå¥½çš„åè°ƒï¼š</p><ul><li><p>å¦‚æœå¤šè¿›ç¨‹ç‹¬ç«‹æ‰“å¼€åŒä¸€ä¸ªæ–‡ä»¶ï¼Œä¸åŒçš„å®ä¾‹çš„I/Oåç§»é‡ä¹Ÿä¸åŒ</p></li><li><p>å¦ä¸€æ–¹é¢ï¼Œä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶å¯ä»¥å¤šæ¬¡å‡ºç°åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹çš„æ–‡ä»¶è¡¨ä¸­ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ open æ‰“å¼€æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨ <code>dup</code> åˆ›å»ºåˆ«å(å•è¿›ç¨‹æ–‡ä»¶è¡¨)ï¼Œæˆ–ä½¿ç”¨ <code>fork</code> (å¤šè¿›ç¨‹æ–‡ä»¶è¡¨)ä¸å­è¿›ç¨‹å…±äº«ï¼Œå°±ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚</p></li></ul><p>æ–‡ä»¶ç»“æ„ä½“ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">----file.h</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span></span><br><span class="line">  <span class="comment">//æšä¸¾æ–‡ä»¶ç±»å‹</span></span><br><span class="line">  <span class="class"><span class="keyword">enum</span> &#123;</span> FD_NONE, FD_PIPE, FD_INODE, FD_DEVICE &#125; type;</span><br><span class="line">  <span class="type">int</span> ref; <span class="comment">// è®°å½•æ‰“å¼€æ–‡ä»¶çš„å¼•ç”¨æ•°é‡ã€‚</span></span><br><span class="line">  <span class="type">char</span> readable; <span class="comment">//è¡¨ç¤ºæ–‡ä»¶æ˜¯å¦å¯è¯»</span></span><br><span class="line">  <span class="type">char</span> writable; <span class="comment">//è¡¨ç¤ºæ–‡ä»¶æ˜¯å¦å¯å†™</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipe</span> *<span class="title">pipe</span>;</span> <span class="comment">// è®°å½•å½“å‰æ–‡ä»¶ç®¡é“</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">ip</span>;</span>  <span class="comment">// FD_INODE and FD_DEVICE</span></span><br><span class="line">  uint off;          <span class="comment">// IOçš„åç§»é‡</span></span><br><span class="line">  <span class="type">short</span> major;       <span class="comment">// FD_DEVICE</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>3.<strong>å…¨å±€æ–‡ä»¶è¡¨</strong>ï¼š</p></blockquote><p>â€‹ æ‰€æœ‰ä»¥æ‰“å¼€çš„æ–‡ä»¶ï¼Œéƒ½ä¼šä¿å­˜åœ¨ç³»ç»Ÿçš„å…¨å±€æ–‡ä»¶è¡¨ä¸­(<code>ftable</code>)ï¼Œåœ¨<code>ftable</code>ä¸­æä¾›å¤šä¸ªå‡½æ•°æ¥å£ç»™å†…æ ¸ï¼Œç”¨äºæ“ä½œå…¨å±€æ–‡ä»¶è¡¨ï¼š</p><ul><li><code>filealloc</code>ï¼šåˆ†é…æ–‡ä»¶ã€‚</li><li><code>filedup</code>ï¼šåˆ›å»ºé‡å¤çš„æ–‡ä»¶å¼•ç”¨ï¼Œå¢åŠ æ–‡ä»¶å¼•ç”¨æ•°ã€‚</li><li><code>fileclose</code>ï¼šé‡Šæ”¾æ–‡ä»¶å¼•ç”¨ï¼Œå½“å¼•ç”¨æ•°ä¸º0ï¼Œé‡Šæ”¾æ–‡ä»¶ã€‚</li><li><code>filereadã€filewrite</code>ï¼šå¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">----file.c</span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">file</span> <span class="title">file</span>[<span class="title">NFILE</span>];</span></span><br><span class="line">&#125; ftable;</span><br><span class="line">----param.h</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NFILE       100 </span></span><br></pre></td></tr></table></figure><p>å…¨å±€æ–‡ä»¶è¡¨çš„ä¸»è¦ä½œç”¨ï¼šç”¨äº<strong>å¤šè¿›ç¨‹</strong>ä¹‹é—´æ–‡ä»¶å®ä¾‹çš„<strong>é€šä¿¡</strong>ã€å†…æ ¸å¯ä»¥æ›´åŠ æ–¹ä¾¿çš„ä½¿ç”¨æ–‡ä»¶èµ„æºã€‚</p><h2 id="ä»£ç ï¼šåˆ›å»ºæ–‡ä»¶æè¿°ç¬¦fd"><a href="#ä»£ç ï¼šåˆ›å»ºæ–‡ä»¶æè¿°ç¬¦fd" class="headerlink" title="ä»£ç ï¼šåˆ›å»ºæ–‡ä»¶æè¿°ç¬¦fd"></a>ä»£ç ï¼šåˆ›å»ºæ–‡ä»¶æè¿°ç¬¦fd</h2><blockquote><p>1.<strong>ç”¨æˆ·çº§</strong>æ–‡ä»¶æ“ä½œç¤ºä¾‹</p></blockquote><p>â€‹ å¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨ç”¨æˆ·ç¨‹åºä¸­ï¼Œå¯ä»¥ä½¿ç”¨<code>open</code>è¿›è¡Œåˆ›å»ºæ–‡ä»¶ï¼Œå¹¶ä¸”è·å–æ–‡ä»¶æè¿°ç¬¦fdã€‚é‚£ä¹ˆfdå°±ä»£è¡¨è¿™ä¸ªtest1æ–‡ä»¶ã€‚ä¹‹åæˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡è¿™ä¸ªfdè®¿é—®æ–‡ä»¶ï¼Œä½¿ç”¨<code>write</code>å‘test1æ–‡ä»¶å†™å…¥å†…å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">----user/test1.c</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;./test1&quot;</span>,O_CREATE|O_RDWR);</span><br><span class="line">    write(fd,<span class="string">&quot;hello world&quot;</span>,<span class="keyword">sizeof</span>(<span class="string">&quot;hello world&quot;</span>));</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ä»¥ç³»ç»Ÿè°ƒç”¨æ“ä½œçš„é¡ºåºè¿›è¡Œäº†è§£ã€‚ä¸ºäº†ä¸æ··æ·†æ–‡ä»¶ä¹‹é—´çš„æ¦‚å¿µï¼Œåœ¨æ­¤å…ˆå£°æ˜ä¸‹æ–‡æ‰€ææ¯ä¸€ä¸ªè¯æ±‡çš„æ‰€æŒ‡å‘çš„å®ä½“ï¼š</p><ul><li><strong>æ–‡ä»¶å®ä¾‹</strong>ï¼šæ•°æ®ç±»å‹ä¸º<code>struct file</code>ï¼Œå·²æ‰“å¼€çš„æ–‡ä»¶åœ¨å…¨å±€æ–‡ä»¶è¡¨ä¸­ä¿å­˜ï¼Œå…¶ä¿å­˜çš„inodeå­—æ®µæŒ‡å‘äº†æ–‡ä»¶èµ„æºã€‚</li><li><strong>æ–‡ä»¶èµ„æº</strong>ï¼šä¸»è¦ç”¨äºè¡¨ç¤ºç£ç›˜å—ä¸Šçš„æ–‡ä»¶æ•°æ®ï¼Œå†…æ ¸å°±æ˜¯é€šè¿‡æ–‡ä»¶å®ä¾‹ä¸­çš„inodeå­—æ®µï¼Œè®¿é—®åˆ°æ–‡ä»¶èµ„æºçš„ã€‚</li><li><strong>æ–‡ä»¶æè¿°ç¬¦</strong>ï¼šç”¨æˆ·çº§çš„æ–‡ä»¶å®ä¾‹ï¼Œæ•°æ®ç±»å‹ä¸º<code>int</code>ï¼Œæ˜¯ç®€åŒ–è¿‡åäº†æ–‡ä»¶å®ä¾‹ï¼Œä½œä¸ºè¿›ç¨‹æ–‡ä»¶è¡¨çš„ç´¢å¼•ã€‚</li></ul><p>ä»¥ä¸Šæ˜¯ç¬”è€…è‡ªå·±çš„è¡¨è¿°(ä¸åŒ…å«è®¾å¤‡å’Œç®¡é“çš„æè¿°)ï¼Œå¯èƒ½æœ‰æ‰€æ¯›ç—…ï¼Œå¦‚æœ‰é”™è¯·æŒ‡å‡ºã€‚</p><blockquote><p>2.<strong>open</strong>ï¼šè·å–æ–‡ä»¶æè¿°ç¬¦</p></blockquote><ol><li>ç”¨æˆ·é€šè¿‡openç³»ç»Ÿè°ƒç”¨è¾“å…¥çš„è·¯å¾„(<code>./test1</code>)ï¼Œåœ¨sys_openåˆ›è°ƒç”¨createå‡½æ•°ï¼Œåˆ›å»ºäº†å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶(<strong>test1</strong>)çš„inodeã€‚</li><li>è°ƒç”¨<code>filealloc</code>åˆ†é…å…¨å±€æ–‡ä»¶è¡¨ï¼Œåˆ†é…ä¸€ä¸ªæ–‡ä»¶å®ä¾‹ã€‚</li><li>è°ƒç”¨<code>fdalloc</code>å°†ä¸Šè¿°è·å–çš„æ–‡ä»¶å®ä¾‹è½¬åŒ–æˆä¸º<strong>æ–‡ä»¶æè¿°ç¬¦</strong>ï¼Œè¿™å¯ä»¥ç†è§£å»ºç«‹äº†æ˜ å°„ã€‚</li><li>è®¾ç½®æ–‡ä»¶å®ä¾‹çš„ç›¸å…³å­—æ®µï¼Œè¿™é‡Œä¸»è¦æ˜¯å°†<strong>test1</strong>æ–‡ä»¶çš„<code>inode</code>ç»‘å®šåˆ°äº†æ–‡ä»¶å®ä¾‹ä¸Šã€‚</li><li>å°†æ–‡ä»¶æè¿°ç¬¦è¿”å›ç»™ç”¨æˆ·ã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">----sysfile.c</span><br><span class="line">uint64</span><br><span class="line"><span class="title function_">sys_open</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  ....</span><br><span class="line">  argint(<span class="number">1</span>, &amp;omode);</span><br><span class="line">  <span class="keyword">if</span>((n = argstr(<span class="number">0</span>, path, MAXPATH)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  ....<span class="comment">//åˆ›å»º(è°ƒç”¨create)æˆ–æŸ¥æ‰¾ç›®æ ‡æ–‡ä»¶è·¯å¾„çš„inode</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((f = filealloc()) == <span class="number">0</span> || (fd = fdalloc(f)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">	....<span class="comment">//é”™è¯¯å¤„ç†</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ....<span class="comment">//ä¿®æ”¹æ–‡ä»¶ç»“æ„ä½“å¯¹åº”çš„å…ƒæ•°æ®</span></span><br><span class="line">  f-&gt;ip = ip;<span class="comment">//å°†æ–‡ä»¶ç»“æ„çš„inodeå­—æ®µè®¾ç½®ä¸ºç›®æ ‡æ–‡ä»¶inode</span></span><br><span class="line">  ....<span class="comment">//ä¿®æ”¹æ–‡ä»¶ç»“æ„ä½“å¯¹åº”çš„å…ƒæ•°æ®</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>3.<strong>åˆ†é…æ–‡ä»¶æè¿°ç¬¦</strong>ï¼šå»ºç«‹æ–‡ä»¶å®ä¾‹æ˜ å°„</p></blockquote><p>â€‹ <code>fdalloc</code>å‡½æ•°ï¼šè§‚å¯Ÿä¸‹è¿°ä»£ç ï¼Œä¸»è¦æ˜¯å°†å…¨å±€çš„æ–‡ä»¶å®ä¾‹ï¼Œåˆ†é…ç»™äº†å½“å‰è¿›ç¨‹ï¼Œfdåˆ™æ˜¯ä»£è¡¨çš„æ˜¯è¿›ç¨‹<strong>æ‰“å¼€æ–‡ä»¶è¡¨(open file table)çš„ç´¢å¼•</strong>ã€‚é‚£ä¹ˆåœ¨æ­¤ä¹‹ååªè¦æ˜¯è¯¥è¿›ç¨‹çš„ç”¨æˆ·è¿›ç¨‹å°±èƒ½å¤Ÿé€šè¿‡è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè®¿é—®åˆ°å¯¹åº”çš„æ–‡ä»¶å®ä¾‹ã€‚åŸç†å°±æ˜¯ç®€å•çš„hashè¡¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">----sysfile</span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">fdalloc</span><span class="params">(<span class="keyword">struct</span> file *f)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> fd;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(fd = <span class="number">0</span>; fd &lt; NOFILE; fd++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;ofile[fd] == <span class="number">0</span>)&#123;</span><br><span class="line">      p-&gt;ofile[fd] = f;</span><br><span class="line">      <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šè¿‡ç¨‹ç²—ç•¥çš„å¯ä»¥æè¿°ä¸ºä¸‹å›¾ï¼š</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/fd_open.png" alt="fd_open"></p><h2 id="ä»£ç ï¼šé€šè¿‡fdä¿®æ”¹æ–‡ä»¶èµ„æº"><a href="#ä»£ç ï¼šé€šè¿‡fdä¿®æ”¹æ–‡ä»¶èµ„æº" class="headerlink" title="ä»£ç ï¼šé€šè¿‡fdä¿®æ”¹æ–‡ä»¶èµ„æº"></a>ä»£ç ï¼šé€šè¿‡fdä¿®æ”¹æ–‡ä»¶èµ„æº</h2><blockquote><p>4.<strong>write</strong>ï¼šé€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ“ä½œæ–‡ä»¶</p></blockquote><p>â€‹ åœ¨é€šè¿‡<code>open</code>è·å¾—<strong>test1</strong>çš„æ–‡ä»¶æè¿°ç¬¦fdåï¼Œé‚£ä¹ˆwrtieå°±å¯ä»¥é€šè¿‡fdå»ä¿®æ”¹æ–‡ä»¶æ•°æ®äº†ã€‚å…·ä½“çš„è¿‡ç¨‹å°±æ˜¯é€šè¿‡<code>argfd</code>å‡½æ•°å°†fdè½¬æ¢ä¸ºæ–‡ä»¶å®ä¾‹ï¼Œåœ¨é€šè¿‡æ–‡ä»¶å®ä¾‹ä¸­ä¿å­˜çš„<strong>test1çš„inode</strong>å­—æ®µï¼Œå°±å¯ä»¥å¯¹æ–‡ä»¶æ•°æ®è¿›è¡Œä¿®æ”¹ã€‚</p><p>â€‹ ä¹‹ååœ¨è°ƒç”¨<code>filewrite</code>å°±èƒ½å¤Ÿå°†writeç³»ç»Ÿè°ƒç”¨ä¼ å…¥çš„å­—ç¬¦æˆ–å­—ç¬¦ä¸²ï¼Œå†™å…¥åˆ°test1æ–‡ä»¶ä¸­äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line"><span class="title function_">sys_write</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span>;</span></span><br><span class="line">  <span class="type">int</span> n;</span><br><span class="line">  uint64 p;</span><br><span class="line">  </span><br><span class="line">  argaddr(<span class="number">1</span>, &amp;p);</span><br><span class="line">  argint(<span class="number">2</span>, &amp;n);</span><br><span class="line">  <span class="keyword">if</span>(argfd(<span class="number">0</span>, <span class="number">0</span>, &amp;f) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> filewrite(f, p, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>5.<strong>è·å–æ–‡ä»¶å®ä¾‹</strong>ï¼šæ ¹æ®æ–‡ä»¶æè¿°ç¬¦è·å–å¯¹åº”æ–‡ä»¶å®ä¾‹</p></blockquote><p>â€‹ åœ¨å‰æ–‡ä¹Ÿæåˆ°äº†ï¼Œé€šè¿‡<code>argint</code>è·å–ç”¨æˆ·ä¼ é€’çš„fdï¼Œå°†fdä½œä¸ºå½“å‰è¿›ç¨‹ç»“æ„çš„<code>ofile</code>å­—æ®µçš„ç´¢å¼•ä¾¿èƒ½å¤Ÿå¾—åˆ°<strong>æ–‡ä»¶å®ä¾‹</strong>ï¼Œè¿™æ ·sys_writeå‡½æ•°å°±èƒ½å¤Ÿè·å¾—<strong>æ–‡ä»¶å®ä¾‹</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">----sysfile.c</span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">argfd</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> *pfd, <span class="keyword">struct</span> file **pf)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> fd;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span>;</span></span><br><span class="line"></span><br><span class="line">  argint(n, &amp;fd);</span><br><span class="line">  <span class="keyword">if</span>(fd &lt; <span class="number">0</span> || fd &gt;= NOFILE || (f=myproc()-&gt;ofile[fd]) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span>(pfd)</span><br><span class="line">    *pfd = fd;</span><br><span class="line">  <span class="keyword">if</span>(pf)</span><br><span class="line">    *pf = f;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>6.<strong>ä¿®æ”¹æ–‡ä»¶èµ„æº</strong>ï¼šé€šè¿‡æ–‡ä»¶å®ä¾‹çš„inodeå­—æ®µï¼Œè®¿é—®å¹¶ä¿®æ”¹æ–‡ä»¶èµ„æºã€‚</p></blockquote><p>â€‹ å¦‚ä¸‹è¿°ä»£ç æ‰€ç¤ºï¼Œè¿™é‡Œæˆ‘ä»¬å¿½ç•¥æ‰è®¾å¤‡å’Œç®¡é“ç­‰æ–‡ä»¶ç±»å‹ï¼Œåªå…³æ³¨inodeæ–‡ä»¶æ“ä½œã€‚åœ¨ä»£ç ä¸­ï¼Œ<code>filewrite</code>å‡½æ•°è°ƒç”¨äº†<code>writei</code>å‡½æ•°ï¼Œæ³¨æ„åˆ°writeiä¸­å°†æ–‡ä»¶å®ä¾‹çš„inodeå­—æ®µä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’ï¼Œä¹Ÿå°±è¯´æ˜<code>writei</code>å‡½æ•°æ˜¯æ ¹æ®<code>inode</code>å¯¹æ–‡ä»¶èµ„æºçš„æè¿°ï¼Œå¯¹æ–‡ä»¶èµ„æºè¿›è¡Œä¿®æ”¹çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">filewrite</span><span class="params">(<span class="keyword">struct</span> file *f, uint64 addr, <span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">  ....<span class="comment">//other file type</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(f-&gt;type == FD_INODE)&#123;</span><br><span class="line">    <span class="type">int</span> max = ((MAXOPBLOCKS<span class="number">-1</span><span class="number">-1</span><span class="number">-2</span>) / <span class="number">2</span>) * BSIZE;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; n)&#123;</span><br><span class="line">      <span class="type">int</span> n1 = n - i;</span><br><span class="line">      <span class="keyword">if</span>(n1 &gt; max)</span><br><span class="line">        n1 = max;</span><br><span class="line"></span><br><span class="line">      begin_op();</span><br><span class="line">      ilock(f-&gt;ip);</span><br><span class="line">      <span class="keyword">if</span> ((r = writei(f-&gt;ip, <span class="number">1</span>, addr + i, f-&gt;off, n1)) &gt; <span class="number">0</span>)</span><br><span class="line">        f-&gt;off += r;</span><br><span class="line">      iunlock(f-&gt;ip);</span><br><span class="line">      end_op();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(r != n1)&#123;</span><br><span class="line">        <span class="comment">// error from writei</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      i += r;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = (i == n ? n : <span class="number">-1</span>);</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>â€‹ æ–‡ä»¶ç³»ç»Ÿç®—æ˜¯æ“ä½œç³»ç»Ÿä¸­ä»£ç é‡æ¯”è¾ƒå¤§çš„ä¸€ä¸ªéƒ¨åˆ†ï¼Œåœ¨å­¦ä¹ ä¸Šä¹Ÿéœ€è¦é…åˆä»£ç æ¥ç†è§£ã€‚ç”±äºæ–‡ä»¶ç³»ç»Ÿçš„ä½“é‡æ¯”è¾ƒåºå¤§ï¼Œåœ¨å­¦ä¹ ä¸Šä¹Ÿæ¯”è¾ƒå›°éš¾ã€‚åœ¨xv6ä¸­å°†æ–‡ä»¶ç³»ç»ŸæŠ½è±¡æˆäº†7ä¸ªå±‚é¢ï¼Œé€šè¿‡æ¯ä¸€å±‚æ‰§è¡Œä¸åŒçš„åŠŸèƒ½ï¼Œåœ¨é€šè¿‡æ“ä½œç³»ç»Ÿçš„åè°ƒï¼Œç”±ç¹è‡³ç®€ä¾¿èƒ½å¤Ÿæ›´å¥½çš„å»ç†è§£æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>â€‹ åœ¨æœ¬ç« çš„å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œæ¯”è¾ƒéš¾ä»¥ç†è§£çš„å°±æ˜¯Buffer cacheã€Loggingã€Inodeä¸‰ä¸ªå±‚é¢ã€‚å…¶ä»–çš„ä»£ç é‡ä¹Ÿç›¸å¯¹æ¯”è¾ƒå°‘ï¼Œåœ¨æ­¤æ€»ç»“ä¸€ä¸‹æ¯ä¸€ä¸ªå±‚é¢çš„å†…å®¹ï¼š</p><ol><li><strong>Disk layer</strong>ï¼šå¯¹ç£ç›˜æ•°æ®èµ„æºæŒ‰åŠŸèƒ½è¿›è¡ŒèŒƒå›´åˆ’åˆ†ï¼Œæœ‰bootã€superã€logã€inodeã€bitmapã€dataç­‰ç±»å‹çš„ç£ç›˜å—ï¼Œç£ç›˜çš„ä¸¤ä¸ªæ‰‡åŒºç®—ä½œä¸€ä¸ªå—ã€‚</li><li><strong>Buffer layer</strong>ï¼šå°†å†…å­˜çš„ä¸€éƒ¨åˆ†ä½œä¸ºç£ç›˜å—çš„ç¼“å­˜åŒºï¼ŒåŠ é€ŸCPUå¯¹ç£ç›˜æ•°æ®çš„ä¿®æ”¹ã€‚åœ¨è¯¥å±‚æ¶‰åŠåˆ°äº†åŒé“¾è¡¨ä¸LRUçš„æ“ä½œï¼Œè™½ç„¶ç®€å•ï¼Œä½†è¿˜æ˜¯æ¯”è¾ƒå€¼å¾—å­¦ä¹ çš„ã€‚</li><li><strong>Logging layer</strong>ï¼šæä¾›æ•°æ®åº“ä¸­çš„äº‹åŠ¡ä¸æ—¥å¿—æ¦‚å¿µï¼Œåœ¨xv6ä¸­å®ç°logï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢crashé—®é¢˜ï¼Œä»¥å®ç°ä¿®æ”¹ç£ç›˜æ•°æ®çš„åŸå­æ€§(æ•°æ®åº“çš„æ¦‚å¿µ)ã€‚</li><li><strong>Inode layer</strong>ï¼šInodeæ˜¯æè¿°<strong>æ–‡ä»¶</strong>çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œé€šè¿‡inodeå¯ä»¥è·å¾—æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ï¼Œåœ¨Inodeå±‚æ¯”è¾ƒéœ€è¦ç†è§£çš„å°±æ˜¯æ–‡ä»¶æŒ‡é’ˆ(ç”¨äºå®šä½æ–‡ä»¶ç£ç›˜çš„æ•°æ®å—)ã€å†…å­˜inodeä¸ç£ç›˜inodeçš„åŒºåˆ«ã€ä»¥åŠå†…å­˜inodeçš„æ“ä½œã€‚</li><li><strong>Directory layer</strong>ï¼šé€šè¿‡ç›®å½•çš„æ¦‚å¿µï¼Œå°†æ–‡ä»¶çš„å­˜å‚¨è®¾è®¡æˆäº†åˆ†çº§æ ‘çŠ¶çš„ç»“æ„ã€‚</li><li><strong>Pathname layer</strong>ï¼šå°†ä¸€ä¸ªæ–‡ä»¶è·¯å¾„å(å¦‚a/b/c)é€šè¿‡è§£ææ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶(c)inodeï¼Œå¯¹æ–‡ä»¶è¿›è¡Œæ“ä½œã€‚</li><li><strong>File descriptor layer</strong>ï¼šå°†Unixå¤§éƒ¨åˆ†èµ„æºä¸€è‡´åŒ–ï¼ŒæŠ½è±¡åŒ–ä¸º<strong>æ–‡ä»¶</strong>å½¢å¼(<code>struct file</code>)ã€‚æä¾›ç»™ç”¨æˆ·è¿›ç¨‹çš„ä¸€ä¸ªæ–‡ä»¶å®ä¾‹ï¼Œé€šè¿‡æ–‡ä»¶è·¯å¾„åå¹¶èƒ½å¤Ÿè·å¾—æ–‡ä»¶èµ„æºå¥æŸ„ï¼Œç”¨æˆ·è¿›ç¨‹å¯ä»¥é€šè¿‡è¯¥å¥æŸ„è®¿é—®æŒ‡å®šçš„æ–‡ä»¶è¿›è¡Œæ“ä½œã€‚</li></ol><p>ä»¥ä¸Šä¾¿æ˜¯xv6æ–‡ä»¶ç³»ç»Ÿçš„æ‰€æœ‰çŸ¥è¯†ç‚¹äº†ï¼Œå»ºè®®åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­é…åˆæºç è¿›è¡Œç†è§£ã€‚</p></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>xv6ï¼šæ–‡ä»¶ç³»ç»Ÿ</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="http://www.ember-l.top/2023/09/25/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Chapter%208%EF%BC%9A%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">http://www.ember-l.top/2023/09/25/æ“ä½œç³»ç»Ÿ/Chapter 8ï¼šæ–‡ä»¶ç³»ç»Ÿ/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>EmberğŸ</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2023-09-25</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2023-09-25</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">æ“ä½œç³»ç»Ÿ</a></div><div class="post_share"><div class="social-share" data-image="https://ember-img.oss-cn-chengdu.aliyuncs.com/layers.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css" media="print" onload='this.media="all"'><script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js" defer></script></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload='this.media="all"'><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">æŠ•å–‚ç¡¬å¸</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/wechat.jpg" alt="wechat"></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/alipay.jpg" alt="alipay"></a><div class="post-qr-code-desc">alipay</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2023/07/26/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab10%EF%BC%9Ammap/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/image-20230726141038789.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">Mit6.S081:lab mmap</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/2023/03/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Chapter%202%EF%BC%9A%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%BB%84%E6%88%90/" title="xv6ï¼šæ“ä½œç³»ç»Ÿç»„æˆ"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img38.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-14</div><div class="title">xv6ï¼šæ“ä½œç³»ç»Ÿç»„æˆ</div></div></a></div><div><a href="/2023/03/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Chapter%201%EF%BC%9A%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3/" title="xv6ï¼šæ“ä½œç³»ç»Ÿæ¥å£"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/202301251415483.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-14</div><div class="title">xv6ï¼šæ“ä½œç³»ç»Ÿæ¥å£</div></div></a></div><div><a href="/2023/03/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Chapter%203%EF%BC%9A%E9%A1%B5%E8%A1%A8/" title="xv6ï¼šé¡µè¡¨"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img30.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-14</div><div class="title">xv6ï¼šé¡µè¡¨</div></div></a></div><div><a href="/2023/06/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Chapter%205%EF%BC%9A%E4%B8%AD%E6%96%AD%E4%B8%8E%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" title="xv6ï¼šä¸­æ–­ä¸è®¾å¤‡é©±åŠ¨"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/202301251416606.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-14</div><div class="title">xv6ï¼šä¸­æ–­ä¸è®¾å¤‡é©±åŠ¨</div></div></a></div><div><a href="/2023/05/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Chapter%204%EF%BC%9A%E9%99%B7%E9%98%B1%20trap/" title="xv6ï¼štrapæœºåˆ¶"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img41.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-14</div><div class="title">xv6ï¼štrapæœºåˆ¶</div></div></a></div><div><a href="/2023/03/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab1%EF%BC%9Autilities/" title="Mit6.S081:lab utilities"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img25.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-14</div><div class="title">Mit6.S081:lab utilities</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="author_top is-center"><div class="card-info-avatar"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/avatar.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-status-box"><div class="author-status"><g-emoji class="g-emoji" alias="palm_tree" fallback-src="https://lskypro.acozycotage.net/LightPicture/2022/12/fe1dc0402e623096.jpg">ğŸŸ</g-emoji><span>è®¤çœŸæ‘¸é±¼ä¸­</span></div></div></div><div class="author-info__name">EmberğŸ</div><div class="author-info__description">BugMaker ğŸ’¦ğŸ’¦ğŸ’¦</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ember-l"><i></i><span>Follow meğŸš€</span></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="/assets/qq.jpg" target="_blank" title="QQ"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-QQ"></use></svg></a><a class="social-icon faa-parent animated-hover" href="/assets/wx.jpg" target="_blank" title="å¾®ä¿¡"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-weixin"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://github.com/ember-l" target="_blank" title="github"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-github1"></use></svg></a><a class="social-icon faa-parent animated-hover" href="mailto:2508856440@qq.com" target="_blank" title="é‚®ç®±"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-youxiang"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://www.zhihu.com/people/low-45-75" target="_blank" title="çŸ¥ä¹"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shejiaotubiao-10"></use></svg></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><a class="faa-parent animated-hover"><svg class="faa-tada icon" style="height:27px;width:27px;fill:currentColor;position:relative;top:3px" aria-hidden="true"><use xlink:href="#icon-fengche"></use></svg></a><span>å…¬å‘Š</span></div><div class="announcement_content"><center><b>--- ä¸»åŸŸå ---<br><a href="https://www.ember-l.top" title="æ­¤çº¿è·¯éƒ¨ç½²äºVercel" class="anno_content"><font color="#cc7227">ember-l.top</font></a></b></center></div><div id="welcome-info"></div></div><div class="card-widget tzy-right-widget" id="card-wechat"><div id="flip-wrapper"><div id="flip-content"><div class="face"></div><div class="back face"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><a class="faa-parent animated-hover"><svg class="faa-tada icon" style="height:27px;width:27px;fill:currentColor;position:relative;top:3px" aria-hidden="true"><use xlink:href="#icon-mulu"></use></svg></a><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#File-system"><span class="toc-text">File system</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xv6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-text">xv6æ–‡ä»¶ç³»ç»Ÿ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Disk-Layer"><span class="toc-text">Disk Layer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E7%A1%AC%E4%BB%B6%E4%BA%A4%E4%BA%92"><span class="toc-text">ç£ç›˜ç¡¬ä»¶äº¤äº’</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E5%B8%83%E5%B1%80"><span class="toc-text">ç£ç›˜å¸ƒå±€</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Buffer-cache-layer"><span class="toc-text">Buffer cache layer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-text">ä»£ç </span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Logging-layer"><span class="toc-text">Logging layer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-text">é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-2"><span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%EF%BC%9Alogging"><span class="toc-text">ä»£ç ï¼šlogging</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Inode-layer"><span class="toc-text">Inode layer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-3"><span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%EF%BC%9ABlock-allocator"><span class="toc-text">ä»£ç ï¼šBlock allocator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%EF%BC%9AInode%E5%88%86%E9%85%8D"><span class="toc-text">ä»£ç ï¼šInodeåˆ†é…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%EF%BC%9AInode%E9%87%8A%E6%94%BE"><span class="toc-text">ä»£ç ï¼šInodeé‡Šæ”¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%9D%97%E5%88%86%E9%85%8D"><span class="toc-text">ä»£ç ï¼šæ•°æ®å—åˆ†é…</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Directory-layer"><span class="toc-text">Directory layer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-4"><span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%EF%BC%9Adirectory-layer"><span class="toc-text">ä»£ç ï¼šdirectory layer</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pathname-layer"><span class="toc-text">Pathname layer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%EF%BC%9APath-names"><span class="toc-text">ä»£ç ï¼šPath names</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#File-descriptor-layer"><span class="toc-text">File descriptor layer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-5"><span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%EF%BC%9A%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-text">ä»£ç ï¼šæ–‡ä»¶ç»“æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%EF%BC%9A%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6fd"><span class="toc-text">ä»£ç ï¼šåˆ›å»ºæ–‡ä»¶æè¿°ç¬¦fd</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%EF%BC%9A%E9%80%9A%E8%BF%87fd%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E8%B5%84%E6%BA%90"><span class="toc-text">ä»£ç ï¼šé€šè¿‡fdä¿®æ”¹æ–‡ä»¶èµ„æº</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">æ€»ç»“</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/09/25/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Chapter%208%EF%BC%9A%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" title="xv6ï¼šæ–‡ä»¶ç³»ç»Ÿ"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/layers.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="xv6ï¼šæ–‡ä»¶ç³»ç»Ÿ"></a><div class="content"><a class="title" href="/2023/09/25/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Chapter%208%EF%BC%9A%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" title="xv6ï¼šæ–‡ä»¶ç³»ç»Ÿ">xv6ï¼šæ–‡ä»¶ç³»ç»Ÿ</a><time datetime="2023-09-24T16:00:00.000Z" title="å‘è¡¨äº 2023-09-25 00:00:00">2023-09-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/26/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab10%EF%BC%9Ammap/" title="Mit6.S081:lab mmap"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/image-20230726141038789.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Mit6.S081:lab mmap"></a><div class="content"><a class="title" href="/2023/07/26/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab10%EF%BC%9Ammap/" title="Mit6.S081:lab mmap">Mit6.S081:lab mmap</a><time datetime="2023-07-25T16:00:00.000Z" title="å‘è¡¨äº 2023-07-26 00:00:00">2023-07-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/17/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab9%EF%BC%9Afs/" title="Mit6.S081:lab fs"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/2level_inode.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Mit6.S081:lab fs"></a><div class="content"><a class="title" href="/2023/07/17/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab9%EF%BC%9Afs/" title="Mit6.S081:lab fs">Mit6.S081:lab fs</a><time datetime="2023-07-16T16:00:00.000Z" title="å‘è¡¨äº 2023-07-17 00:00:00">2023-07-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/26/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab8%EF%BC%9Alocks/" title="Mit6.S081:lab locks"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img30.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Mit6.S081:lab locks"></a><div class="content"><a class="title" href="/2023/06/26/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab8%EF%BC%9Alocks/" title="Mit6.S081:lab locks">Mit6.S081:lab locks</a><time datetime="2023-06-25T16:00:00.000Z" title="å‘è¡¨äº 2023-06-26 00:00:00">2023-06-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/15/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab7%EF%BC%9Anet/" title="Mit6.S081:lab net"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img2.4.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Mit6.S081:lab net"></a><div class="content"><a class="title" href="/2023/06/15/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/lab/Lab7%EF%BC%9Anet/" title="Mit6.S081:lab net">Mit6.S081:lab net</a><time datetime="2023-06-14T16:00:00.000Z" title="å‘è¡¨äº 2023-06-15 00:00:00">2023-06-15</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 By EmberğŸ</div><div class="footer_custom_text"><a href="https://icp.gov.moe/?keyword=20232016" target="_blank">èŒICPå¤‡20232016å·</a><p>There is only one heroism in the world to see the world as it is and to love it</p><p><a target="_blank" href="https://hexo.io/"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="åšå®¢æ¡†æ¶ä¸ºHexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="ä¸»é¢˜é‡‡ç”¨butterfly"></a>&nbsp;<a target="_blank" href="https://www.jsdelivr.com/"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="æœ¬ç«™ä½¿ç”¨JsDelivrä¸ºé™æ€èµ„æºæä¾›CDNåŠ é€Ÿ"></a>&nbsp;<a target="_blank" href="https://vercel.com/"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="æœ¬ç«™é‡‡ç”¨åŒçº¿éƒ¨ç½²ï¼Œé»˜è®¤çº¿è·¯æ‰˜ç®¡äºVercel"></a>&nbsp;<a target="_blank" href="https://vercel.com/"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Hosted-Coding-0cedbe?style=flat&logo=Codio" title="æœ¬ç«™é‡‡ç”¨åŒçº¿éƒ¨ç½²ï¼Œè”é€šçº¿è·¯æ‰˜ç®¡äºCoding"></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="æœ¬ç«™é¡¹ç›®ç”±Gtihubæ‰˜ç®¡"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight,500)"><i class="fas fa-arrow-down"></i></button></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><script src="https://cdn.staticfile.org/algoliasearch/4.14.3/algoliasearch-lite.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/4.49.0/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(()=>{const e=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo.ember-l.top/.netlify/functions/twikoo",region:"",onCommentLoaded:function(){btf.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)")),setTimeout((function(){let e=document.querySelectorAll(".tk-comments-container .tk-comment");if(e.length>0){let n='<div class="swiper-wrapper">';for(let t=0;t<e.length;t++){let o=e[t].getAttribute("id")||"",a=e[t].querySelector(".tk-nick")?.innerText||"",i=e[t].querySelector(".tk-nick")?.href||"",r=e[t].querySelector(".tk-avatar-img")?.src||"",l=e[t].querySelector(".tk-time")?.innerText||"",c=e[t].querySelector(".tk-extras .tk-extra:first-child span:last-child")?.innerText||"",s=e[t].querySelector(".tk-content>span:last-child")?.innerHTML||"";s=s.replace(/\n/g,""),s=s.replace(/<blockquote>.*?<\/blockquote>/gi,""),s=s.replace(/<pre.*?<\/pre>/gi,"[ä»£ç ]"),n+=`\n                <div class="swiper-slide">\n                  <div class="comment-barrage-item">\n                    <div class="barrage-info">\n                      <a class="barrage-title" title="è·³è½¬è‡³è¯„è®ºåŒº" href="#post-comment">çƒ­è¯„</a>\n                      <a href="${i?i+'" target="_blank" rel="noopener noreferrer" title="è®¿é—® '+a+'"':'javascript:void(0);"'}>\n                        <img class="barrage-avatar" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="${r}">\n                      </a>\n                      <span class="barrage-nick">${a}</span>\n                      <span class="barrage-city">${c}</span>\n                      <span class="barrage-time">${l}</span>\n                      <a class="barrage-close" onclick="eurkon.switchCommentBarrage()" title="éšè—çƒ­è¯„"><i class="fa-solid fa-xmark"></i></a>\n                    </div>\n                    <div class="barrage-content">\n                      <a title="è·³è½¬è‡³è¯¥è¯„è®º" href="#${o}">${s}</a>\n                    </div>\n                  </div>\n                </div>`}n+="</div>";let o=document.getElementById("comment-barrage")||document.createElement("div");o.id="comment-barrage",o.innerHTML=n,o.style.display="false"===window.localStorage.getItem("commentBarrageDisplay")?"none":"block",document.getElementById("post-comment").appendChild(o);var t=new Swiper("#comment-barrage",{direction:"vertical",loop:!0,mousewheel:!0,autoplay:{delay:3e3,disableOnInteraction:!0}});o.onmouseenter=function(){t.autoplay.stop()},o.onmouseleave=function(){t.autoplay.start()}}}),1e3)}},null)),GLOBAL_CONFIG_SITE.isPost&&(()=>{const e=document.getElementById("twikoo-count");e&&twikoo.getCommentsCount({envId:"https://twikoo.ember-l.top/.netlify/functions/twikoo",region:"",urls:[window.location.pathname],includeReply:!1}).then((function(t){e.innerText=t[0].count})).catch((function(e){console.error(e)}))})()},t=()=>{"object"!=typeof twikoo?getScript("https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js").then(e):setTimeout(e,0)};btf.loadComment(document.getElementById("twikoo-wrap"),t)})()</script></div><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script src="/js/share.js"></script><script src="/js/key.js"></script><script src="/js/barrage.js"></script><script defer src="/js/light.js"></script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer data-pjax src="/js/readPercent.js"></script><script async src="//at.alicdn.com/t/c/font_3864328_90xjkz8cfrn.js"></script><script async src="/js/fps.js"></script><script src="/js/nav.js" async></script><script src="/js/sun_moon.js" async></script><script src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async data-pjax src="/js/txmap.js"></script><script src="/js/charts.js" async></script><script defer data-pjax src="/js/beautify.js"></script><script src="/js/twikoo_beautify.js"></script><script charset="UTF-8" id="LA_COLLECT" src="https://sdk.51.la/js-sdk-pro.min.js"></script><script src="https://sdk.51.la/perf/js-sdk-perf.min.js" crossorigin="anonymous"></script><script>LA.init({id:"Jx18u1PbLX8sXMaz",ck:"Jx18u1PbLX8sXMaz"})</script><script>(new LingQue.Monitor).init({id:"Jx18u1PbLX8sXMaz",sendSuspicious:!0})</script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/fireworks.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors=["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(window.tocScrollFn&&window.removeEventListener("scroll",window.tocScrollFn),window.scrollCollect&&window.removeEventListener("scroll",scrollCollect),document.getElementById("rightside").style.cssText="opacity: ''; transform: ''",window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode"),"object"==typeof disqusjs&&disqusjs.destroy()})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach((e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)})),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll()})),document.addEventListener("pjax:error",(e=>{404===e.request.status&&pjax.loadUrl("/404.html")}))</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script data-pjax>if(document.getElementById("recent-posts")&&"/"===location.pathname){var parent=document.getElementById("recent-posts"),child='<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="http://www.ember-l.top/categories/MIT6-824/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“š é˜¿æ¢¨ã®åˆ†å¸ƒå¼ç³»ç»Ÿå­¦ä¹  (7)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://www.ember-l.top/categories/C/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ® é˜¿æ¢¨ã®C++å­¦ä¹  (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://www.ember-l.top/categories/æ“ä½œç³»ç»Ÿ/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ± é˜¿æ¢¨ã®æ“ä½œç³»ç»Ÿå­¦ä¹  (16)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://www.ember-l.top/categories/Tool/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“’ é˜¿æ¢¨ã®å¸¸ç”¨å·¥å…· (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="http://www.ember-l.top/categories" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';console.log("å·²æŒ‚è½½magnet"),parent.insertAdjacentHTML("afterbegin",child)}</script><style>#catalog_magnet{flex-wrap:wrap;display:flex;width:100%;justify-content:space-between;padding:10px 10px 0 10px;align-content:flex-start}.magnet_item{flex-basis:calc(50% - 5px);background:#f2f2f2;margin-bottom:10px;border-radius:8px;transition:all .2s ease-in-out}.magnet_item:hover{background:#fed558}.magnet_link_more{color:#555}.magnet_link{color:#000}.magnet_link:hover{color:#fff}@media screen and (max-width:600px){.magnet_item{flex-basis:100%}}.magnet_link_context{display:flex;padding:10px;font-size:16px;transition:all .2s ease-in-out}.magnet_link_context:hover{padding:10px 20px}</style><style></style><script data-pjax>function butterfly_clock_anzhiyu_injector_config(){var a=document.getElementsByClassName("sticky_layout")[0];console.log("å·²æŒ‚è½½butterfly_clock_anzhiyu"),a&&a.insertAdjacentHTML("afterbegin",'<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>')}for(var elist="null".split(","),cpage=location.pathname,epage="/",qweather_key="b16a1fa0e63c46a4b8f28abfb06ae3fe",gaud_map_key="e2b04289e870b005374ee030148d64fd&s=rsv3",baidu_ak_key="undefined",flag=0,clock_rectangle="113.34532,23.15624",clock_default_rectangle_enable="false",i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_clock_anzhiyu_injector_config()</script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax>function butterfly_swiper_injector_config(){var a=document.getElementById("recent-posts");console.log("å·²æŒ‚è½½butterfly_swiper"),a.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/01/20/åˆ†å¸ƒå¼ç³»ç»Ÿ/FaRMè®ºæ–‡ç¬”è®°/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img30.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-01-20</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/01/20/åˆ†å¸ƒå¼ç³»ç»Ÿ/FaRMè®ºæ–‡ç¬”è®°/&quot;);" href="javascript:void(0);" alt="">FaRM</a><div class="blog-slider__text">No compromises:distributed transactions with consistency, availability, and performance</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/01/20/åˆ†å¸ƒå¼ç³»ç»Ÿ/FaRMè®ºæ–‡ç¬”è®°/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/07/17/æ“ä½œç³»ç»Ÿ/lab/Lab9ï¼šfs/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/2level_inode.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-07-17</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/07/17/æ“ä½œç³»ç»Ÿ/lab/Lab9ï¼šfs/&quot;);" href="javascript:void(0);" alt="">Mit6.S081:lab fs</a><div class="blog-slider__text">MIT6.S081ï¼šlab9</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/07/17/æ“ä½œç³»ç»Ÿ/lab/Lab9ï¼šfs/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/03/14/åˆ†å¸ƒå¼ç³»ç»Ÿ/å®éªŒ/Sharded KV Service/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img32.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-14</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/03/14/åˆ†å¸ƒå¼ç³»ç»Ÿ/å®éªŒ/Sharded KV Service/&quot;);" href="javascript:void(0);" alt="">Lab4:Shards KV Service(æœªå®Œå–„)</a><div class="blog-slider__text">MIT6.824 lab4å®ç°# æè¿°</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/03/14/åˆ†å¸ƒå¼ç³»ç»Ÿ/å®éªŒ/Sharded KV Service/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/07/26/æ“ä½œç³»ç»Ÿ/lab/Lab10ï¼šmmap/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/image-20230726141038789.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-07-26</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/07/26/æ“ä½œç³»ç»Ÿ/lab/Lab10ï¼šmmap/&quot;);" href="javascript:void(0);" alt="">Mit6.S081:lab mmap</a><div class="blog-slider__text">MIT6.S081ï¼šlab10</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/07/26/æ“ä½œç³»ç»Ÿ/lab/Lab10ï¼šmmap/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/01/13/åˆ†å¸ƒå¼ç³»ç»Ÿ/å®éªŒ/KVRaft/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img21.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-01-13</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/01/13/åˆ†å¸ƒå¼ç³»ç»Ÿ/å®éªŒ/KVRaft/&quot;);" href="javascript:void(0);" alt="">Lab:KVRaft</a><div class="blog-slider__text">MIT6.824 lab3å®ç°# æè¿°</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/01/13/åˆ†å¸ƒå¼ç³»ç»Ÿ/å®éªŒ/KVRaft/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/05/14/æ“ä½œç³»ç»Ÿ/Chapter 4ï¼šé™·é˜± trap/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img41.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-14</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/05/14/æ“ä½œç³»ç»Ÿ/Chapter 4ï¼šé™·é˜± trap/&quot;);" href="javascript:void(0);" alt="">xv6ï¼štrapæœºåˆ¶</a><div class="blog-slider__text">MITï¼šxv6 chapter4</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/05/14/æ“ä½œç³»ç»Ÿ/Chapter 4ï¼šé™·é˜± trap/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/03/14/æ“ä½œç³»ç»Ÿ/Chapter 3ï¼šé¡µè¡¨/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img30.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-14</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/03/14/æ“ä½œç³»ç»Ÿ/Chapter 3ï¼šé¡µè¡¨/&quot;);" href="javascript:void(0);" alt="">xv6ï¼šé¡µè¡¨</a><div class="blog-slider__text">MITï¼šxv6 chapter3</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/03/14/æ“ä½œç³»ç»Ÿ/Chapter 3ï¼šé¡µè¡¨/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/03/14/åˆ†å¸ƒå¼ç³»ç»Ÿ/å®éªŒ/Debug/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://ember-img.oss-cn-chengdu.aliyuncs.com/img21.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-14</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/03/14/åˆ†å¸ƒå¼ç³»ç»Ÿ/å®éªŒ/Debug/&quot;);" href="javascript:void(0);" alt="">Debugging by Pretty Printing</a><div class="blog-slider__text">Lab2ï¼šRaftç¾åŒ–è°ƒè¯•å·¥å…·é…ç½®æ–¹æ³•</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/03/14/åˆ†å¸ƒå¼ç³»ç»Ÿ/å®éªŒ/Debug/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>')}for(var elist="undefined".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_swiper_injector_config()</script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><div class="js-pjax"><script async>for(var arr=document.getElementsByClassName("recent-post-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration","1s"),arr[i].setAttribute("data-wow-delay","700ms"),arr[i].setAttribute("data-wow-offset","100"),arr[i].setAttribute("data-wow-iteration","1")</script><script async>for(var arr=document.getElementsByClassName("card-widget"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration",""),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script></body></html>